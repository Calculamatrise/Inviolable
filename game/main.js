(()=>{"use strict";const e=class{#e=null;#t=-1;defaultMaxListeners=10;setMaxListeners(e){if("number"!=typeof e||0>e)throw TypeError("n must be a positive number");return this.#t=e,this}emit(e){var t,s;if(this.#e&&"error"===e&&(!this.#e.error||"object"==typeof this.#e.error&&null!==this.#e.error)){if((t=arguments[1])instanceof Error)throw t;throw TypeError('Unspecified "error" event.')}if(void 0===(s=this.#e&&this.#e[e]))return!1;if("function"==typeof s)s.apply(this,Array.prototype.slice.call(arguments,1));else if("object"==typeof s&&null!==s)for(let e of s.values())e.apply(this,Array.prototype.slice.call(arguments,1));return!0}addListener(e,t){if("function"!=typeof t)throw TypeError("listener must be a function");if(this.#e||(this.#e={}),this.#e.newListener&&this.emit("newListener",e,"function"==typeof t.listener?t.listener:t),this.#e[e]?"object"==typeof this.#e[e]&&null!==this.#e[e]?this.#e[e].add(t):this.#e[e]=new Set([this.#e[e],t]):this.#e[e]=t,"object"==this.#e[e]&&null!==this.#e[e]&&!this.#e[e].warned){var s=this.#t<0?this.defaultMaxListeners:this.#t;s&&s>0&&this.#e[e].size>s&&(this.#e[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this.#e[e].size))}return this}on=this.addListener;once(e,t){if("function"!=typeof t)throw TypeError("listener must be a function");var s=(...i)=>{this.removeListener(e,s),t.apply(this,i)};return s.listener=t,this.on(e,s)}removeListener(e,t){if("function"!=typeof t)throw TypeError("listener must be a function");if(!this.#e||!this.#e[e])return this;var s=this.#e[e];if(s===t||"function"==typeof s.listener&&s.listener===t)delete this.#e[e],this.#e.removeListener&&this.emit("removeListener",e,t);else if("object"==typeof s&&null!==s)for(let i of s.values())if(i===t||"function"==typeof i.listener&&i.listener===t){s.delete(i),s.size<2&&(0===s.size?delete this.#e[e]:this.#e[e]=this.#e[e].values().next().value),this.#e.removeListener&&this.emit("removeListener",e,t);break}return Object.keys(this.#e).length<1&&(this.#e=null),this}removeAllListeners(e){if(!this.#e)return this;if(!this.#e.removeListener)return 0===arguments.length?this.#e=null:this.#e[e]&&delete this.#e[e],Object.keys(this.#e).length<1&&(this.#e=null),this;var t;if(0===arguments.length){for(t in this.#e)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener")}if("function"==typeof(t=this.#e[e]))this.removeListener(e,t);else for(let s of t.values())this.removeListener(e,s);return delete this.#e[e],Object.keys(this.#e).length<1&&(this.#e=null),this}listeners(e){return this.#e&&this.#e[e]?"function"==typeof this.#e[e]?[this.#e[e]]:Array.from(this.#e[e]):[]}listenerCount(e){return this.#e&&this.#e[e]?"function"==typeof this.#e[e]?1:this.#e[e].size:0}};let t=window.GameManager,s=Date.now();for(;!t;){t=window.GameManager,Date.now()-s>5e3&&console.warn("GameManager load timed out.");break}t&&(window.ModManager||=new class extends e{#s=!1;#i=new Map;#a=null;constructor(e){super(),e.thirdParty=this,e.on("stateChange",(t=>{!1===t.preloading&&!1===this.#s&&(this.#s=(this.emit("ready",e.game),!0)),this.#s&&this.emit("stateChange",t)})),this.#a=e,window.hasOwnProperty("navigation")&&navigation.addEventListener("navigate",(()=>this.#s=!1),{passive:!0})}hook(e,{name:t,overwrite:s}={}){return t??=e.name??e._name,!s&&this.#i.has(t)||(this.#i.set(t,e),this.hasOwnProperty(t)||(this[t]=e)),this.#i.get(t)}includes(e){return this.#i.has(e)}}(t));class a extends HTMLElement{#r=null;options=[];constructor(){super(),this.constructor.contextMenu=this,this.addEventListener("contextmenu",(e=>e.preventDefault())),this.addEventListener("click",this.remove,{once:!0,passive:!0}),this.addEventListener("mousewheel",(e=>e.preventDefault())),Object.defineProperty(this,"_removeListener",{value:this.remove.bind(this),writable:!0}),window.addEventListener("blur",this._removeListener,{once:!0,passive:!0}),window.addEventListener("scroll",this._removeListener,{once:!0,passive:!0}),window.addEventListener("pointerdown",this.#r=e=>{if(null!==e.target.closest("context-menu"))return window.addEventListener("pointerdown",this.#r,{passive:!0,once:!0});this.remove()},{passive:!0,once:!0}),window.navigation&&navigation.addEventListener("navigatesuccess",this._removeListener,{once:!0,passive:!0})}addOption(e){let t="string"==typeof e.type&&e.type.toLowerCase()||"button",s=this.appendChild(document.createElement(t));if(this.options.push(e),/^(b|h)r$/i.test(t))return s;for(let t in e)if(void 0!==e[t])if("function"!=typeof e[t]||void 0===s["on"+t])switch(t){case"disabled":s[t]=e[t];break;case"styles":if("function"!=typeof e[t][Symbol.iterator])continue;s.classList.add(...Array.from(e[t].values()))}else s.addEventListener(t,e[t],{passive:!/\.preventDefault\(\)/g.test(e[t].toString())});return s.innerText=e.name,"function"==typeof e.callback&&e.callback(s),s}clear(){this.options.splice(0),this.replaceChildren()}setPosition({clientX:e,clientY:t,pageX:s,pageY:i}={}){return e+this.clientWidth>window.innerWidth&&(s-=this.clientWidth),t+this.clientHeight>window.innerHeight&&(i-=this.clientHeight),this.style.setProperty("left",s+"px"),this.style.setProperty("top",i+"px"),{pageX:s,pageY:i}}remove(e){null!==this.constructor.contextMenu&&(window.removeEventListener("blur",this._removeListener),window.removeEventListener("scroll",this._removeListener),window.removeEventListener("pointerdown",this.#r),window.navigation&&navigation.removeEventListener("navigatesuccess",this._removeListener),super.remove(),this.constructor.contextMenu=null,this.dispatchEvent(new CustomEvent("close",{detail:e&&e.target.innerText&&e.target.innerText.toLowerCase()})))}static contextMenu=null;static create(e,t){this.contextMenu?this.contextMenu.clear():this.contextMenu=new this;for(let t of e)this.contextMenu.addOption(t);return document.body.appendChild(this.contextMenu),this.contextMenu.setPosition(t),this.contextMenu}}function r(e,t,s,i,a,r){let o=[],n=e,h=t,l=(i-t)/(s-e),c=s>e?1:-1,d=i>t?1:-1,p=0;o.push(e,t),!0===r&&(e%a==0&&o.push(e-.5,t),t%a==0&&o.push(e,t-.5));do{let p=Math.floor(n/a)==Math.floor(s/a),u=Math.floor(h/a)==Math.floor(i/a);if(p&&u)break;let m=0,g=0;m=Math.round(Math.floor(n/a+c)*a),0>c&&(m=Math.round(Math.ceil((n+1)/a+c)*a)-1),g=Math.round(t+(m-e)*l);let y=0,f=0;f=Math.round(Math.floor(h/a+d)*a),0>d&&(f=Math.round(Math.ceil((h+1)/a+d)*a)-1),y=Math.round(e+(f-t)/l),Math.pow(m-e,2)+Math.pow(g-t,2)<Math.pow(y-e,2)+Math.pow(f-t,2)?(n=m,h=g,o.push(m,g),!0===r&&(m%a==0&&o.push(m-1,g),g%a==0&&o.push(m,g-1))):(n=y,h=f,o.push(y,f),!0===r&&(y%a==0&&o.push(y-.5,f),f%a==0&&o.push(y,f-.5)))}while(p++<5e3);return o}customElements.define("context-menu",a),window.lite=new class{#o=null;currentTrackData=null;debug=!1;dialogs=new Map;nativeEvents=new Map;playlists=new Map;snapshots=new class extends Array{push(...e){return this.length>=parseInt(lite.storage.get("snapshots"))&&this.splice(0,this.length-parseInt(lite.storage.get("snapshots"))),super.push(...e)}};storage=new Map;styleSheet=new Proxy(new Map,{get:(...e)=>{let[t,s,i]=e,a=Reflect.get(...e);return"function"==typeof a?(...e)=>{switch(s){case"delete":a=a.apply(t,e),this._updateCustomStyleSheet(this.styleSheet.entries());break;case"set":let[s,r]=e;a.call(t,s,new Proxy(r,{set:(...e)=>{let t=Reflect.set(...e);return this._updateCustomStyleSheet(this.styleSheet.entries()),t}})),a=i,this._updateCustomStyleSheet(this.styleSheet.entries());break;default:a=a.apply(t,e)}return a}:a}});constructor(){new URLSearchParams(location.search).has("ajax")||(window.Application&&Application.events.subscribe("mainview.loaded",this._childLoad.bind(this)),window.ModManager&&(ModManager.hook(this,{name:"lite"}),ModManager.on("ready",this._load.bind(this)),ModManager.on("stateChange",this.refresh.bind(this))),this.#n(),addEventListener("message",(({data:e})=>{if(!e)return console.warn("data is missing");switch(e.action){case"setStorage":this.storage=new Map(Object.entries(e.storage)),this._childLoad();break;case"updateStorage":let t=new Map(this.storage);this.storage=new Map(Object.entries(e.storage));let s=new Map;for(const[e,i]of this.storage.entries())JSON.stringify(i)!=JSON.stringify(t.get(e))&&s.set(e,i);this._updateFromSettings(s)}}),{passive:!0}),Object.defineProperty(this,"currentTrackData",{enumerable:!1}),Object.defineProperty(this,"dialogs",{enumerable:!1}),Object.defineProperty(this,"nativeEvents",{enumerable:!1}))}get scene(){return GameManager.game&&GameManager.game.currentScene}#n(){this.#o=document.head.appendChild(document.createElement("style")),this.#o.setAttribute("id","frhd-lite-style")}_childLoad(){this.attachContextMenu(),location.pathname.match(/^\/notifications\/?/i)&&this.modifyCommentNotifications(),this.storage.get("accountManager")&&this.initAccountManager(),location.pathname.match(/^\/t\//i)&&GameSettings.track&&(Application.events.publish("game.prerollAdStopped"),this.cacheTrackData(),this.storage.get("dailyAchievementsDisplay")&&this.initAchievementsDisplay(),this.initBestDate(),this.initDownloadGhosts(),this.initGhostMetadata(),this.initReportTracks(),location.search.includes("c_id=")&&this.initJumpToComment(),Application.settings.user.u_id===GameSettings.track.u_id&&this.initDownloadTracks(),this.storage.get("featuredGhostsDisplay")&&this.initFeaturedGhosts(),this.initGhostPlayer(),this.storage.get("uploadGhosts")&&this.initUploadGhosts()),location.pathname.match(/^\/u\//i)&&(Application.router.current_view.username===Application.settings.user.u_name?(this.storage.get("experiments").playlists&&this.initPlayLater(),this.initUserTrackAnalytics()):this.initFriendsLastPlayed(),Application.settings.user.moderator&&(this.initUserModeration(),this.initUserTrackModeration())),location.pathname.match(/^\/account\/settings\/?/i)&&this.initRequestTrackData()}_load(e){e.on("cameraFocus",(e=>{this.replayGui&&(this.replayGui.style.setProperty("display",0!==this.scene.camera.focusIndex?"block":"none"),0!==this.scene.camera.focusIndex&&(e=this.scene.races.find((({user:t})=>t.u_id==e._user.u_id)))&&(this.replayGui.progress.max=e.race.run_ticks??100))})),e.on("draw",this.draw.bind(this)),e.on("trackChallengeUpdate",(e=>{let t=this.fetchChallengeLeaderboard({createIfNotExists:!0});t.replaceChildren(...e.map(((e,s)=>{let i=this.constructor.fetchRaceRow(e,{parent:t,placement:1+s});i.querySelector(".num").innerText=1+s+".";let a=i.querySelector(".track-leaderboard-action");return a.querySelector("span.btn.new-button.button-type-1")||a.appendChild(this.constructor.createElement("span.btn.new-button.button-type-1",{innerText:"X",title:"Remove Race",style:{aspectRatio:1,backgroundImage:"linear-gradient(#ee5f5b,#c43c35)",fontSize:"12px",height:"24px",lineHeight:"2em",marginRight:"6px",textAlign:"center"},onclick(){let e=this.closest(".track-leaderboard-race-row");lite.scene.removeRaces([e.dataset.u_id])}})),i}))),t.children.length<1&&t.closest(".track-leaderboard").style.setProperty("display","none");let s=e.filter((({race:e})=>e.code.tas));s.length>0&&this.updateTASLeaderboard(s)})),e.on("trackRaceCreate",(e=>{GameSettings.raceData||=[],GameSettings.raceData.push(e),GameSettings.raceUids.push(e.user.u_id)})),e.on("trackRaceDelete",(e=>{GameSettings.raceData&&(GameSettings.raceData.splice(GameSettings.raceData.indexOf(e),1),GameSettings.raceData.length<1&&(GameSettings.raceData=!1)),GameSettings.raceUids.splice(GameSettings.raceUids.indexOf(e.user.u_id),1)})),this.snapshots.splice(0,this.snapshots.length),this._updateFromSettings(this.storage)}_updateCustomStyleSheet(e){const t=Array.from(e).filter((([e,t])=>Object.values(t).length));let s="";for(let[e,i]of t){i=Object.entries(i);for(let e of i)e[0]=e[0].replace(/([A-Z])/g,(e=>"-"+e.toLowerCase()));s+=e+"{"+i.map((e=>e.join(":"))).join(";")+"}"}this.#o.textContent=s}_updateFromSettings(e=this.storage){if(!this.scene)return;let t=!1,s=!1;for(const[i,a]of e.entries())switch(i){case"accountManager":case"dailyAchievementsDisplay":case"featuredGhosts":t=!0;break;case"experiments":for(const e in a)switch(e){case"brightness":this.styleSheet.set("#game-container",Object.assign({},this.styleSheet.get("#game-container"),{filter:"brightness("+a[e]/100+")"}));break;case"playlists":t=!0}break;case"keymap":this.scene.playerManager.firstPlayer._gamepad.setKeyMap("Editor"!==GameManager.scene?GameSettings.playHotkeys:GameSettings.editorHotkeys);break;case"theme":let e="#".padEnd(7,"midnight"==a?"1d2328":"darker"==a?"0":"dark"==a?"1b":"f");this.styleSheet.set("#game-container > canvas",Object.assign({},this.styleSheet.get("#game-container > canvas"),{backgroundColor:e})),this.styleSheet.set(".gameFocusOverlay",{backgroundColor:getComputedStyle(GameManager.game.canvas).backgroundColor.replace(/[,]/g,"").replace(/(?=\))/,"/90%"),color:"#".padEnd(7,"midnight"==a?"d":"dark"==a?"f":"dark"==a?"eb":"2d")}),this.scene.message.color="#".padEnd(7,/^(dark(er)?|midnight)$/i.test(a)?"c":"3"),this.scene.message.outline=e;let i="#".padEnd(7,/^(dark(er)?|midnight)$/i.test(a)?"6":"9");this.scene.score.best_time.color=i,this.scene.score.best_time_title.color=i;let r="#".padEnd(7,"midnight"==a?"d":/^dark(er)?$/i.test(a)?"f":"0");this.scene.score.goals.color=r,this.scene.score.time.color=r,this.scene.score.time_title.color=i,this.scene.hasOwnProperty("campaignScore")&&this.scene.campaignScore.container.children.forEach((e=>{e.children.forEach((e=>{e.color=r}))})),this.scene.hasOwnProperty("raceTimes")&&(this.scene.raceTimes.container.color=r,this.scene.raceTimes.raceList.forEach((e=>{e.children.forEach((e=>{e.color=r}))}))),GameSettings.physicsLineColor="#".padEnd(7,"midnight"==a?"c":"darker"==a?"f":"dark"==a?"fd":"0"),GameSettings.sceneryLineColor="#".padEnd(7,"midnight"==a?"5":"darker"==a?"121319":"dark"==a?"6":"a"),this.scene.toolHandler.options.gridMinorLineColor="#".padEnd(7,"midnight"==a?"20282e":"dark"==a?"25":"e"),this.scene.toolHandler.options.gridMajorLineColor="#".padEnd(7,"midnight"==a?"161b20":"dark"==a?"3e":"c"),this.scene.track.powerups.forEach((e=>e.outline=GameSettings.physicsLineColor));for(const e of this.scene.playerManager._players)e._baseVehicle.color=GameSettings.physicsLineColor,e._tempVehicle&&(e._tempVehicle.color=GameSettings.physicsLineColor);case"isometricGrid":s=!0}t&&this._childLoad(),s&&this.scene.redraw(),this.refresh()}attachContextMenu(){this._oncontextmenu||(Object.defineProperty(this,"_oncontextmenu",{value:async e=>{null===this.currentTrackData&&this.cacheTrackData();let t=e.target.closest(".track-leaderboard-race-row");if(null!==t){if(e.preventDefault(),e.target.closest(".name"))return void a.create(await this.buildUserContextMenu(t.dataset),e);const s=[{name:"Race",click:()=>Application.Helpers.AjaxHelper.post("track_api/load_races",{t_id:this.currentTrackData.t_id,u_ids:t.dataset.u_id}).then((e=>e.result&&this.scene.addRaces(e.data)))},{name:"Copy Race Data",click:()=>Application.Helpers.AjaxHelper.post("track_api/load_races",{t_id:this.currentTrackData.t_id,u_ids:t.dataset.u_id}).then((e=>e.result&&navigator.clipboard.writeText(JSON.stringify(e.data,"\t",4)).catch((e=>alert(e.message)))))},{name:t.dataset.legitimacy||"Test Legitimacy",styles:t.dataset.legitimacy&&["disabled"],click:()=>Application.Helpers.AjaxHelper.post("track_api/load_races",{t_id:this.currentTrackData.t_id,u_ids:t.dataset.u_id}).then((({data:e,result:s})=>{if(!s)return alert("Race not found.");let[i]=this.scene.formatRaces(e),a=!this.constructor.verifyRaceData(i);t.dataset.legitimacy=a?"Illegitimate (TAS)":"Legit",a&&this.updateTASLeaderboard([i])}))},{name:"Report",styles:["danger",t.dataset.reported&&"disabled"],click:()=>this.constructor.report("Race '{data-u_id}' by @{data-d_name}",t.dataset,{type:"race"}).then((()=>{t.dataset.reported=!0}))}];if(Application.settings.user.u_id==t.dataset.u_id&&s.splice(s.length-1,0,{name:t.title||"Check Date",styles:t.title&&["disabled"],click:()=>this.constructor.fetchRaceBestDate().then((e=>t.setAttribute("title",e)))},{name:"Download",click:()=>this.constructor.downloadRace(this.currentTrackData.t_id,t.dataset.u_id)}),Application.settings.user.moderator){let e=await this.constructor.fetchUser(t.dataset.d_name);s.splice(s.length-1,0,{name:"Feature",click:()=>navigator.clipboard.writeText('"frhd.co/t/'+this.currentTrackData.t_id+"/r/"+t.dataset.d_name.toLowerCase()+'": ""').then((()=>{window.open("https://github.com/Calculamatrise/frhd-featured-ghosts/edit/master/data.json","blank")}))},{name:"Delete",styles:["danger"],click:()=>Application.Helpers.AjaxHelper.post("moderator/remove_race",{t_id:this.currentTrackData.t_id,u_id:t.dataset.u_id}).then((e=>e.result&&(t.remove(),Application.router.current_view.refresh_leaderboard()))).fail((e=>alert("Something went wrong! "+e.message)))},{name:"Delete & Ban",styles:["danger",e.user.banned&&"disabled"],click:()=>Application.Helpers.AjaxHelper.post("moderator/remove_race",{t_id:this.currentTrackData.t_id,u_id:t.dataset.u_id}).then((e=>e.result&&(t.remove(),Application.router.current_view.refresh_leaderboard(),Application.Helpers.AjaxHelper.post("moderator/ban_user",{u_id:t.dataset.u_id})))).fail((e=>alert("Something went wrong! "+e.message)))})}return this.storage.get("developerMode")&&s.push({type:"hr"},{name:"Copy Racer Id",click:()=>navigator.clipboard.writeText(t.dataset.u_id)}),void a.create(s,e)}let s=e.target.closest(".track-leaderboard");if(null!==s){e.preventDefault();const t=[{name:"Race All",click:()=>Application.Helpers.AjaxHelper.post("track_api/load_races",{t_id:this.currentTrackData.t_id,u_ids:Array.from(s.querySelectorAll(".track-leaderboard-race-row")).map((e=>e.dataset.u_id)).join(",")}).then((e=>e.result&&this.scene.addRaces(e.data)))}];return Application.settings.user.moderator&&t.splice(t.length,0,{name:"Delete All",styles:["danger","disabled"],click:()=>confirm("Are you sure you want to delete ALL races on this leaderboard? This cannot be undone.")&&Promise.all(Array.from(s.querySelectorAll(".track-leaderboard-race-row")).map((e=>Application.Helpers.AjaxHelper.post("moderator/remove_race",{t_id:this.currentTrackData.t_id,u_id:e.dataset.u_id}))))}),void a.create(t,e)}let i=e.target.closest(".track-comment");if(null!==i){if(e.preventDefault(),e.target.closest(".track-comment-img, a.bold"))return void a.create(await this.buildUserContextMenu(i),e);let t=i.querySelector(".track-comment-confirm-flag > .yes");const s=[{name:"Reply",click:()=>{let e=document.querySelector("#track-comment");e.focus(),e.value="@"+i.dataset.d_name+" "}},{name:"Copy Text",click:()=>navigator.clipboard.writeText(i.querySelector(".track-comment-msg").innerText)},{name:"Report",styles:["danger",t||"disabled"],click:()=>t.click()}];return Application.settings.user.d_name==i.dataset.d_name&&s.splice(s.length-1,0,{name:"Delete",styles:["danger"],click:()=>Application.router.current_view._delete_comment(this.currentTrackData.t_id,i.dataset.c_id,(e=>e.result&&i.remove()))}),Application.settings.user.admin&&s.splice(s.length-1,0,{name:"Set Messaging Ban",styles:["danger"],click:()=>Application.Helpers.AjaxHelper.post("admin/user_ban_messaging",{messaging_ban_uname:i.dataset.d_name.toLowerCase()})}),this.storage.get("developerMode")&&s.push({type:"hr"},{name:"Copy Comment Id",click:()=>navigator.clipboard.writeText(i.dataset.c_id)}),void a.create(s,e)}let r=e.target.closest(".track-about-panel > .panel-padding");if(null!==r){if(e.preventDefault(),e.target.closest(".track-about-author-img, a.bold")){const t=await this.buildUserContextMenu(r);let s=document.querySelector("#subscribe_to_author");return t.splice(t.length-3,0,{name:s.innerText,styles:/^un/i.test(s.innerText)&&["danger"],click:()=>s.click()}),void a.create(t,e)}let t=this.storage.get("experiments").playlists&&this.fetchAndCachePlaylists("playlater"),s=t&&t.has(this.currentTrackData.t_id),i=document.querySelector(".track-flag ~ .track-confirm-flag > .yes");const o=[{name:"Copy Title",click:()=>navigator.clipboard.writeText(r.querySelector("h1.bold").innerText)},{name:"Copy Description",click:()=>navigator.clipboard.writeText(r.querySelector(".description").innerText)},{name:(s?"Remove from":"Add to")+" Playlist",styles:[s&&"danger",this.storage.get("experiments").playlists||"disabled"],click:()=>Application.Helpers.AjaxHelper.get("t/"+this.currentTrackData.t_id).then((({track:e,user_track_stats:t})=>{const i=this.fetchAndCachePlaylists("playlater");i[s?"delete":"set"](this.currentTrackData.t_id,{author:e.author,averageTime:t.avg_time,featured:e.featured,id:this.currentTrackData.t_id,img:e.img,slug:e.slug,title:e.title}),i.size>0?localStorage.setItem("frhd-lite.playlists.playlater",JSON.stringify(Array.from(i.values()))):localStorage.removeItem("frhd-lite.playlists.playlater")}))},{name:r.dataset.last_played_date||"Check Last Played",styles:r.dataset.last_played_date&&["disabled"],click:()=>this.constructor.fetchTrackLastPlayedDate().then((e=>r.dataset.last_played_date=e))},{name:"Report",styles:["danger",i||"disabled"],click:()=>(i.click(),i.parentElement.remove(),document.querySelector(".track-flag")?.remove())}];return Application.settings.user.u_id==this.currentTrackData.author_id&&o.splice(o.length-1,0,{name:"Download",click:()=>this.constructor.downloadTrack(this.currentTrackData.t_id)},{name:"Download All",click:()=>this.constructor.downloadAllTracks(Application.settings.user.u_name)}),Application.settings.user.moderator&&o.splice(o.length-1,0,{name:"Add to Track of the Day",styles:["disabled"]},{name:(GameSettings.track.featured?"Unf":"F")+"eature",styles:GameSettings.track.featured&&["danger"],click:()=>Application.Helpers.AjaxHelper.post("track_api/feature_track/"+this.currentTrackData.t_id+"/"+(1-GameSettings.track.featured)).then((e=>{e.result&&(this.currentTrackData.track.featured=!this.currentTrackData.track.featured,GameSettings.track.featured=this.currentTrackData.track.featured)}))},{name:(this.currentTrackData.track.hide?"Unh":"H")+"ide",styles:["danger"],click:()=>Application.Helpers.AjaxHelper.get("moderator/hide_track/"+this.currentTrackData.t_id).then((e=>{e.result&&(this.currentTrackData.track.hide=1-this.currentTrackData.track.hide,GameSettings.track.hide=this.currentTrackData.track.hide)}))}),Application.settings.user.admin&&o.splice(o.length-1,0,{name:"Remove Track of the Day",styles:["danger"],click:()=>Application.Helpers.AjaxHelper.post("admin/removeTrackOfTheDay",{t_id:this.currentTrackData.t_id})}),this.storage.get("developerMode")&&o.push({type:"hr"},{name:"Copy Track Id",click:()=>navigator.clipboard.writeText(this.currentTrackData.t_id)}),void a.create(o,e)}},writable:!0}),this.styleSheet.set("context-menu",{backgroundColor:"hsl(200deg 15% 15%)",border:"1px solid hsl(200deg 25% 25% / 50%)",borderRadius:".25rem",boxShadow:"2px 2px 4px -1px hsl(0deg 0% 10% / 75%)",display:"flex",flexDirection:"column",fontSize:"clamp(9px, .75rem, 13px)",overflow:"hidden",padding:".275em",position:"absolute",zIndex:1002}),this.styleSheet.set("context-menu button",{backgroundColor:"transparent",border:"none",borderRadius:"0.25em",color:"white",padding:"0.5em 1em",textAlign:"left"}),this.styleSheet.set("context-menu button:hover",{backdropFilter:"brightness(0.725)"}),this.styleSheet.set("context-menu hr",{backgroundColor:"hsl(200deg 20% 25% / 60%)",border:"none",height:"1px",color:"hsl(200deg 30% 20% / 50%)",width:"90%"}),this.styleSheet.set("button.danger",{color:"hsl(0deg, 75%, 55%)"}),this.styleSheet.set("button.danger:disabled",{color:"hsl(0deg 75% 55% / 50%)"})),document.removeEventListener("contextmenu",this._oncontextmenu),document.addEventListener("contextmenu",this._oncontextmenu)}async buildUserContextMenu(e){let t=await this.constructor.fetchCurrentUser(),s=t.friend_requests.request_data.find((({u_id:t})=>t==e.u_id)),i=t.friends.friends_data.find((({u_id:t})=>t==e.u_id));const a=[{name:"Profile",click:()=>Application.router.do_route("u/"+(e.u_name||e.d_name.toLowerCase()))},{name:"Copy Username",click:()=>navigator.clipboard.writeText(comment.dataset.d_name)},{name:(i?"Remove":"Add")+" Friend",styles:[i&&"danger",t.friends.friend_cnt>=30&&"disabled"],click:()=>Application.Helpers.AjaxHelper.post("friends/"+(i?"remove_friend":"send_friend_request"),{u_name:e.d_name})},{name:"Report",styles:["danger"],click:()=>this.constructor.report("User @{data-d_name} ({data-u_id})",e,{type:"user"})}];if(s&&a.splice(3,0,{name:"Accept Friend Request",styles:!e.u_id&&["disabled"],click:()=>Application.Helpers.AjaxHelper.post("friends/respond_to_friend_request",{u_id:e.u_id,action:"accept"})},{name:"Reject Friend Request",styles:["danger",!e.u_id&&"disabled"],click:()=>Application.Helpers.AjaxHelper.post("friends/respond_to_friend_request",{u_id:e.u_id,action:"decline"})}),Application.settings.user.moderator){let t=await this.constructor.fetchUser(e.d_name||e.u_name||e.u_id);a.splice(a.length-1,0,{name:(t.user.classic?"Remove":"Set")+" Official Author",styles:t.user.classic&&["danger"]},{name:(t.user.banned?"Unb":"B")+"an",styles:["danger"]})}if(Application.settings.user.admin){const t=e.u_name||e.d_name.toLowerCase();a.splice(a.length-1,0,{name:"Set Admin Ban",styles:["danger"],click:()=>Application.Helpers.AjaxHelper.post("admin/user_ban_messaging",{ban_secs:prompt("How long should this ban last? (in seconds)"),username:t,delete_race_stats:confirm("Would you like to delete race stats?")})},{name:"Set Messaging Ban",styles:["danger"],click:()=>Application.Helpers.AjaxHelper.post("admin/user_ban_messaging",{messaging_ban_uname:t})},{name:"Set Uploading Ban",styles:["danger"],click:()=>Application.Helpers.AjaxHelper.post("admin/user_ban_uploading",{uploading_ban_uname:t})},{name:"Deactivate User",styles:["danger"],click:()=>Application.Helpers.AjaxHelper.post("admin/deactivate_user",{username:t})},{name:"Delete User Account",styles:["danger"],click:()=>Application.Helpers.AjaxHelper.post("admin/delete_user_account",{username:t})})}return this.storage.get("developerMode")&&a.push({type:"hr"},{name:"Copy User Id",click:()=>navigator.clipboard.writeText(e.u_id)}),a}cacheTrackData(){let e=document.querySelector("#track-data");this.currentTrackData=e?Object.assign({},e.dataset,window.hasOwnProperty("GameSettings")&&{track:GameSettings.track}):null}fetchChallengeLeaderboard({createIfNotExists:e}={}){let t=document.querySelector("#race_leaderboard > table > tbody");if(!t&&e){let e=document.querySelector("#track_leaderboard");if(!e)return;s=Application.Helpers.TemplateHelper.render(Application.router.current_view.templates["track/track_race_leaderboard"],{},{race_leaderboard:[]}),t=(new DOMParser).parseFromString(s,"text/html").body.childNodes[0],e.parentElement.prepend(t),t=t.querySelector("table"),t=t.querySelector("tbody")||t.appendChild(document.createElement("tbody"))}var s;return t.closest(".track-leaderboard").style.removeProperty("display"),t||null}fetchTASLeaderboard({createIfNotExists:e}={}){let t=document.querySelector("#frhd-lite\\.tas-leaderboard > table > tbody");if(!t&&e){let e=document.querySelector("#track_leaderboard");if(!e)return;t=e.cloneNode(!0),t.setAttribute("id","frhd-lite.tas-leaderboard");let s=t.querySelector("h3:first-child");s.setAttribute("title","Tool-assisted speedruns"),s.innerText="TAS BEST TIMES",e.after(t),t=t.querySelector("table > tbody"),t.replaceChildren()}return t||null}fetchAndCachePlaylists(e){"string"==typeof e&&!this.playlists.has(e)&&this.playlists.set(e,new Map);for(let t of this.playlists.keys()){if("string"==typeof e&&t!==e)continue;const s=localStorage.getItem("frhd-lite.playlists."+t);if(null===s)continue;const i=this.playlists.get(t);for(const e of JSON.parse(s))i.set(String(parseInt(e.id)),e)}return e?this.playlists.get(e)||null:this.playlists}refresh(){let e=this.storage.get("keymap");for(let t in e)this.scene.playerManager.firstPlayer._gamepad.keymap[t.charCodeAt()]=e[t];for(const e of this.scene.playerManager._players.filter((e=>e._user.u_id==this.scene.playerManager.firstPlayer._user.u_id)))e._baseVehicle.color="#000000"!=this.storage.get("bikeFrameColor")&&this.storage.get("bikeFrameColor")||GameSettings.physicsLineColor}updateTASLeaderboard(e){let t=this.fetchTASLeaderboard({createIfNotExists:!0});for(let s of e){let i=t.appendChild(this.constructor.fetchRaceRow(s,{parent:t,placement:1+e.indexOf(s)}));i.querySelector(".num").innerText=1+e.indexOf(s)+".";let a=Object.fromEntries(Object.keys(s.race.code.tas).slice(1).map((e=>e.split(/:\s*/).map((e=>isFinite(e)?parseFloat(e):e.replace(/\s+/g,"_"))))));i.querySelector(":nth-child(4)").innerText=this.constructor.formatRaceTime(a.run_ticks/GameSettings.drawFPS*1e3);let r=i.querySelector(".track-leaderboard-action");r.querySelector("span.core_icons.core_icons-btn_add_race.track-leaderboard-race")||r.appendChild(this.constructor.createElement("span.core_icons.core_icons-btn_add_race.track-leaderboard-race",{title:"Race "+s.user.d_name,onclick(){let e=this.closest(".track-leaderboard-race-row");lite.scene.removeRaces([e.dataset.u_id])}}))}}draw(e){this.storage.get("inputDisplay")&&this.drawInputDisplay(e)}drawInputDisplay(e){let{downButtons:t}=this.scene.playerManager.getPlayerByIndex(this.scene.camera.focusIndex)._gamepad,s=parseInt(this.storage.get("inputDisplaySize"))+3,i={x:s,y:e.canvas.height-10*s};e.save(),e.fillStyle=GameSettings.physicsLineColor,e.globalAlpha=this.storage.get("inputDisplayOpacity"),e.lineWidth=s/2,e.strokeStyle=GameSettings.physicsLineColor;let a=s/2,r=4*s;e.beginPath(),e.roundRect(i.x,i.y,r,r,a),t.z&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x+5*s,i.y,r,r,a),t.up&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x,i.y+5*s,r,r,a),t.left&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x+5*s,i.y+5*s,r,r,a),t.down&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x+10*s,i.y+5*s,r,r,a),t.right&&e.fill(),e.stroke(),e.globalCompositeOperation="xor",e.lineWidth=s/3,e.beginPath(),e.moveTo(i.x+2.7*s,i.y+3*s),e.lineTo(i.x+1.2*s,i.y+3*s),e.lineTo(i.x+2.7*s,i.y+1*s),e.lineTo(i.x+1.2*s,i.y+1*s),e.moveTo(i.x+6.2*s,i.y+2.7*s),e.lineTo(i.x+7*s,i.y+1.2*s),e.lineTo(i.x+7.8*s,i.y+2.7*s),e.moveTo(i.x+2.5*s,i.y+7.8*s),e.lineTo(i.x+1.2*s,i.y+7*s),e.lineTo(i.x+2.5*s,i.y+6.2*s),e.moveTo(i.x+6.2*s,i.y+6.2*s),e.lineTo(i.x+7*s,i.y+7.8*s),e.lineTo(i.x+7.8*s,i.y+6.2*s),e.moveTo(i.x+11.5*s,i.y+7.8*s),e.lineTo(i.x+12.8*s,i.y+7*s),e.lineTo(i.x+11.5*s,i.y+6.2*s),e.stroke(),e.restore()}initAccountManager(){if(!Application.User.logged_in)return;let e=Application.router.left_navigation_view.el.querySelector("a.logout");e.hasAttribute("id")&&(e.removeAttribute("id"),e.innerText="Switch",e.addEventListener("click",(e=>{e.stopPropagation(),e.stopImmediatePropagation(),this.accountManager||(Object.defineProperty(this,"accountManager",{value:this.constructor.createElement("dialog#frhd-lite\\.account-manager",{children:[this.constructor.createElement("span.core_icons.core_icons-icon_close.signup-login-modal-close",{style:{position:"absolute",right:".5em",top:".5em"},onclick:()=>this.accountManager.close()}),this.constructor.createElement("div.accounts-container",{children:(JSON.parse(localStorage.getItem("frhd-lite.account-manager"))??[]).map((e=>this.constructor.createAccountContainer(e))),style:{display:"flex",flexDirection:"column",gap:"0.4rem"}}),this.constructor.createElement("button.new-button.button-type-2",{innerText:"Add account",onclick:e=>{let t=document.querySelector("div#login-container");if(t)return e.target.innerText="Add account",e.target.classList.replace("button-type-3","button-type-2"),void t.remove();let s=e.target;e.target.before(lite.constructor.createElement("div#login-container",{children:[this.constructor.createElement("input.field.auth-field#save-account-login",{placeholder:"Username or Email",style:{borderRadius:"2rem"},type:"text",onkeyup(e){"Enter"===e.key&&this.nextElementSibling.focus()}}),this.constructor.createElement("input.field.auth-field#save-account-password",{placeholder:"Password",style:{borderRadius:"2rem"},type:"password",onkeyup(e){"Enter"===e.key&&this.nextElementSibling.click()}}),this.constructor.createElement("button.new-button.button-type-1",{innerText:"Save account",onclick:e=>{Application.Helpers.AjaxHelper.post("/auth/standard_login",{login:document.querySelector("#save-account-login")?.value,password:document.querySelector("#save-account-password")?.value}).done((t=>{if(!t.result)return;let i=JSON.parse(localStorage.getItem("frhd-lite.account-manager"))||[];i.find((({login:e})=>e===t.data.user.d_name))||(i.push({login:t.data.user.d_name,password:document.querySelector("#save-account-password")?.value}),this.accountManager.querySelector(".accounts-container").append(lite.constructor.createAccountContainer(i[i.length-1])),localStorage.setItem("frhd-lite.account-manager",JSON.stringify(i)),s.innerText="Add account",s.classList.replace("button-type-3","button-type-2"),e.target.parentElement.remove())}))}})],style:{display:"flex",flexDirection:"column",gap:"0.4rem",marginTop:"1rem"}})),e.target.classList.replace("button-type-2","button-type-3"),e.target.innerText="Cancel"}}),this.constructor.createElement("button.new-button.button-type-3",{innerText:"Logout",onclick:()=>{Application.Helpers.AjaxHelper.post("/auth/logout").done((({result:e})=>{e&&(Application.User.logged_in=!1,Application.User.clear(),Application.events.publish("user.change"),Application.events.unsubscribe("user.change"),Application.events.publish("user.logout"),Application.User.unset_game_settings_user(),this.remove())}))}})],onclick:e=>{if(this.accountManager!==e.target)return;let t=e.target.getBoundingClientRect();!(t.top<=e.clientY&&e.clientY<=t.top+t.height&&t.left<=e.clientX&&e.clientX<=t.left+t.width)&&e.target.close()}}),writable:!0}),this.styleSheet.set("dialog#frhd-lite\\.account-manager[open]",{display:"flex",flexDirection:"column",gap:"0.4em",height:"fit-content",inset:0,margin:"auto",maxHeight:"50vmin",maxWidth:"25vw",minWidth:"230px",overflow:"hidden auto",padding:"2.5em",position:"fixed",width:"40vmin",zIndex:1002}).set("dialog#frhd-lite\\.account-manager[open]::backdrop",{backgroundColor:"hsl(0deg 0% 0% / 50%)"}).set(".button-type-3",{backgroundImage:"linear-gradient(to bottom, hsl(7 86% 62% / 1), hsl(10 64% 46% / 1))"}).set(".button-type-3:hover",{backgroundImage:"linear-gradient(to bottom, hsl(4 79% 60% / 1), hsl(4 69% 37% / 1))"})),document.body.append(this.accountManager),this.accountManager.showModal()}),{passive:!0}))}initAchievementsDisplay(){this.nativeEvents.has("notificationEvent")||this.initNotificationEvent(),!this.achievementMonitor&&(Application.events.subscribe("notification.received",(({data:e})=>{void 0!==e&&void 0!==e.achievements_earned&&(void 0!==e.achievements_earned&&Application.events.publish("achievementsEarned",e.achievements_earned),this.refreshAchievements())})),Object.defineProperty(this,"achievementMonitor",{value:{container:this.constructor.createElement("div#achievements-container",{style:{display:"flex",flexDirection:"column",fontFamily:"riffic",gap:"0.4rem"}})},writable:!0}),this.achievementMonitor.wrapper=this.constructor.createElement("div#frhd-lite\\.achievement-monitor",{children:[this.constructor.createElement("a",{children:[this.constructor.createElement("span",{innerText:"Daily Achievements",style:{float:"left"}}),this.achievementMonitor.countdown=this.constructor.createElement("span.time-remaining",{innerText:"00:00:00",style:{float:"right"}})],href:"/achievements",style:{borderBottom:"1px solid hsl(190deg 25% 60%)",color:"black",fontFamily:"helsinki",paddingBottom:"5px"}}),this.achievementMonitor.container],style:{backgroundColor:"hsl(190 25% 95% / 1)",border:"1px solid hsl(190deg 25% 60%)",borderRadius:"1rem",display:"flex",flexDirection:"column",gap:"0.6rem",margin:"0 0.6rem",padding:"1.5rem",width:"-webkit-fill-available"}})),this.refreshAchievements().then((e=>{this.achievementMonitor.countdown.innerText=[String(Math.floor(e.time_left/3600)).padStart(2,"0"),String(Math.floor(e.time_left%3600/60)).padStart(2,"0"),String(Math.floor(e.time_left%60)).padStart(2,"0")].join(":"),this.achievementMonitor.countdownTimer||=setInterval((()=>{let e=this.achievementMonitor.countdown.innerText.split(":").map((e=>parseInt(e)));0===e[2]&&(0===e[1]&&(e[0]--,e[1]=59),e[1]--,e[2]=59),e[2]--,0===e.reduce(((e,t)=>e+t),0)&&clearInterval(this.achievementMonitor.countdownTimer),this.achievementMonitor.countdown.innerText=e.map((e=>String(e).padStart(2,"0"))).join(":")}),1e3),document.querySelector("#right_content").prepend(this.achievementMonitor.wrapper)}))}initBestDate(){this.nativeEvents.has("leaderboardEvent")||this.initLeaderboardEvent(),Application.router.current_view.on("leaderboard.rendered",(()=>{document.querySelectorAll(`.track-leaderboard-race-row[data-u_id="${Application.settings.user.u_id}"]`).forEach((e=>{e.setAttribute("title","Loading..."),e.addEventListener("pointerover",(()=>this.constructor.fetchRaceBestDate().then((t=>e.setAttribute("title",t)))),{once:!0,passive:!0})}))}))}initDownloadGhosts(){this.nativeEvents.has("leaderboardEvent")||this.initLeaderboardEvent(),this.styleSheet.set(".track-page .track-leaderboard .track-leaderboard-action",{textAlign:"right"}),this.styleSheet.set(".track-page .track-leaderboard .track-leaderboard-action > :is(span.core_icons, div.moderator-remove-race)",{right:"6px"}),Application.router.current_view.on("leaderboard.rendered",(()=>{for(let e of document.querySelectorAll('.track-leaderboard-race-row[data-u_id="'+Application.settings.user.u_id+'"] > .track-leaderboard-action:not(:has(> #frhd-lite\\.download-race))')){let t=this.constructor.createElement("span.btn.new-button.button-type-1#frhd-lite\\.download-race",{innerText:"⭳",title:"Download Race",style:{aspectRatio:1,fontSize:"15px",height:"22px",lineHeight:"1.5em",marginRight:"8px",textAlign:"center"}});t.addEventListener("click",(()=>this.constructor.downloadRace(GameSettings.track.id,t.parentElement.parentElement.dataset.u_id)),{passive:!0}),e.style.setProperty("width","20%"),e.prepend(t),e.textContent.length>0&&e.replaceChildren(...e.children)}}))}initDownloadTracks(){let e=document.querySelector(".subscribe-to-author"),t=document.querySelector("#frhd-lite\\.download-track");if(!t){t=e.cloneNode(!0);let s=t.querySelector("#subscribe_to_author_count");s&&s.remove();let i=t.querySelector("#subscribe_to_author");i.setAttribute("id","frhd-lite.download-track"),i.innerText="Download",i.addEventListener("click",(()=>this.constructor.downloadTrack(GameSettings.track.id)),{passive:!0}),e.after(t)}}initFeaturedGhosts(){this.nativeEvents.has("leaderboardEvent")||this.initLeaderboardEvent(),Application.router.current_view.on("leaderboard.rendered",(async()=>{const e=Object.fromEntries(Object.entries(await this.constructor.fetchFeaturedGhosts()).filter((e=>Object.keys(e[1]=Object.fromEntries(Object.entries(e[1]).filter((([e])=>parseInt(e.split("/t/")[1])==Application.router.current_view._get_track_id())))).length)));for(const t in e)for(const s in e[t]){let i=s.split("/r/")[1];for(const a of document.querySelectorAll('.track-page .track-leaderboard .track-leaderboard-race-row[data-d_name="'+i+'" i]')){let i=10;switch(e[t][s]){case"fast":i=180;break;case"vehicle":i=40;break;case"trick":i=120}let r=a.querySelector(".num");r.classList.add("core_icons","core_icons-icon_featured_badge"),r.classList.remove("num"),r.innerText=null,r.setAttribute("title","Featured"),a.style.setProperty("background-color",`hsl(${i}deg 60% 50% / 40%)`)}}}))}initFriendsLastPlayed(){fetch(location.pathname+"?ajax").then((e=>e.json())).then((({friends:e,is_profile_owner:t})=>{t||document.querySelectorAll(".friend-list-item-name").forEach((t=>{t.after(this.constructor.createElement("div.friend-list-item-date",{innerText:"Last Played "+e.friends_data.find((({d_name:e})=>e==t.innerText)).activity_time_ago}))}))}))}initGhostMetadata(){this.nativeEvents.has("leaderboardEvent")||this.initLeaderboardEvent();const e=e=>{if(!e)return 0;let t=e.split(":").map((e=>parseFloat(e)));return Math.round((1e3*t[1]+6e4*t[0])*(GameSettings.drawFPS/1e3))};Application.router.current_view.on("leaderboard.rendered",(({track_leaderboard:t})=>{const s=(t=t.filter((({user_no_race_data:e})=>!e))).reduce(((t,{run_time:s})=>t+e(s)),0)/t.length;for(let i of t.filter((({run_time:i,u_id:a},r)=>{if(!i)return!0;const o=t.filter((({u_id:e})=>e!==a)).reduce(((t,{run_time:s})=>t+e(s)),0)/t.length,n=e(t.at(-1).run_time),h=n-e(t[Math.min(t.length-1,r+1)].run_time);return this.debug&&console.log(s,e(i),"diff",s-e(i),"max diff",n-s,n-o,o,h,"max",n,"max divided by 100",n/100,h/n,h*(n/100),n/h),s-e(i)>n-o})))for(let e of document.querySelectorAll('.track-leaderboard-race-row[data-u_id="'+i.u_id+'"] > .num:not(:has(> #frhd-lite\\.flagged))'))e.setAttribute("id","frhd-lite.flagged"),e.setAttribute("title","This race has been flagged by frhd-lite under suspicion of misconduct."),e.innerText="⚠️"}))}initGhostPlayer(){this.replayGui||Object.defineProperty(this,"replayGui",{value:this.constructor.createElement("div",{style:{display:"none",inset:0,pointerEvents:"none",position:"absolute"}}),writable:!0}),this.replayGui.progress||Object.defineProperty(this.replayGui,"progress",{value:this.replayGui.appendChild(this.constructor.createElement("progress.frhd-lite\\.race-player-progress#replay-seeker",{max:100,min:0,value:0,style:{border:"none",bottom:0,height:"4px",pointerEvents:"all",position:"absolute",transition:"height 100ms",width:"100%"},type:"range",onchange(e){GameManager.game.currentScene.state.playing=!1;let t=GameManager.game.currentScene.playerManager.getPlayerByIndex(GameManager.game.currentScene.camera.focusIndex);t.isGhost()&&t._replayIterator.next(this.value)},onpointerdown(e){this.setPointerCapture(e.pointerId),this.value=Math.round(e.offsetX/parseInt(getComputedStyle(this).getPropertyValue("width"))*this.max),this.dispatchEvent(new InputEvent("change")),this.wasPlaying=GameManager.game.currentScene.state.playing},onpointermove(e){!0&e.buttons&&(this.value=Math.round(e.offsetX/parseInt(getComputedStyle(this).getPropertyValue("width"))*this.max),this.dispatchEvent(new InputEvent("change")))},onpointerup(e){this.releasePointerCapture(e.pointerId),GameManager.game.currentScene.state.playing=this.wasPlaying}})),writable:!0}),this.styleSheet.set(".frhd-lite\\.race-player-progress::-webkit-progress-value",{backgroundColor:"hsl(195deg 57% 25%)"}).set(".frhd-lite\\.race-player-progress:hover",{cursor:"pointer",filter:"brightness(1.25)",height:"6px !important"}),this.constructor.waitForElm("#game-container").then((e=>{e.appendChild(this.replayGui)}))}initJumpToComment(){let e=new URLSearchParams(location.search).get("c_id");if(e&&this.lastLoadedComment!=e&&!document.querySelector('.track-comment[data-c_id="'+e+'"]')){if(Object.defineProperty(this,"lastLoadedComment",{value:e,writable:!0}),"function"!=typeof Application.router.current_view.load_comments_until){const e=Object.getPrototypeOf(Application.router.current_view);e.load_comments_until=function(e,t){let s=document.querySelector(".track-comments-list div.track-comment:last-child").dataset.c_id,i=this._get_track_id(),a=document.querySelector(".track-prev-comments");a.style.setProperty("display","none");let r=document.querySelector(".track-comments-loading");r.style.setProperty("display","block"),this._get_comment_template((()=>{Application.Helpers.AjaxHelper.post("track_comments/load_more/"+i+"/"+s).then((s=>{if(!0===s.result&&s.data.track_comments.length>0){var i=Application.Helpers.TemplateHelper.render(this.templates["track/track_comment"],{},s.data),o=this.$el.find(".track-comments-list"),n=s.data.track_comments.findIndex((({comment:t})=>t.id==e))>0;o.append(i),!0===s.data.track_comments_load_more&&(n?a.style.removeProperty("display"):this.load_comments_until(...arguments)),n&&"function"==typeof t&&t(document.querySelector('.track-comment[data-c_id="'+e+'"]'))}r.style.setProperty("display","none"),Application.events.publish("resize")}))}))},Object.setPrototypeOf(Application.router.current_view,e)}Application.router.current_view.load_comments_until(e,(e=>{e.scrollIntoView({behavior:"smooth"}),window.addEventListener("scrollend",(()=>{e.classList.add("animated","flash"),setTimeout((()=>{e.classList.remove("animated","flash")}),2e3)}),{once:!0,passive:!0})}))}}initLeaderboardEvent(){const e=Application.Views.TrackView.prototype._render_leaderboards;this.nativeEvents.set("leaderboardEvent",e),Application.Views.TrackView.prototype._render_leaderboards=function(t){e.apply(this,arguments),t.result&&(this.trigger("leaderboard.rendered",...arguments),Application.events.publish("leaderboard.rendered",...arguments))}}initNotificationEvent(){const e=Object.getPrototypeOf(Application.Helpers.AjaxHelper),t=e._check_event_notification;this.nativeEvents.set("notificationEvent",t),e._check_event_notification=function(e){t.apply(this,arguments),e.result&&Application.events.publish("notification.received",...arguments)},Object.setPrototypeOf(Application.Helpers.AjaxHelper,e)}initPlayLater(){let e=document.querySelector(".tab-entry.recently-played-tab");if(!e||document.querySelector(".tab-entry.frhd-lite\\.play-later-tab"))return;let t=this.fetchAndCachePlaylists("playlater");if(t.size<1)return;let s=e.parentElement.appendChild(e.cloneNode(!0));s.classList.add("frhd-lite.play-later-tab"),s.dataset.panel="#frhd-lite\\.play-later",s.firstElementChild.lastChild.data="Play Later";let i=document.querySelector("#profile_recently_played");if(!i)return;let a=i.parentElement.appendChild(i.cloneNode(!0));a.setAttribute("id","frhd-lite.play-later"),a.querySelector(".track-list").replaceChildren(...Array.from(t&&t.values()).map((e=>{const t="https://"+location.host+"/u/"+e.author,s="https://"+location.host+"/t/"+e.slug;return this.constructor.createElement("li",{children:[this.constructor.createElement("div.track-list-tile.trackTile",{children:[this.constructor.createElement("a.top",{href:s,children:[this.constructor.createElement("img.track-list-tile-thumb.top-image",{src:e.img}),this.constructor.createElement("img.track-list-tile-thumb",{alt:"Track Preview",src:"https://cdn."+location.host.split(".").slice(-2).join(".")+"/free_rider_hd/sprites/track_preview_250x150.png"}),this.constructor.createElement("span.bestTime",{innerText:" "+e.averageTime+" ",title:"Average Time"})]}),this.constructor.createElement("div.bottom",{children:[this.constructor.createElement("a.name",{href:s,innerText:e.title}),this.constructor.createElement("div.profileGravatarIcon",{style:{backgroundImage:"url("+t+"/pic?size=50)"}}),this.constructor.createElement("a.author",{href:t+"/created",innerHTML:"&ensp;"+e.author})]})]})]})})))}initReportTracks(){let e=document.querySelector(".track-flag ~ .track-confirm-flag > .yes");e&&!e.classList.contains("frhd-lite.track-report")&&(e.classList.add("frhd-lite.track-report"),e.addEventListener("click",(()=>{this.constructor.report("This track",{},{type:"track"}).then((e=>alert(e.result?"You have successfully reported this track.":e.msg)))}),{passive:!0}))}initRequestTrackData(){let e=document.querySelector("#delete-all-personal-data");e?e.parentElement.appendChild(this.constructor.createElement("button.blue-button.settings-header.new-button",{innerText:"Request All Data",style:{float:"right",fontSize:"13px",height:"auto",lineHeight:"23px",marginTop:"6px",marginRight:"14px",padding:"0 1rem"}})).addEventListener("click",(()=>this.constructor.downloadAllTracks(Application.settings.user.u_name)),{passive:!0}):console.warn("Request track data failed to load! Personal data is not present.")}initUploadGhosts(){this.dialogs.has("ghostUpload")||this.dialogs.set("ghostUpload",document.body.appendChild(this.constructor.createElement("dialog.editorDialog-content.editorDialog-content_importDialog.frhd-lite\\.dialog",{children:[this.constructor.createElement("div.editorDialog-titleBar",{children:[this.constructor.createElement("span.editorDialog-close",{innerText:"×",onclick:e=>e.target.closest("dialog").close("cancel")}),this.constructor.createElement("h1.editorDialog-content-title",{innerText:"UPLOAD GHOST"})]}),this.constructor.createElement("div.importDialog-codeContainer",{children:[this.constructor.createElement("span.importDialog-placeholder",{children:[this.constructor.createElement("span",{innerText:"Paste ghost data, drag and drop text files here, or "}),this.constructor.createElement("span.link",{innerText:"select a file",onclick:()=>{this.ghostUploadPicker.click()}}),this.constructor.createElement("span",{innerText:" to import"}),this.ghostUploadPicker||=this.constructor.createElement("input",{accept:"application/json",type:"file",style:{display:"none"},oninput:async e=>{let[t]=e.target.files,s=JSON.parse(await t.text());s.t_id===GameSettings.track.id&&s.u_id===Application.settings.user.u_id&&(delete s.t_id,delete s.u_id,Application.Helpers.AjaxHelper.post("/track_api/track_run_complete",{t_id:GameSettings.track.id,u_id:Application.User.attributes.u_id,code:s.code,vehicle:s.vehicle,run_ticks:s.run_ticks,fps:25,time:(e=>{let t=e/30*1e3;t=parseInt(t,10);let s=Math.floor(t/6e4),i=(t-6e4*s)/1e3;return i=i.toFixed(2),10>i&&(i="0"+i),s+":"+i})(s.run_ticks),sig:await(async e=>Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e)))).map((e=>e.toString(16).padStart(2,"0"))).join(""))(`${GameSettings.track.id}|${Application.User.attributes.u_id}|${s.code}|${+s.run_ticks}|${s.vehicle}|25|erxrHHcksIHHksktt8933XhwlstTekz`)}).done((function(e){e.result&&(Application.router.current_view.refresh_leaderboard(),Application.router.current_view.highlightLeaderboad(),setTimeout(refreshlb,1e3))})))}})]}),this.constructor.createElement("textarea.importDialog-code",{autocomplete:!1,spellcheck:!1})]}),this.constructor.createElement("form.editorDialog-bottomBar.clearfix",{children:[this.constructor.createElement("button.primary-button.primary-button-blue.float-right.margin-0-5",{innerText:"Upload",value:"default"}),this.constructor.createElement("button.primary-button.primary-button-black.float-right.margin-0-5",{innerText:"Cancel",value:"cancel"})],method:"dialog"})],style:{margin:"revert",padding:0,position:"revert",top:"revert"},onclose:e=>{e.target.returnValue}}))),this.constructor.waitForElm("#friends-leaderboard-challenge").then((e=>{const t=this.dialogs.get("ghostUpload");t.button||(t.button=e.cloneNode(!0),t.button.classList.add("button-type-1"),t.button.classList.remove("button-type-2"),t.button.style.setProperty("margin-top",0),t.button.removeAttribute("id"),t.button.innerText="Upload Ghost",t.button.addEventListener("click",(()=>{t.showModal()}),{passive:!0})),e.after(t.button)}))}initUserModeration(){let e=document.querySelector("#profile-user-data");if(!e)return;let t=e=>{self=e.target;let t=self.previousElementSibling;"save"==self.innerText.toLowerCase()?(self.dispatchEvent(new CustomEvent("save",{detail:t.value})),t.setAttribute("readonly",""),self.classList.add("button-type-1"),self.classList.remove("button-type-2"),self.innerText="Edit"):(t.removeAttribute("readonly"),self.classList.add("button-type-2"),self.classList.remove("button-type-1"),self.innerText="Save")},s=e.dataset;s.u_name=document.querySelector(".profile-username").innerText;let i=document.querySelector(".pm > .pm-user-properties"),a=i.appendChild(i.querySelector(".pm-user-property.pm-user-id").cloneNode(!0));a.classList.remove("pm-user-id");let r=a.querySelector(".pm-property");r.innerText="Email: ";let o=this.constructor.createElement("input",{placeholder:"New email",readonly:"",type:"text"});r.nextElementSibling.replaceWith(o);let n=a.querySelector("#pm-ban-user");n.classList.remove("ban-user-button"),n.innerText="Edit",n.removeAttribute("id"),n.addEventListener("click",t,{passive:!0}),n.addEventListener("save",(e=>Application.Helpers.AjaxHelper.post("moderator/change_email",{u_id:s.u_id,email:e.detail}).then((e=>(alert(e.msg),e))))),a.querySelector("#pm-unban-user").remove();let h=i.appendChild(a.cloneNode(!0));r=h.querySelector(".pm-property"),r.innerText="Username: ",o=h.querySelector("input"),o.setAttribute("placeholder","New username"),o.setAttribute("type","text"),o.setAttribute("value",s.u_name),n=h.querySelector("a"),n.addEventListener("click",t,{passive:!0}),n.addEventListener("save",(e=>Application.Helpers.AjaxHelper.post("moderator/change_username",{u_id:s.u_id,username:e.detail}).then((e=>(alert(e.msg),e)))));let l=i.appendChild(a.cloneNode());r=l.appendChild(r.cloneNode()),r.innerText="Password: ",n=l.appendChild(this.constructor.createElement("button.new-button.ban-user-button",{innerText:"Reset Password"})),n.addEventListener("click",(()=>Application.Helpers.AjaxHelper.post("auth/forgot_password",{email:s.u_name}).then((e=>(alert(e.msg),e)))),{passive:!0})}initUserTrackAnalytics(){document.querySelectorAll("#created_tracks .bottom").forEach((e=>{e.innerHTML=e.innerHTML.replace(/<!--|-->/g,"")}))}initUserTrackModeration(){for(let e of document.querySelectorAll("#created_tracks .bottom")){let t=e.appendChild(this.constructor.createElement("label",{style:{display:"block"}})),s=e.querySelector(".profileGravatarIcon");s&&s.style.setProperty("margin-right","4px"),t.appendChild(e.querySelector(".profileGravatarIcon")),t.appendChild(e.querySelector(".author")),t.appendChild(this.constructor.createElement("input",{type:"checkbox",style:{float:"right",height:"1.5rem"}}))}let e=document.querySelector("#content > div > div.profile-tabs > section > div.tab_buttons > div").appendChild(this.constructor.createElement("select",{style:{borderRadius:"4px",float:"right",fontFamily:"system-ui,roboto_medium,Arial,Helvetica,sans-serif",letterSpacing:"-.02em",marginRight:"10px",marginTop:"8px"}}));e.appendChild(this.constructor.createElement("option",{disabled:!0,innerText:"Select an action",value:"default"})),e.appendChild(this.constructor.createElement("option",{innerText:"Delete selected",value:"hide"})),e.appendChild(this.constructor.createElement("option",{innerText:"Deselect all",value:"deselect"})),e.appendChild(this.constructor.createElement("option",{innerText:"Select all",value:"select"})),e.addEventListener("change",(async t=>{switch(t.target.disabled=!0,t.target.value){case"hide":let t=document.querySelectorAll("#created_tracks li:has(.bottom > label > input[type='checkbox']:checked)");if(t.length>0){let s=document.body.appendChild(this.constructor.createElement("dialog",{style:{border:"none",boxShadow:"0 0 4px 0px hsl(190deg 25% 60%)",maxHeight:"75vh",maxWidth:"50vw",padding:0,width:"120vmin"}}));s.appendChild(this.constructor.createElement("p",{innerText:"Are you sure you would like to delete the following tracks?",style:{backgroundColor:"inherit",boxShadow:"0 0 4px 0 black",padding:"1rem",position:"sticky",top:0,zIndex:3}})).appendChild(this.constructor.createElement("span.core_icons.core_icons-icon_close",{style:{float:"right"}})).addEventListener("click",(()=>s.remove()),{passive:!0});let i=s.appendChild(this.constructor.createElement("ul.track-list.clearfix",{style:{maxHeight:"50cqh",overflowY:"auto",padding:"1rem",textAlign:"center"}}));i.append(...Array.from(t).map((e=>{let t=e.cloneNode(!0);return t.style.setProperty("width","min-content"),t})));let a=s.appendChild(this.constructor.createElement("form",{method:"dialog",style:{backgroundColor:"inherit",bottom:0,boxShadow:"0 0 4px 0 black",display:"flex",gap:".25em",padding:"1rem",position:"sticky",zIndex:2}}));a.appendChild(this.constructor.createElement("button.new-button.button-type-1",{innerText:"Cancel",value:"cancel"})),a.appendChild(this.constructor.createElement("button.new-button.button-type-2",{innerText:"Confirm",value:"default"})).addEventListener("click",(async e=>{e.preventDefault();for(let e of a.querySelectorAll("button"))e.disabled=!0,e.style.setProperty("opacity",.5),e.style.setProperty("pointer-events","none");a.appendChild(this.constructor.createElement("span.loading-hourglass"));let t=[],r=i.querySelectorAll(".bottom:has(> label > input[type='checkbox']:checked)");for(let e of r){let s=e.querySelector(".name").href,[i]=s.match(/(?<=\/t\/)\d+/);await fetch("/moderator/hide_track/"+i),t.push(i),e.closest("li").remove()}let o="frhd-lite_recently-hidden-tracks",n=Object.assign({},JSON.parse(sessionStorage.getItem(o)));n[Date.now()]=t,sessionStorage.setItem(o,JSON.stringify(n)),s.close(e.target.value)})),s.addEventListener("close",(t=>{e.disabled=!1,s.remove()})),s.showModal()}case"deselect":for(let e of document.querySelectorAll("#created_tracks .bottom > label > input[type='checkbox']:checked"))e.checked=!1;break;case"select":for(let e of document.querySelectorAll("#created_tracks .bottom > label > input[type='checkbox']:not(:checked)"))e.checked=!0}t.target.value="default",t.target.disabled=!1}),{passive:!0})}async modifyCommentNotifications(){let e=(await Application.Helpers.AjaxHelper.get("notifications").then((({notification_days:e})=>e&&e.length>0&&e.flatMap((({notifications:e})=>e))))).filter((({t_uname_mention:e})=>e));for(let{comment:t,track:s,ts:i}of e)document.querySelector('.notification[data-ts="'+i+'"] p > a[href$="'+s.url+'"]').href+="?c_id="+t.id}refreshAchievements(){return fetch("/achievements?ajax").then((e=>e.json())).then((async e=>{let t=await Promise.all(e.achievements.filter((e=>!e.complete)).sort(((e,t)=>t.tot_num-e.tot_num)).slice(0,3).map(this.constructor.createProgressElement.bind(this.constructor)));return this.achievementMonitor.container.replaceChildren(...t),e}))}static createAccountContainer({login:e,password:t}){let s=this.createElement("div",{children:[this.createElement("button.new-button.button-type-1",{innerText:e,style:{width:"-webkit-fill-available"},onclick:s=>{s.target.closest("#frhd-lite\\.account-manager").close(),Application.Helpers.AjaxHelper.post("/auth/standard_login",{login:e,password:t}).done((e=>{e.result&&Application.events.publish("auth.login",e.data.user,e.data.user_stats)}))}}),this.createElement("button.new-button.button-type-3",{innerText:"X",style:{aspectRatio:1,marginRight:0},onclick(){let t=JSON.parse(localStorage.getItem("frhd-lite.account-manager"))??[];t.splice(t.indexOf(t.find((t=>t.login===e))),1),localStorage.setItem("frhd-lite.account-manager",JSON.stringify(t)),s.remove()}})],style:{display:"flex",gap:"0.25rem"}});return s}static async createProgressElement(e){let t=this.createElement("div.achievement-info",{children:[this.createElement("div",{children:[this.createElement("span.achievements-coin.store_icons.store_icons-coin_icon_lg.achievement-coin-value",{innerText:e.coins,style:{color:"white",lineHeight:"45px",textAlign:"center",textShadow:"0 -1px 1px #9E8500"}}),this.createElement("div.achievement-info",{children:[this.createElement("a.title",{children:[this.createElement("b",{innerText:e.title})],href:await(e=>{switch(e){case"Buy 1 item from the shop":return"store/gear";case"Complete 1 friend race":case"Win 5 friend(s) race":return this.fetchCurrentUser().then((async({friends:e})=>{if(e.friend_cnt>0){let t;for(let s of e.friends_data)if(t=await fetch("/u/"+s.u_name).then((e=>e.json())).then((({recently_ghosted_tracks:{tracks:e}})=>e[Math.floor(Math.random()*e.length)])))return t}return"random/track"}));case"Improve 5 best times":case"Send 5 friend race challenges":return this.fetchCurrentUser().then((({recently_ghosted_tracks:{tracks:e}})=>{let t=e[Math.floor(Math.random()*e.length)];return t?t.slug:"random/track"}));default:return"random/track"}})(e.desc),style:{width:"-webkit-fill-available"}}),this.createElement("h6.achievement-info-desc.condensed",{innerText:e.desc,style:{color:"hsl(190deg 25% 60%)",fontFamily:"roboto_bold",margin:0}})]})],style:{alignItems:"center",display:"flex",gap:"0.5rem"}}),this.createElement("span",{innerText:e.progress,style:{fontSize:"1.25rem"}})],style:{alignItems:"center",display:"flex",justifyContent:"space-between"}});return t}static createElement(e,t={}){const s=arguments[arguments.length-1],i=document.createElement(e.replace(/[\.#].+/g,"")),a=e.match(/(?<=#)([^\.]+((?<=\\)\.)?)+/);null!==a&&(i.setAttribute("id",a[0].replace(/\\/g,"")),e=e.replace("#"+a[0],""));const r=e.match(/(?<=\.)([^\.#]+((?<=\\)\.)?)+/g);null!==r&&i.classList.add(...r.map((e=>e.replace(/\\/g,"")))),"innerText"in t&&(i.innerText=t.innerText,delete t.innerText);for(const e in t)if("object"==typeof t[e]){if(t[e]instanceof Array){if(/^children$/i.test(e))i.append(...t[e]);else if(/^classlist$/i.test(e))i.classList.add(...t[e]);else if(/^on/i.test(e))for(const s of t[e])i.addEventListener(e.slice(2),s,{passive:!/\.preventDefault\(\)/g.test(s.toString())})}else/^(dataset|style)$/i.test(e)&&Object.assign(i[e.toLowerCase()],t[e]);delete t[e]}return Object.assign(i,t),"function"==typeof s&&s(i),i}static async downloadFile(e,t,{desc:s}={}){let i="text/plain";if(!(t instanceof Blob)&&("object"==typeof t&&(i="application/json",t=JSON.stringify(t,"\t",4)),"showSaveFilePicker"in window))return showSaveFilePicker({excludeAcceptAllOption:!0,startIn:"downloads",suggestedName:e??"",types:[{description:"Free Rider HD "+s,accept:{[i]:["."+("application/zip"==i?"zip":"application/json"==i?"json":"txt")]}}]}).then((async e=>{let s=e.createWritable();await s.write(t),await s.close()})).catch((e=>{console.log("Download operation cancelled.")}));let a=this.createElement("a",{download:e||"frhd-lite_download-"+Date.now(),href:URL.createObjectURL(t instanceof Blob?t:new Blob([t],{type:i}))});a.click(),URL.revokeObjectURL(a.href)}static downloadRace(e,t){return Application.Helpers.AjaxHelper.get("/track_api/load_races",{t_id:e,u_ids:t}).done((({data:[s],result:i})=>{i&&this.downloadFile("frhd_ghost_"+e+"-"+t,Object.assign(s.race,{t_id:e,u_id:s.user.u_id}),{desc:"Race"})}))}static downloadTrack(e){return fetch("/track_api/load_track?id="+e+"&fields[]=code&fields[]=id&fields[]=title").then((e=>e.json())).then((({data:{track:e}={},result:t})=>{t&&this.downloadFile(e.title+"-"+e.id,e.code,{desc:"Track"})}))}static async downloadAllTracks(e){return fetch("/u/"+e+"/created?ajax").then((e=>e.json())).then((async({created_tracks:e})=>{let t=new Zip,s=await Promise.all(e.tracks.map((e=>fetch("/track_api/load_track?id="+e.id+"&fields[]=code&fields[]=id&fields[]=title").then((e=>e.json()))))).then((e=>e.filter((({result:e})=>e)).map((({data:e})=>e.track))));for(let e of s)t.newFile(e.title+"-"+e.id+".txt",e.code);this.downloadFile("created-tracks",t.blob(),{desc:"Created"})}))}static async fetchCurrentUser({force:e}={}){const t="frhd-lite.current_user";let s=sessionStorage.getItem(t);if(s&&!e)return JSON.parse(s);let i=await Application.Helpers.AjaxHelper.get("u/"+Application.settings.user.u_name);return sessionStorage.setItem(t,JSON.stringify(i)),i}static users=[];static async fetchUser(e,{force:t}={}){if((e=String(e).toLowerCase())==Application.settings.user.u_id||e==Application.settings.user.u_name)return this.fetchCurrentUser();let s=this.users.find((({user:{u_id:t,u_name:s}})=>t==e||s===e.toLowerCase()));if(s&&!t)return s;let i=await Application.Helpers.AjaxHelper.get("u/"+e);return this.users.push(i),i||null}static fetchComment(e,t){return Application.Helpers.AjaxHelper.post("track_comments/load_more/"+e+"/"+(t+1)).then((e=>e.result&&e.data.track_comments[0]))}static async fetchFeaturedGhosts({force:e}={}){const t="frhd-lite.featured_ghosts";let s=sessionStorage.getItem(t);if(s&&!e)return JSON.parse(s);let i=await fetch("https://raw.githubusercontent.com/calculamatrise/frhd-featured-ghosts/master/data.json").then((e=>e.json()));return sessionStorage.setItem(t,JSON.stringify(i)),i}static async fetchRaceBestDate({force:e}={}){const t="frhd-lite.race_best_dates";let s=JSON.parse(sessionStorage.getItem(t))||{},i=GameSettings.track.id;if(!e&&s[i])return s[i];let a=await fetch(location.pathname+"?ajax").then((e=>e.json())).then((({user_track_stats:{best_date:e}={}}={})=>e));return sessionStorage.setItem(t,JSON.stringify(Object.assign(s,{[i]:a}))),a}static async fetchTrackLastPlayedDate({force:e}={}){const t="frhd-lite.track_last_played_dates";let s=JSON.parse(sessionStorage.getItem(t))||{},i=GameSettings.track.id;if(!e&&s[i])return s[i];let a=await fetch(location.pathname+"?ajax").then((e=>e.json())).then((({user_track_stats:{last_played_date:e}={}}={})=>e));return sessionStorage.setItem(t,JSON.stringify(Object.assign(s,{[i]:a}))),a}static fetchRaceRow(e,{parent:t,placement:s}){const i="https://"+location.host+"/u/"+e.user.d_name.toLowerCase(),a=i+"/pic?sz=50";return t.querySelector("tr.track-leaderboard-race-"+e.user.u_id)||this.createElement("tr",{className:"track-leaderboard-race-"+e.user.u_id+" track-leaderboard-race-row",dataset:{u_id:e.user.u_id,d_name:e.user.d_name,run_time:e.runTime,type:"tas"},children:[this.createElement("td.num",{innerText:s+"."}),this.createElement("td.name",{children:[this.createElement("a.profile-icon",{href:i,title:"View Profile",children:[this.createElement("div.circular",{style:{background:"url("+a+") no-repeat center center",backgroundSize:"100%"},children:[this.createElement("img",{src:a,width:35,height:35,alt:e.user.d_name})]})]}),this.createElement("span.track-leaderboard-race",{innerText:e.user.d_name,title:"Race "+e.user.d_name})]}),document.createElement("td"),this.createElement("td",{innerText:e.runTime,style:{textAlign:"left"}}),this.createElement("td.track-leaderboard-action",{style:{width:"20%"}})]})}static formatRaceTime(e){let t=(e=parseInt(e,10))%6e4/1e3;return Math.floor(e/6e4)+":"+t.toFixed(2).padStart(5,0)}static report(e,t={},{type:s}={}){return Application.settings.user?(t=Object.assign({},t,{t_id:GameSettings.track.id}),window.postMessage({action:"report",data:t,reporter:Application.settings.user,type:s}),Application.Helpers.AjaxHelper.post("track_comments/post",{t_id:t.t_id,msg:e.replace(/{data-(\w+)}/g,((e,s)=>t[s]))+" was reported with frhd-lite. (@Calculus/@Totoca12)"})):alert("You must be logged in to perform this action.")}static verifyRaceData(e){"string"==typeof e.race.code&&(e.race.code=JSON.parse(e.race.code));let t=1=="tas"in e.race.code,s=0;for(let i in e.race.code){if(!/_down$/i.test(i))continue;let a=i.replace(/_\w+$/i,""),r=Object.keys(e.race.code[i]);if(e.race.code[a+"_up"])for(let i of r)e.race.code[a+"_up"][i]>0&&(t=!0,s++)}return s>0&&(t=!0),console.log(e.race.code,s,t),!t}static waitForElm(e,t){return new Promise(((s,i)=>{let a=document.querySelector(e);if(a)return s(a);new MutationObserver(((t,i)=>{t.find((({addedNodes:e})=>e.length>0))&&(a=document.querySelector(e),a&&(s(a),i.disconnect()))})).observe(document.body,{childList:!0,subtree:!0}),t&&setTimeout(i,t,new Error("Operation timed out"))}))}};const o=class{x=0;y=0;constructor(e,t){this.x=e,this.y=t}toReal(e){let t=e.camera,s=e.screen,i=(this.x-s.center.x)/t.zoom+t.position.x,a=(this.y-s.center.y)/t.zoom+t.position.y;return new this.constructor(i,a)}toScreen(e){let t=e.camera,s=e.screen,i=(this.x-t.position.x)*t.zoom+s.center.x,a=(this.y-t.position.y)*t.zoom+s.center.y;return new this.constructor(i,a)}lenSqr(){return this.dot(this)}len(){return Math.sqrt(this.lenSqr())}dot(e){return this.x*e.x+this.y*e.y}factor(e){return new this.constructor(this.x*e,this.y*e)}factorSelf(e){this.x*=e,this.y*=e}factorOut(e,t){t.x=this.x*e,t.y=this.y*e}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}inc(e){this.x+=e.x,this.y+=e.y}addOut(e,t){t.x=this.x+e.x,t.y=this.y+e.y}sub(e){return new this.constructor(this.x-e.x,this.y-e.y)}subOut(e,t){t.x=this.x-e.x,t.y=this.y-e.y}subSelf(e){this.x-=e.x,this.y-=e.y}equ(e){this.x=e.x,this.y=e.y}normalize(){let e=Math.sqrt(this.x**2+this.y**2);return new this.constructor(this.x/e,this.y/e)}getAngleInDegrees(e){let t=e.sub(this),s=Math.atan2(t.x,-t.y)*(180/Math.PI);return s<0&&(s+=360),s}getAngleInRadians(e){let t=e.sub(this);return Math.atan2(t.x,-t.y)}},n=class{sectors=[];p1=null;p2=null;pp=null;len=0;collided=!1;highlight=!1;recorded=!1;remove=!1;type="scenery";constructor(e,t,s,i){Object.defineProperties(this,{recorded:{enumerable:!1},remove:{enumerable:!1},sectors:{enumerable:!1}}),this.p1=new o(e,t),this.p2=new o(s,i),this.pp=this.p2.sub(this.p1),this.len=this.pp.len()}move(e,t){return this.p1.x+=0|parseInt(e),this.p1.y+=0|parseInt(t),this.p2.x+=0|parseInt(e),this.p2.y+=0|parseInt(t),this}getCode(e){this.recorded=!0;let t=this.p2,s=" "+t.x.toString(32)+" "+t.y.toString(32),i=this.checkForConnectedLine(e,t);return i&&(s+=i.getCode(e)),s}checkForConnectedLine(e,t){let s=e.settings.drawSectorSize,i=e.sectors.drawSectors,a=Math.floor(t.x/s),r=Math.floor(t.y/s);return i[a][r].searchForLine(this.type+"Lines",t)}erase(e,t){let s=!1;if(!this.remove){let i=this.p1,a=this.p2.sub(i),r=i.sub(e),o=a.dot(a),n=2*r.dot(a),h=n*n-4*o*(r.dot(r)-t**2);if(h>0){h=Math.sqrt(h);let e=(-n-h)/(2*o),t=(-n+h)/(2*o);e>=0&&1>=e&&(s=!0,this.removeAllReferences()),t>=0&&1>=t&&(s=!0,this.removeAllReferences())}(this.intersects(this.p1.x,this.p1.y,e.x,e.y,t)||this.intersects(this.p2.x,this.p2.y,e.x,e.y,t))&&(s=!0,this.removeAllReferences())}return s}intersects(e,t,s,i,a){return a**2>=(e-s)**2+(t-i)**2}addSectorReference(e){this.sectors.push(e)}removeAllReferences(){this.remove=!0;for(let e of this.sectors)e.drawn=!1,e.dirty=!0;this.sectors=[]}},h=class extends n{type="physics";collide(e){if(this.collided)return;this.collided=!0;let t=e.pos,s=e.vel,i=e.radius,a=0,r=0,o=0,n=this.p1,h=this.p2,l=t.x-n.x,c=t.y-n.y,d=this.pp,p=this.len,u=(l*d.x+c*d.y)/p/p;if(u>=0&&1>=u){let a=(l*d.y-c*d.x)*((l-s.x)*d.y-(c-s.y)*d.x)<0?-1:1,r=l-d.x*u,n=c-d.y*u;if(o=Math.sqrt(Math.pow(r,2)+Math.pow(n,2)),0===o&&(o=1),i>o||0>a){let s=(i*a-o)/o;return t.x+=r*s,t.y+=n*s,void e.drive(-n/o,r/o)}}if(!(-i>u*p||u*p>p+i)){let s=u>0?h:n;if(a=t.x-s.x,r=t.y-s.y,o=Math.sqrt(Math.pow(a,2)+Math.pow(r,2)),0===o&&(o=1),i>o){let s=(i-o)/o;return t.x+=a*s,t.y+=r*s,void e.drive(-r/o,a/o)}}}},l=class{scene=null;duplicates=0;color="#FFF";x=0;y=0;name=null;sector=null;settings=null;outline="#000";remove=!1;constructor(e,t){let s=arguments[arguments.length-1];this.game=s.scene.game,this.scene=s.scene,this.settings=this.game.settings,this.x=e,this.y=t,this.remove=!1}addSectorReference(e){this.sector=e}collide(e){let t=e.pos.x-this.x,s=e.pos.y-this.y,i=Math.sqrt(t**2+s**2);!this.hit&&26>i&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1)}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);let a=this.constructor.cache.width*s,r=this.constructor.cache.height*s,o=a/2,n=r/2;i.drawImage(this.constructor.cache.canvas,e-o,t-n,a,r)}erase(e,t){let s=!1;return this.remove||t>=Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2))&&(s=[this],this.removeAllReferences()),s}getCode(){let e="";return this.prefix&&(e=this.prefix+" "),e+this.x.toString(32)+" "+this.y.toString(32)}move(e,t){return this.x+=0|parseInt(e),this.y+=0|parseInt(t),this}recache(e){this.setDirty(!1);let t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;let s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawPowerup(i,a,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}removeAllReferences(){this.remove=!0,this.sector&&(this.sector.powerupCanvasDrawn=!1,this.sector.dirty=!0,this.sector=null),this.scene.track.cleanPowerups()}setDirty(e){this.constructor.cache.dirty=e}static canvasPool=new Set;static createCache(){let e={canvas:document.createElement("canvas"),dirty:!0,width:25,height:25};return this.canvasPool.add(e),e}},c=class extends l{color="#08faf3";name="antigravity";prefix="A";constructor(e,t,s){super(s),this.x=e,this.y=t}collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y;1e3>Math.pow(i,2)+Math.pow(a,2)&&s.isAlive()&&(!1===s.isGhost()&&((0!=t.gravity.x||0!=t.gravity.y)&&this.scene.sound.play("antigravity_sound",.3),this.scene.message.show("Antigravity Engaged",50,this.color)),t.gravity.x=0,t.gravity.y=0)}drawPowerup(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),s*=.5,i.save(),i.scale(s,s),i.fillStyle=this.color,i.strokeStyle=a,i.lineWidth=3,i.beginPath(),i.arc(25,25,11-i.lineWidth/2,0,2*Math.PI,!0),i.fill(),i.stroke(),i.beginPath(),i.moveTo(3,29.3196417),i.bezierCurveTo(4.74079001,38.2359804,11.7640196,45.2589035,20.6800518,46.9996935),i.lineTo(20.6800518,40.7043471),i.bezierCurveTo(15.1649961,39.1854465,10.814247,34.8350039,9.29534642,29.3196417),i.closePath(),i.moveTo(47,20.6803583),i.bezierCurveTo(45.25921,11.7640196,38.2362869,4.74079001,29.3196417,3),i.lineTo(29.3196417,9.29534642),i.bezierCurveTo(34.8350039,10.814247,39.185753,15.1646897,40.7046536,20.6803583),i.closePath(),i.moveTo(9.29534642,20.6803583),i.bezierCurveTo(10.814247,15.1646897,15.1649961,10.814247,20.6800518,9.29534642),i.lineTo(20.6800518,3),i.bezierCurveTo(11.7640196,4.74109649,4.74079001,11.7640196,3,20.6803583),i.closePath(),i.moveTo(29.3196417,46.9996935),i.bezierCurveTo(38.2362869,45.2589035,45.25921,38.2359804,47,29.3196417),i.lineTo(40.7046536,29.3196417),i.bezierCurveTo(39.185753,34.8350039,34.8350039,39.1854465,29.3196417,40.7043471),i.closePath(),i.lineWidth=5,i.stroke(),i.fill(),i.restore()}static cache=this.createCache()},d=class extends l{color="#d12929";hit=!1;name="bomb";prefix="O";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y;20>Math.sqrt(Math.pow(i,2)+Math.pow(a,2))&&s.isAlive()&&(t.explode(),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1))}draw(...e){this.hit||super.draw(...e)}drawPowerup(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),s*=.2,i.fillStyle=a,i.strokeStyle=a,i.lineWidth=8*s,i.beginPath(),i.moveTo(53*s,105*s),i.lineTo(41.5*s,115*s),i.lineTo(43*s,100*s),i.bezierCurveTo(35.5*s,95*s,30*s,88.5*s,26.5*s,80*s),i.lineTo(11*s,78*s),i.lineTo(24*s,69.5*s),i.bezierCurveTo(24*s,68*s,24*s,67*s,24*s,66*s),i.bezierCurveTo(24*s,58.5*s,26*s,51*s,30*s,45*s),i.lineTo(22*s,31.5*s),i.lineTo(37.5*s,36*s),i.bezierCurveTo(43.5*s,31*s,51*s,27.5*s,60*s,26*s),i.lineTo(66*s,11*s),i.lineTo(72*s,26.5*s),i.bezierCurveTo(80.5*s,27.5*s,88*s,31*s,93.5*s,36.5*s),i.lineTo(110*s,31.5*s),i.lineTo(101.5*s,46*s),i.bezierCurveTo(105*s,52*s,107*s,59*s,107*s,66*s),i.bezierCurveTo(107*s,67*s,107*s,68*s,107*s,69*s),i.lineTo(121*s,78*s),i.lineTo(104.5*s,80.5*s),i.bezierCurveTo(101.5*s,88*s,96*s,95*s,89*s,99.5*s),i.lineTo(90.5*s,115*s),i.lineTo(78.5*s,104.5*s),i.bezierCurveTo(74.5*s,106*s,70*s,107*s,65.5*s,107*s),i.bezierCurveTo(61*s,107*s,57*s,106*s,53*s,105*s),i.lineTo(53*s,105*s),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.arc(66*s,66*s,40*s,0*s,2*Math.PI,!0),i.lineWidth=2*s,i.fillStyle=this.color,i.fill(),i.stroke(),i.beginPath(),i.arc(66*s,66*s,8*s,0*s,2*Math.PI,!0),i.fillStyle=a,i.fill(),i.stroke()}static cache=Object.assign(this.createCache(),{width:26,height:26})},p=class extends l{angle=null;color="#8ac832";name="boost";prefix="B";realAngle=0;directionX=0;directionY=0;constructor(e,t,s,i){super(e,t,i),this.angle=s,this.realAngle=s;let a=(s-180)/360*2*Math.PI;this.directionX=(-Math.sin(a)).toFixed(15)/1,this.directionY=Math.cos(a).toFixed(15)/1}collide(e){let t=e.parent,s=t.player,i=(e.pos.x-this.x)**2+(e.pos.y-this.y)**2,a=t.masses,r=a.length;if(1e3>i&&s.isAlive()){for(let e=0;e<1+this.duplicates;e++)for(var o=r-1;o>=0;o--){var n=a[o].pos;n.x+=this.directionX,n.y+=this.directionY}!1===s.isGhost()&&(this.scene.sound.play("boost_sound"),this.scene.message.show("Boost Engaged",50,this.color))}}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);let a=this.constructor.cache.width*s,r=this.constructor.cache.height*s,o=a/2,n=r/2,h=(this.angle-90)*(Math.PI/180);i.translate(e,t),i.rotate(h),i.drawImage(this.constructor.cache.canvas,-o,-n,a,r),i.rotate(-h),i.translate(-e,-t)}drawPowerup(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),s*=.2,i.save(),i.fillStyle=this.color,i.strokeStyle=a,i.lineWidth=Math.max(8*s,1),i.beginPath(),i.moveTo(8*s,4*s),i.lineTo(39*s,4*s),i.lineTo(70*s,40*s),i.lineTo(38*s,76*s),i.lineTo(8*s,76*s),i.lineTo(40*s,39*s),i.closePath(),i.moveTo(57*s,4*s),i.lineTo(89*s,4*s),i.lineTo(120*s,40*s),i.lineTo(88*s,76*s),i.lineTo(58*s,76*s),i.lineTo(89*s,39*s),i.closePath(),i.fill(),i.stroke()}getCode(){return super.getCode()+" "+this.realAngle.toString(32)}static cache=Object.assign(this.createCache(),{width:25,height:16})},u=class extends l{color="#826cdc";hit=!1;id=crypto.randomUUID();name="checkpoint";prefix="C";draw(e,t,s,i){i.save(),this.hit&&(i.globalAlpha=.3),super.draw(e,t,s,i),i.restore()}drawPowerup(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),s*=.15,i.save(),i.fillStyle=this.color,i.strokeStyle=a,i.lineWidth=8*s,i.beginPath(),i.moveTo(4*s,11*s),i.bezierCurveTo(4*s,11*s,34.5*s,28*s,56*s,11*s),i.bezierCurveTo(77*s,-5*s,109*s,11*s,109*s,11*s),i.lineTo(110*s,87*s),i.bezierCurveTo(110*s,87*s,75*s,74.5*s,57.5*s,87*s),i.bezierCurveTo(41*s,99*s,4*s,89.5*s,4*s,89.5*s),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.lineWidth=10*s,i.moveTo(5*s,11*s),i.lineTo(5*s,181*s),i.stroke(),i.restore()}collide(e){let t=e.parent.player,s=e.pos.x-this.x,i=e.pos.y-this.y,a=Math.sqrt(Math.pow(s,2)+Math.pow(i,2)),r=t._powerupsConsumed.checkpoints;26>a&&t.isAlive()&&-1===r.indexOf(this.id)&&(r.push(this.id),t.setCheckpointOnUpdate(),!1===t.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Checkpoint Saved",50,this.color,"#FFFFFF"),this.scene.sound.play("checkpoint_sound")))}static cache=Object.assign(this.createCache(),{width:18,height:28})},m=class extends l{angle=null;color="#376eb7";name="gravity";prefix="G";realAngle=0;constructor(e,t,s,i){super(e,t,i),this.angle=s-180,this.realAngle=s;let a=this.angle/360*2*Math.PI;this.directionX=(-.3*Math.sin(a)).toFixed(15)/1,this.directionY=(.3*Math.cos(a)).toFixed(15)/1}collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,r=Math.pow(i,2)+Math.pow(a,2),o=(t.masses,this.directionX),n=this.directionY;1e3>r&&s.isAlive()&&(t.gravity.x=o,t.gravity.y=n,!1===s.isGhost()&&(this.scene.message.show("Gravity Changed",50,"#1F80C3","#FFFFFF"),this.scene.sound.play("gravity_down_sound")))}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);let a=this.constructor.cache.width*s,r=this.constructor.cache.height*s,o=a/2,n=r/2,h=(this.angle+90)*(Math.PI/180);i.translate(e,t),i.rotate(h),i.drawImage(this.constructor.cache.canvas,-o,-n,a,r),i.rotate(-h),i.translate(-e,-t)}drawPowerup(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),s*=.2,i.lineJoin="round",i.save(),i.lineWidth=Math.max(6*s,1),i.fillStyle=this.color,i.strokeStyle=a,i.beginPath(),i.moveTo(45*s,70*s),i.lineTo(45*s,95*s),i.lineTo(97*s,50*s),i.lineTo(45*s,5*s),i.lineTo(45*s,30*s),i.lineTo(3*s,30*s),i.lineTo(3*s,70*s),i.closePath(),i.fill(),i.stroke(),i.restore()}getCode(){return super.getCode()+" "+this.realAngle.toString(32)}static cache=Object.assign(this.createCache(),{width:20,height:20})},g=class extends l{name="slowmo";prefix="S";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y;26>Math.sqrt(Math.pow(i,2)+Math.pow(a,2))&&s.isAlive()&&(t.slow=!0,!1===s.isGhost()&&(this.scene.sound.play("slowmo_sound"),this.scene.message.show("Slow Motion",50,this.color,"#000000")))}drawPowerup(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),s*=.24,i.save(),i.scale(s,s),i.beginPath(),i.strokeStyle=a,i.lineWidth=3,i.arc(50,50,50-i.lineWidth/2,0,2*Math.PI),i.stroke(),i.beginPath(),i.arc(50,50,42.5-i.lineWidth/2,0,2*Math.PI),i.stroke(),i.beginPath(),i.lineWidth=5,i.moveTo(70,50),i.lineTo(50,50),i.lineTo(30,20),i.moveTo(92.5,50),i.lineTo(82.5,50),i.moveTo(50,7.5),i.lineTo(50,17.5),i.moveTo(50,92.5),i.lineTo(50,82.5),i.moveTo(7.5,50),i.lineTo(17.5,50),i.stroke(),i.restore()}static cache=Object.assign(this.createCache(),{width:26,height:24})},y=class extends l{color="#FAE335";name="goal";hit=!1;id=crypto.randomUUID();prefix="T";cacheStar(e){let t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;let s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawStar(i,a,5,10,5,!0,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}cacheEmptyStar(e){let t=this.constructor.hitCache.canvas;t.width=this.constructor.hitCache.width*e,t.height=this.constructor.hitCache.height*e;let s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawStar(i,a,5,10,5,!1,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}collide(e){let t=e.parent.player,s=e.pos.x-this.x,i=e.pos.y-this.y,a=Math.sqrt(s**2+i**2),r=t._powerupsConsumed.targets,o=this.scene;if(26>a&&t.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);let e=r.length,s=o.track.targetCount;if(!1===t.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,o.sound.play("goal_sound"),o.message.show(e+" of "+s+" Stars",50,this.color,"#666")),e>=s&&(t.complete=!0),t.isGhost()){let i=this.scene.raceTimes.container.children.find((({data:e})=>e.user.u_id===t._user.u_id));i&&i.children.length>0&&(i.children[i.children.length-1].text=e+"/"+s,this.scene.raceTimes.redraw())}}}draw(e,t,s,i){let a=this.constructor.hitCache;this.hit||(a=this.constructor.cache,a.dirty&&this.recache(s));let r=a.width*s,o=a.height*s,n=r/2,h=o/2;i.drawImage(a.canvas,e-n,t-h,r,o)}drawStar(e,t,s,i,a,r,o,n){let h=Math.PI/2*3,l=e,c=t,d=Math.PI/s;i*=o,a*=o,n.beginPath(),n.moveTo(e,t-i);for(let r=0;s>r;r++)l=e+Math.cos(h)*i,c=t+Math.sin(h)*i,n.lineTo(l,c),h+=d,l=e+Math.cos(h)*a,c=t+Math.sin(h)*a,n.lineTo(l,c),h+=d;n.lineTo(e,t-i),n.closePath(),n.lineWidth=Math.max(2*o,1),n.strokeStyle=/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,n.stroke(),n.fillStyle=r?this.color:"#FFFFFF",n.fill()}recache(e){this.setDirty(!1),this.cacheStar(e),this.cacheEmptyStar(e)}static cache=Object.assign(this.createCache(),{width:35,height:35});static hitCache=Object.assign(this.createCache(),{width:35,height:35})},f=class extends l{color="#dd45ec";hit=!1;id=crypto.randomUUID();otherPortal=null;name="teleport";prefix="W";recorded=!1;addOtherPortalRef(e){this.otherPortal=e}collide(e){let t=e.parent,s=t.player,i=s._powerupsConsumed.misc;-1===i.indexOf(this.id)&&1e3>(e.pos.x-this.x)**2+(e.pos.y-this.y)**2&&s.isAlive()&&(i.push(this.id),i.push(this.otherPortal.id),t.moveVehicle(this.otherPortal.x-this.x,this.otherPortal.y-this.y),!1===s.isGhost()&&(this.hit=!0,this.otherPortal.hit=!0,this.sector.powerupCanvasDrawn=!1,this.otherPortal.sector.powerupCanvasDrawn=!1,this.scene.sound.play("teleport_sound",.3),this.scene.message.show("Teleport Engaged",50,this.color)))}draw(e,t,s,i){i.save(),i.globalAlpha=!1===this.hit?1:.2,super.draw(e,t,s,i),i.restore()}drawPowerup(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),s*=.64,i.save(),i.scale(s,s),i.translate(2.6,3),i.fillStyle=this.color,i.strokeStyle=a,i.lineWidth=5,i.beginPath(),i.moveTo(23.9052288,5.91261647),i.bezierCurveTo(23.9052288,5.91261647,22.5543791,5.13614588,18.1099346,5.04995765),i.bezierCurveTo(13.6479739,5.05021647,9.39411765,6.99424,5.93111111,10.2266871),i.bezierCurveTo(2.88431373,13.0698635,.969542484,16.6517224,.241437908,20.8723576),i.bezierCurveTo(.0837908497,22.1227341,.0816993464,22.1341224,.0796078431,22.1452518),i.bezierCurveTo(.0929411765,25.8184753,.118562092,26.0470165,.145751634,26.2752988),i.bezierCurveTo(.550457516,29.6511341,1.80196078,32.7860047,3.86601307,35.59424),i.bezierCurveTo(4.76326797,36.8153694,6.27176471,38.4928047,7.6179085,39.4864282),i.bezierCurveTo(7.6179085,39.4864282,13.4911111,44.3481694,22.5543791,43.7872988),i.bezierCurveTo(16.5849673,39.6461224,15.7624837,37.5460282,15.7624837,37.5460282),i.bezierCurveTo(16.4521569,37.6208282,18.1535948,38.5391341,21.868366,38.5391341),i.bezierCurveTo(27.0628758,38.5391341,31.7535948,36.2909929,35.4330719,32.0377459),i.bezierCurveTo(37.5739869,29.5631341,38.9739869,26.6037459,39.5941176,23.2421459),i.lineTo(39.8856209,21.2448047),i.bezierCurveTo(39.7975163,18.0607576,39.7695425,17.8096988,39.7394771,17.5591576),i.bezierCurveTo(39.3355556,14.1864282,38.0845752,11.0515576,36.0215686,8.24176941),i.bezierCurveTo(34.9975163,6.84826353,33.8019608,5.59038118,32.4675817,4.50202824),i.bezierCurveTo(32.4675817,4.50202824,25.996732,-1.07536,16.5653595,.558592941),i.bezierCurveTo(21.6393464,2.28934588,23.9052288,5.91261647,23.9052288,5.91261647),i.stroke(),i.fill(),i.fillStyle=/^(dark(er)|midnight)?$/i.test(lite.storage.get("theme"))?"#1e1e1e":"#fefefe",i.beginPath(),i.moveTo(5.22875817,24.6992965),i.lineTo(5.22875817,23.0451553),i.bezierCurveTo(5.24078431,22.97812,5.25647059,22.9113435,5.26457516,22.8437906),i.bezierCurveTo(5.30823529,22.4770376,5.33254902,22.1071788,5.39555556,21.7440494),i.bezierCurveTo(5.9179085,18.7173671,7.26117647,16.0988494,9.5179085,13.9930612),i.bezierCurveTo(12.7882353,10.9404965,16.6520261,9.83428471,21.0614379,10.8020259),i.bezierCurveTo(23.1579085,11.2619553,24.9563399,12.2887082,26.3997386,13.8804729),i.bezierCurveTo(27.8005229,15.4251318,28.5681046,17.2482847,28.8130719,19.3033435),i.bezierCurveTo(29.0044444,20.9103788,28.7861438,22.4467553,28.0836601,23.9122141),i.bezierCurveTo(26.5186928,27.1764965,23.3458824,28.74652,19.8862745,27.9666847),i.bezierCurveTo(17.6018301,27.4518847,16.0658824,25.7762612,15.7793464,23.4833435),i.bezierCurveTo(15.7513725,23.2566141,15.7422222,23.0278141,15.7233987,22.7920259),i.bezierCurveTo(15.6826144,22.7959082,15.6577778,22.7959082,15.6345098,22.8013435),i.bezierCurveTo(15.2580392,22.8929671,15.0844444,23.1867318,14.9532026,23.5037906),i.bezierCurveTo(14.6407843,24.2592965,14.6128105,25.0383553,14.8180392,25.8238847),i.bezierCurveTo(15.1252288,26.9999788,15.8075817,27.9480494,16.7301961,28.7162376),i.bezierCurveTo(19.105098,30.6939082,21.8201307,31.2356259,24.7777778,30.3869435),i.bezierCurveTo(27.9027451,29.4903788,30.1628758,27.5002847,31.6556863,24.6703082),i.bezierCurveTo(33.1751634,21.7893435,33.4169935,18.73652,32.7003922,15.5969906),i.bezierCurveTo(32.1134641,13.0263553,30.9056209,10.7471553,29.2807843,8.67397882),i.bezierCurveTo(29.2345098,8.61496706,29.1887582,8.55595529,29.1427451,8.49694353),i.bezierCurveTo(30.1487582,9.31767294,31.0295425,10.2476259,31.7918954,11.2855082),i.bezierCurveTo(33.305098,13.3460024,34.2433987,15.6329671,34.5471895,18.1681435),i.bezierCurveTo(34.5856209,18.4903788,34.6206536,18.8131318,34.6569935,19.1356259),i.lineTo(34.6569935,20.7897671),i.bezierCurveTo(34.6449673,20.8565435,34.629281,20.92332,34.620915,20.9908729),i.bezierCurveTo(34.5644444,21.4313906,34.5309804,21.8763082,34.4501961,22.3121671),i.bezierCurveTo(34.0122876,24.6873906,33.0475817,26.8374376,31.4616993,28.6706847),i.bezierCurveTo(28.1134641,32.5408729,23.9121569,34.11012,18.8256209,33.0287553),i.bezierCurveTo(16.5994771,32.5553671,14.72,31.4287082,13.2504575,29.68372),i.bezierCurveTo(11.9879739,28.1846141,11.2983007,26.4463553,11.0705882,24.5126847),i.bezierCurveTo(10.871634,22.8236024,11.1286275,21.2212259,11.9113725,19.7042612),i.bezierCurveTo(13.5228758,16.5810376,16.6386928,15.0982376,19.9803922,15.8646141),i.bezierCurveTo(22.303268,16.3975318,23.7997386,18.0288965,24.1079739,20.3696965),i.bezierCurveTo(24.136732,20.5899553,24.1440523,20.8128024,24.1662745,21.1008729),i.bezierCurveTo(24.343268,20.9921671,24.5147712,20.9334141,24.6146405,20.8153906),i.bezierCurveTo(24.7620915,20.6414612,24.8909804,20.4375082,24.970719,20.2255318),i.bezierCurveTo(25.28,19.4032494,25.2648366,18.5688024,24.9890196,17.7405671),i.bezierCurveTo(24.5738562,16.4935553,23.7654902,15.5263318,22.715817,14.7615082),i.bezierCurveTo(20.315817,13.0147082,17.6664052,12.6334612,14.8541176,13.5207082),i.bezierCurveTo(11.8538562,14.4672259,9.67267974,16.4187553,8.23006536,19.1622847),i.bezierCurveTo(6.68470588,22.1014847,6.45960784,25.2078847,7.22352941,28.3996965),i.bezierCurveTo(7.82248366,30.8996729,9.0096732,33.1206376,10.5921569,35.1438612),i.bezierCurveTo(10.6420915,35.2083082,10.692549,35.2724965,10.743268,35.3364259),i.bezierCurveTo(9.97568627,34.7698612,8.83764706,33.5606376,8.09385621,32.5486376),i.bezierCurveTo(6.57986928,30.4886612,5.6420915,28.2016965,5.33830065,25.66652),i.bezierCurveTo(5.29960784,25.3442847,5.26535948,25.0215318,5.22875817,24.6992965),i.fill(),i.restore()}erase(e,t){let s=!1;return this.remove||t>=Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2))&&(s=[this,this.otherPortal],this.removeAllReferences(),this.otherPortal.removeAllReferences()),s}getCode(){let e="";return!1===this.recorded&&!0===this.otherPortal.recorded?this.recorded=!0:!1===this.recorded&&!1===this.otherPortal.recorded?(this.recorded=!0,e=super.getCode()+" "+this.otherPortal.x.toString(32)+" "+this.otherPortal.y.toString(32)):!0===this.recorded&&!0===this.otherPortal.recorded&&(this.otherPortal.recorded=!1,e=super.getCode()+" "+this.otherPortal.x.toString(32)+" "+this.otherPortal.y.toString(32)),e}move(e,t){return this.otherPortal.x+=0|parseInt(e),this.otherPortal.y+=0|parseInt(t),super.move(e,t)}static cache=Object.assign(this.createCache(),{width:29,height:32})},w=class{scene=null;settings=null;drawSectorSize=null;row=0;column=0;camera=null;zoom=0;x=0;y=0;realX=0;realY=0;physicsLines=[];sceneryLines=[];canvasPool=null;canvas=null;ctx=null;dirty=!1;drawn=!1;hasPowerups=!1;lineCount=0;powerupCanvas=null;powerupCanvasOffset=35;powerupCanvasDrawn=!1;powerups={all:[],goals:[],gravitys:[],boosts:[],slowmos:[],checkpoints:[],bombs:[],antigravitys:[],teleports:[],helicopters:[],trucks:[],balloons:[],blobs:[]};powerupsCount=0;constructor(e,t,s){this.track=s,this.scene=s.scene,this.settings=s.settings,this.drawSectorSize=this.settings.drawSectorSize,this.row=t,this.column=e,this.camera=s.camera,this.zoom=s.camera.zoom,this.canvasPool=s.canvasPool,this.x=e*this.drawSectorSize,this.y=t*this.drawSectorSize,this.realX=this.x*this.zoom,this.realY=this.y*this.zoom}addLine(e){e instanceof h&&this.physicsLines.push(e),e instanceof n&&this.sceneryLines.push(e),this.lineCount++,this.drawn=!1}searchForLine(e,t){return this[e].find((e=>e.p1.x===t.x&&e.p1.y===t.y&&!e.recorded&&!e.remove))}addPowerup(e){this.powerups.all.push(e),["goal","gravity","slowmo","boost","checkpoint","bomb","antigravity","teleport","helicopter","truck","balloon","blob"].includes(e.name)&&this.powerups[e.name+"s"].push(e),this.powerupsCount++,this.hasPowerups=!0,this.powerupCanvasDrawn=!1}cachePowerupSector(){if(this.powerupCanvasDrawn=!0,this.powerups.all.length>0){this.powerupCanvas=this.canvasPool.getCanvas(),this.powerupCanvas.width=this.drawSectorSize*this.scene.camera.zoom+this.powerupCanvasOffset*this.scene.camera.zoom|0,this.powerupCanvas.height=this.drawSectorSize*this.scene.camera.zoom+this.powerupCanvasOffset*this.scene.camera.zoom|0;let e=this.powerupCanvas.getContext("2d");e.clearRect(0,0,this.powerupCanvas.width,this.powerupCanvas.height),this.drawPowerups(this.powerups.slowmos,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.checkpoints,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.boosts,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.gravitys,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.bombs,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.goals,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.antigravitys,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.teleports,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.helicopters,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.trucks,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.balloons,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.blobs,this.scene.camera.zoom,e),this.settings.developerMode&&(e.beginPath(),e.strokeStyle="red",e.rect(0,0,this.powerupCanvas.width,this.powerupCanvas.height),e.stroke())}}createCanvas(){this.canvas=this.canvasPool.getCanvas(),this.canvas.width=this.drawSectorSize*this.scene.camera.zoom|0,this.canvas.height=this.drawSectorSize*this.scene.camera.zoom|0,this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineWidth=Math.max(2*this.scene.camera.zoom,.5)}cleanSector(){this.cleanSectorType("physicsLines"),this.cleanSectorType("sceneryLines"),this.cleanSectorType("powerups","all"),0===this.powerups.all.length?(this.hasPowerups=!1,this.powerupCanvas&&(this.canvasPool.releaseCanvas(this.powerupCanvas),this.powerupCanvas=null)):this.hasPowerups=!0,this.dirty=!1}cleanSectorType(e,t){let s=this[e];t&&(s=s[t]);for(let e=s.length-1;e>=0;e--)s[e].remove&&s.splice(e,1)}draw(){!this.canvas&&this.createCanvas(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.beginPath(),this.ctx.strokeStyle=this.settings.sceneryLineColor,this.drawLines(this.sceneryLines,this.scene.camera.zoom,this.ctx),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle=this.settings.physicsLineColor,this.drawLines(this.physicsLines,this.scene.camera.zoom,this.ctx),this.ctx.stroke(),this.settings.developerMode&&(this.ctx.beginPath(),this.ctx.strokeStyle="blue",this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.stroke()),this.drawn=!0}drawLine(e,t){!this.canvas&&this.createCanvas(),this.ctx.beginPath(),this.ctx.strokeStyle=t,this.ctx.moveTo((e.p1.x-this.x)*this.scene.camera.zoom,(e.p1.y-this.y)*this.scene.camera.zoom),this.ctx.lineTo((e.p2.x-this.x)*this.scene.camera.zoom,(e.p2.y-this.y)*this.scene.camera.zoom),this.ctx.stroke()}erase(e,t,s){let i=[];if(!0===s.physics)for(let s of this.physicsLines.filter((s=>s.erase(e,t))))i.push(s);if(!0===s.scenery)for(let s of this.sceneryLines.filter((s=>s.erase(e,t))))i.push(s);if(!0===s.powerups)for(let s of this.powerups.all){let a=s.erase(e,t);a&&i.push(...a)}return i}update(){this.realX=this.x*this.camera.zoom|0,this.realY=this.y*this.camera.zoom|0,this.zoom=this.camera.zoom}resetCollided(){let e=this.physicsLines.filter((e=>e.collided));for(let t=e.length-1;t>=0;t--)e[t].collided=!1}collide(e){let t=this.physicsLines.filter((e=>!e.collided));for(let s=t.length-1;s>=0;s--)t[s].remove?this.physicsLines.splice(this.physicsLines.indexOf(t[s]),1):t[s].collide(e);if(e.parent.powerupsEnabled){let t=e.parent.player,s=this.powerups.all.filter((e=>-1===t._powerupsConsumed.misc.indexOf(e.id)));!t.isGhost()&&(s=s.filter((e=>!e.hit)));for(let t=s.length-1;t>=0;t--)s[t].remove?this.powerups.all.splice(this.powerups.all.indexOf(s[t]),1):s[t].collide(e)}}drawLines(e,t,s){for(let i in e)e[i].remove?e.splice(i,1):(s.moveTo((e[i].p1.x-this.x)*t,(e[i].p1.y-this.y)*t),s.lineTo((e[i].p2.x-this.x)*t,(e[i].p2.y-this.y)*t))}drawPowerups(e,t,s){let i=e.reduce(((e,t)=>{let s=e.filter((e=>e.name===t.name&&e.x===t.x&&e.y===t.y));switch(t.prefix){case"B":case"G":s=s.filter((e=>e.angle===t.angle));break;case"C":case"O":case"T":case"V":s=s.filter((e=>e.hit===t.hit))}return s.length>0||e.push(t),e}),[]);for(let a of i)a.remove?e.splice(e.indexOf(a),1):a.draw((a.x-this.x)*t+this.powerupCanvasOffset*t/2,(a.y-this.y)*t+this.powerupCanvasOffset*t/2,t,s)}drawBackground(e,t,s){e.beginPath(),e.rect(0,0,this.drawSectorSize*t|0,this.drawSectorSize*t|0),e.fillStyle=s,e.fill()}clear(){this.drawn=!1,this.powerupCanvasDrawn=!1,this.canvas&&(this.canvasPool.releaseCanvas(this.canvas),this.canvas=null,this.ctx=null),this.powerupCanvas&&(this.canvasPool.releaseCanvas(this.powerupCanvas),this.powerupCanvas=null)}close(){this.track=null,this.scene=null,this.settings=null,this.drawSectorSize=null,this.row=null,this.column=null,this.camera=null,this.zoom=null,this.canvasPool=null,this.x=null,this.y=null,this.realX=null,this.realY=null,this.lineCount=null,this.drawn=null,this.physicsLines=null,this.sceneryLines=null,this.canvas=null,this.ctx=null}},x=class extends l{hit=!1;index=null;prefix="V";stack=[];constructor(e,t,s,i){super(i),this.x=e,this.y=t,this.time=s,this.id=Math.random().toString(36).slice(2)}draw(e,t,s,i){this.hit||super.draw(e,t,s,i)}getCode(){let e=this.time,t=super.getCode()+" "+this.index+" ",s="";return this.stack.length>0&&(s+=","+this.stack.map((e=>t+e.toString(32))).join(","),e-=this.stack.reduce(((e,t)=>e+t),0)),t+e.toString(32)+s}recache(e){this.constructor.cache.dirty=!1;let t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;let s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawIcon(i,a,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}static createCache(){return Object.assign(super.createCache(),{width:24,height:24})}},v=class extends x{color="#f02728";index=3;name="balloon";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,r=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),o=s._powerupsConsumed.misc,n=this.scene;if(30>r&&s.isAlive()&&-1===o.indexOf(this.id)){o.push(this.id);let e=this.time*n.settings.drawFPS;s.setTempVehicle(this.name.toUpperCase(),e,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Balloon Powerup!",50,this.color,!1))}}drawIcon(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),i.save(),i.scale(s,s),i.lineWidth=2,i.strokeStyle=a,i.fillStyle=a,i.beginPath(),i.roundRect(6,23,9,8,1),i.fill(),i.fillStyle=this.color,i.beginPath(),i.arc(10.5,10.5,10.5-i.lineWidth/2,0,2*Math.PI,!0),i.fill(),i.moveTo(15,18.5),i.lineTo(13,24),i.moveTo(8,24),i.lineTo(6,18.5),i.stroke(),i.restore()}static cache=Object.assign(this.createCache(),{width:21,height:31})},b=class extends x{color="#a784c5";index=4;name="blob";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,r=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),o=s._powerupsConsumed.misc,n=this.scene;if(30>r&&s.isAlive()&&-1===o.indexOf(this.id)){o.push(this.id);var h=this.time*n.settings.drawFPS;s.setTempVehicle(this.name.toUpperCase(),h,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Blob Powerup!",50,this.color,!1))}}drawIcon(e,t,s,i){s*=1,i.save(),i.scale(s,s),i.beginPath(),i.strokeStyle=/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.fillStyle=this.color,i.lineWidth=2,i.roundRect(1,1,22,22,3.5),i.fill(),i.stroke(),i.restore()}static cache=this.createCache()},k=class extends x{color="#f59423";index=1;name="helicopter";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,r=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),o=s._powerupsConsumed.misc,n=this.scene;if(30>r&&s.isAlive()&&-1===o.indexOf(this.id)){o.push(this.id);let e=this.time*n.settings.drawFPS;s.setTempVehicle("HELI",e,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Helicopter Powerup!",50,"#F2902E",!1))}}drawIcon(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),s*=1,i.save(),i.scale(s,s),i.lineCap="butt",i.lineJoin="miter",i.miterLimit=4,i.strokeStyle=a,i.fillStyle=a,i.beginPath(),i.moveTo(15,4.5),i.lineTo(15,2.5),i.bezierCurveTo(15,1.4,14.1,.5,13,.5),i.bezierCurveTo(11.9,.5,11,1.4,11,2.5),i.lineTo(11,4.5),i.bezierCurveTo(11,5.6,11.9,6.5,13,6.5),i.bezierCurveTo(14.1,6.5,15,5.6,15,4.5),i.lineTo(15,4.5),i.closePath(),i.fill(),i.beginPath(),i.lineCap="round",i.lineWidth=2,i.moveTo(1,3),i.lineTo(25,3),i.stroke(),i.lineCap="butt",i.lineWidth=1,i.beginPath(),i.moveTo(6.1,26.9),i.lineTo(4.1,31.9),i.bezierCurveTo(3.8,32.7,4.2,33.6,4.9,33.9),i.bezierCurveTo(5.7,34.2,6.6,33.8,6.9,33),i.lineTo(8.9,28),i.bezierCurveTo(9.2,27.3,8.8,26.4,8,26.1),i.bezierCurveTo(7.3,25.8,6.4,26.1,6.1,26.9),i.lineTo(6.1,26.9),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.moveTo(17,28),i.lineTo(19,33),i.bezierCurveTo(19.4,33.8,20.3,34.2,21,33.9),i.bezierCurveTo(21.8,33.6,22.2,32.7,21.9,31.9),i.lineTo(19.9,26.9),i.bezierCurveTo(19.6,26.2,18.7,25.8,17.9,26.1),i.bezierCurveTo(17.2,26.4,16.8,27.3,17.1,28),i.lineTo(17,28),i.closePath(),i.fill(),i.stroke(),i.fillStyle=this.color,i.lineWidth=2,i.beginPath(),i.arc(13,17,11,0,2*Math.PI,!0),i.closePath(),i.fill(),i.stroke(),i.fillStyle=a,i.beginPath(),i.moveTo(21,17),i.bezierCurveTo(21,12.6,17.4,9,13,9),i.bezierCurveTo(8.6,9,5,12.6,5,17),i.lineTo(21,17),i.closePath(),i.fill(),i.restore()}static cache=Object.assign(this.createCache(),{width:26,height:35})},T=class extends x{color="#94d44e";index=2;name="truck";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,r=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),o=s._powerupsConsumed.misc,n=this.scene;if(30>r&&s.isAlive()&&-1===o.indexOf(this.id)){o.push(this.id);let e=this.time*n.settings.drawFPS;s.setTempVehicle(this.name.toUpperCase(),e,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Truck Powerup!",50,this.color,!1))}}drawIcon(e,t,s,i){let a=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(a=this.settings.physicsLineColor),s*=1,i.save(),i.scale(s,s),i.fillStyle=a,i.strokeStyle=a,i.save(),i.beginPath(),i.roundRect(1,16.5,6,10.5,1.5),i.roundRect(18,16.5,6,10.5,1.5),i.fill(),i.moveTo(4,22),i.lineTo(21,22),i.lineWidth=2,i.stroke(),i.fillStyle=this.color,i.beginPath(),i.moveTo(23,10),i.bezierCurveTo(23.5,10.5,24,11,24,12),i.lineTo(24,18),i.bezierCurveTo(23.5,19,23.5,20,21,20),i.lineTo(3,20),i.bezierCurveTo(2.5,20,1.5,19.5,1,18.5),i.lineTo(1,12),i.bezierCurveTo(1,11,1.5,10.5,2,10),i.lineTo(2,4),i.bezierCurveTo(2,2,3,1,4,1),i.lineTo(21,1),i.bezierCurveTo(22,1,23,2,23,3),i.closePath(),i.fill(),i.stroke(),i.restore(),i.beginPath(),i.rect(5.5,5,14,6),i.fill(),i.stroke(),i.beginPath(),i.arc(5.5,15,1.895,0,2*Math.PI,!0),i.arc(19.5,15,1.895,0,2*Math.PI,!0),i.fill(),i.restore()}static cache=Object.assign(this.createCache(),{width:25,height:28})},S=class{canvasPool=[];poolCap=5e3;setToScreen=!0;options=null;constructor(e){this.options=e,e.screen&&this.update(),e.cap&&(this.setToScreen=!1,this.poolCap=e.cap)}update(){this.setToScreen&&(this.getPoolCapFromScreen(),this.cleanPool())}getPoolCapFromScreen(){this.poolCap=Math.ceil(this.options.screen.width/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))*Math.ceil(this.options.screen.height/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))+Math.ceil(this.options.screen.width/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))+Math.ceil(this.options.screen.height/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))}getCanvas(){let e=this.canvasPool.pop();return e??=document.createElement("canvas")}releaseCanvas(e){this.canvasPool.length<this.poolCap&&this.canvasPool.push(e)}cleanPool(){this.canvasPool.length>this.poolCap&&(this.canvasPool=this.canvasPool.slice(0,this.poolCap+1))}};let _=[];const C=class{defaultLine={p1:new o(-40,50),p2:new o(40,50)};camera=null;canvasPool=null;settings=null;physicsLines=[];sceneryLines=[];powerups=[];powerupsLookupTable={};targets=[];targetCount=0;sectors={};totalSectors=[];allowedVehicles=null;dirty=!1;constructor(e){Object.defineProperties(this,{scene:{value:e,writable:!0},game:{value:e.game,writable:!0}}),this.settings=e.game.settings,this.settings.track||(this.settings.track={vehicle:this.settings.startVehicle}),this.camera=e.camera,this.sectors.drawSectors=[],this.sectors.physicsSectors=[],this.allowedVehicles=["MTB","BMX"],this.canvasPool=new S(e),this.createPowerupCache()}createPowerupCache(){_.push(new p(0,0,0,this)),_.push(new g(0,0,this)),_.push(new d(0,0,this)),_.push(new m(0,0,0,this)),_.push(new u(0,0,this)),_.push(new y(0,0,this)),_.push(new c(0,0,this)),_.push(new f(0,0,this)),_.push(new k(0,0,0,this)),_.push(new T(0,0,0,this)),_.push(new v(0,0,0,this)),_.push(new b(0,0,0,this))}recachePowerups(e){for(const t of _)t.recache(e)}read(e){var t=e.split("#"),s=t[0].split(","),i=[],a=[];t.length>2?(i=t[1].split(","),a=t[2].split(",")):t.length>1&&(a=t[1].split(",")),this.addLines(s,this.addPhysicsLine),this.addLines(i,this.addSceneryLine),this.addPowerups(a)}move(e=0,t=0){for(const s in this.physicsLines)this.physicsLines[s].p1.x-=e,this.physicsLines[s].p1.y-=t,this.physicsLines[s].p2.x-=e,this.physicsLines[s].p2.y-=t,this.addPhysicsLineToTrack(this.physicsLines[s]),this.physicsLines.splice(i,1);for(const s in this.sceneryLines)this.sceneryLines[s].p1.x-=e,this.sceneryLines[s].p1.y-=t,this.sceneryLines[s].p2.x-=e,this.sceneryLines[s].p2.y-=t,this.addSceneryLineToTrack(s),this.sceneryLines.splice(i,1);for(const s in this.powerups)this.powerups[s].x-=e,this.powerups[s].y-=t,this.powerups[s].otherPortal&&(this.powerups[s].otherPortal.x-=e,this.powerups[s].otherPortal.y-=t),this.addPowerup(this.powerups[s]),this.powerups.splice(s,1);this.scene.redraw()}addPowerups(e){for(var t=e.length,s=[],i=0;t>i;i++)if((s=e[i].split(" ")).length>=2){for(var a=[],r=s.length,o=1;r>o;o++){var n=parseInt(s[o],32);a.push(n)}var h=Math.round(a[0]),l=Math.round(a[1]),w=null;switch(s[0]){case"B":w=new p(h,l,a[2],this);break;case"S":w=new g(h,l,this);break;case"O":w=new d(h,l,this);break;case"G":w=new m(h,l,a[2],this);break;case"C":w=new u(h,l,this);break;case"T":w=new y(h,l,this),this.addTarget(w);break;case"A":w=new c(h,l,this);break;case"V":var x=a[2],S=a[3],_=this.settings.vehiclePowerup.minTime,C=this.settings.vehiclePowerup.maxTime;switch(S=S||_,S=Math.min(S,C),S=Math.max(S,_),x){case 1:w=new k(h,l,S,this);break;case 2:w=new T(h,l,S,this);break;case 3:w=new v(h,l,S,this);break;case 4:w=new b(h,l,S,this);break;default:continue}break;case"W":var P=a[0],M=a[1],A=a[2],z=a[3],D=new f(P,M,this),L=new f(A,z,this);D.addOtherPortalRef(L),L.addOtherPortalRef(D),this.addPowerup(D),this.addPowerup(L);default:continue}this.addPowerup(w)}}addTarget(e){this.dirty=!0,this.targetCount++,this.targets.push(e)}maxDuplicatePowerups=0;addPowerup(e){if(window.hasOwnProperty("lite")&&lite.storage.get("experiments").filterDuplicatePowerups){let t=this.powerups.filter((t=>t.name===e.name&&t.x==e.x&&t.y==e.y));if(t.length>this.maxDuplicatePowerups)switch(e.prefix){case"B":case"G":break;case"V":return t[0].duplicates++,t[0].stack.push(e.time),t[0].time+=e.time,e;case"W":if(t.length>2*(1+this.maxDuplicatePowerups))return e;break;case"T":this.targetCount--,this.targets.pop();default:return e}}this.addRef(e.x,e.y,e,2,this.sectors.physicsSectors,this.settings.physicsSectorSize);let t=this.addRef(e.x,e.y,e,2,this.sectors.drawSectors,this.settings.drawSectorSize);return!1!==t&&this.totalSectors.push(t),null!==e&&(this.powerups.push(e),e.id&&(this.powerupsLookupTable[e.id]=e)),e}addLines(e,t){for(let s=e.length,i=0;s>i;i++){let s=e[i].split(" "),a=s.length;if(a>3)for(let e=0;a-2>e;e+=2){let i=parseInt(s[e],32),a=parseInt(s[e+1],32),r=parseInt(s[e+2],32),o=parseInt(s[e+3],32);isNaN(i+a+r+o)||t.call(this,i,a,r,o)}}}addPhysicsLine(e,t,s,i){if(Math.sqrt(Math.pow(Math.round(s)-Math.round(e),2)+Math.pow(Math.round(i)-Math.round(t),2))>=2)return this.addPhysicsLineToTrack(new h(Math.round(e),Math.round(t),Math.round(s),Math.round(i)))}addPhysicsLineToTrack(e){for(let t=r(e.p1.x,e.p1.y,e.p2.x,e.p2.y,this.settings.drawSectorSize,!0),s=0;t.length>s;s+=2){let i=this.addRef(t[s],t[s+1],e,1,this.sectors.drawSectors,this.settings.drawSectorSize);!1!==i&&this.totalSectors.push(i)}for(let t=r(e.p1.x,e.p1.y,e.p2.x,e.p2.y,this.settings.physicsSectorSize),s=0;t.length>s;s+=2)this.addRef(t[s],t[s+1],e,1,this.sectors.physicsSectors,this.settings.physicsSectorSize);return this.physicsLines.push(e),e}addSceneryLine(e,t,s,i){if(Math.sqrt(Math.pow(Math.round(s)-Math.round(e),2)+Math.pow(Math.round(i)-Math.round(t),2))>=2)return this.addSceneryLineToTrack(new n(Math.round(e),Math.round(t),Math.round(s),Math.round(i)))}addSceneryLineToTrack(e){for(let t=this.settings.drawSectorSize,s=e.p1,i=e.p2,a=r(s.x,s.y,i.x,i.y,t,!0),o=this.sectors.drawSectors,n=a.length,h=0;n>h;h+=2){let s=this.addRef(a[h],a[h+1],e,1,o,t);!1!==s&&this.totalSectors.push(s)}return this.sceneryLines.push(e),e}addRef(e,t,s,i,a,r){let o=Math.floor(e/r),n=Math.floor(t/r),h=!1;if(void 0===a[o]&&(a[o]=[]),void 0===a[o][n]){let e=new w(o,n,this);a[o][n]=e,h=e}switch(i){case 1:a[o][n].addLine(s),s.addSectorReference(a[o][n]);break;case 2:a[o][n].addPowerup(s),s.addSectorReference(a[o][n])}return this.dirty=!0,h}cleanTrack(){this.cleanLines(),this.cleanPowerups()}cleanLines(){let e=this.physicsLines,t=this.sceneryLines;for(let t of e.filter((e=>e.remove)))e.splice(e.indexOf(t),1);for(let e of t.filter((e=>e.remove)))t.splice(t.indexOf(e),1)}cleanPowerups(){let e=this.powerups,t=this.targets;for(let t of e.filter((e=>e.remove)))e.splice(e.indexOf(t),1);for(let e of t.filter((e=>e.remove)))t.splice(t.indexOf(e),1);this.targetCount=this.targets.length}updatePowerupState(e){this.resetPowerups(),this.setPowerupStates(e._powerupsConsumed.targets),this.setPowerupStates(e._powerupsConsumed.checkpoints),this.setPowerupStates(e._powerupsConsumed.misc)}setPowerupStates(e){for(let t of e)this.powerupsLookupTable[t].remove&&this.powerupsLookupTable[t].id&&(delete this.powerupsLookupTable[t],delete e[t]),this.powerupsLookupTable[t].hit=!0,this.powerupsLookupTable[t].sector.powerupCanvasDrawn=!1}select(e,t){const s=[];let i=new o(Math.min(e.x,t.x),Math.min(e.y,t.y)),a=new o(Math.max(e.x,t.x),Math.max(e.y,t.y));for(const e of[...this.physicsLines,...this.sceneryLines,...this.powerups].filter((e=>!e.remove)))e.p1||e.p2?(e.p1.x>i.x&&e.p1.y>i.y||e.p2.x>i.x&&e.p2.y>i.y)&&(e.p1.x<a.x&&e.p1.y<a.y||e.p2.x<a.x&&e.p2.y<a.y)&&s.push(e):e.x>i.x&&e.y>i.y&&e.x<a.x&&e.y<a.y&&s.push(e);return s}getCode(){this.cleanTrack();var e=this.powerups,t=this.physicsLines,s=this.sceneryLines,i="";if(t.length>0){for(var a of t)a.recorded||(i+=a.p1.x.toString(32)+" "+a.p1.y.toString(32)+a.getCode(this)+",");for(var a of(i=i.slice(0,-1),t))a.recorded=!1}if(i+="#",s.length>0){for(var r of s)r.recorded||(i+=r.p1.x.toString(32)+" "+r.p1.y.toString(32)+r.getCode(this)+",");for(var r of(i=i.slice(0,-1),s))r.recorded=!1}if(i+="#",e.length>0){for(var o of e.map((e=>e.getCode())).filter((e=>e)))i+=o+",";i=i.slice(0,-1)}return i}resetPowerups(){for(let e of this.powerups.filter((e=>e.hit&&!e.remove)))e.sector.powerupCanvasDrawn=e.hit=!1}addDefaultLine(){this.addPhysicsLine(this.defaultLine.p1.x,this.defaultLine.p1.y,this.defaultLine.p2.x,this.defaultLine.p2.y)}erase(e,t,s){this.dirty=!0;for(var i=Math.floor(Math.min(e.x-t,e.x+t)/this.settings.drawSectorSize),a=[];Math.floor(Math.max(e.x-t,e.x+t)/this.settings.drawSectorSize)>=i;i++)for(var r=Math.floor(Math.min(e.y-t,e.y+t)/this.settings.drawSectorSize);Math.floor(Math.max(e.y-t,e.y+t)/this.settings.drawSectorSize)>=r;r++)this.sectors.drawSectors[i]&&this.sectors.drawSectors[i][r]&&a.push(this.sectors.drawSectors[i][r].erase(e,t,s));return a.flat()}drawAndCache(){for(var e=performance.now(),t=this.totalSectors,s=t.length,i=0;s>i;i++)!function(e){setTimeout((function(){e.draw(),e.cacheAsImage()}),250*i)}(t[i]);let a=performance.now();console.log("Track :: Time to draw entire track : "+(a-e)+"ms")}undraw(){for(let e of this.totalSectors.filter((e=>e.drawn)))e.clear(!0);this.recachePowerups(Math.max(this.camera.zoom,1)),this.canvasPool.update()}collide(e){let t=Math.floor(e.pos.x/this.settings.physicsSectorSize-.5),s=Math.floor(e.pos.y/this.settings.physicsSectorSize-.5);this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s]&&this.sectors.physicsSectors[t][s].resetCollided(),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s]&&this.sectors.physicsSectors[t+1][s].resetCollided(),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s+1]&&this.sectors.physicsSectors[t+1][s+1].resetCollided(),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s+1]&&this.sectors.physicsSectors[t][s+1].resetCollided(),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s]&&this.sectors.physicsSectors[t][s].collide(e),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s]&&this.sectors.physicsSectors[t+1][s].collide(e),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s+1]&&this.sectors.physicsSectors[t+1][s+1].collide(e),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s+1]&&this.sectors.physicsSectors[t][s+1].collide(e)}getDrawSector(e,t){let s=Math.floor(e/this.settings.drawSectorSize),i=Math.floor(t/this.settings.drawSectorSize);return void 0!==this.sectors.drawSectors[s]&&void 0!==this.sectors.drawSectors[s][i]&&this.sectors.drawSectors[s][i]}draw(e){let t=this.scene.camera.position.x*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.width/(this.settings.drawSectorSize*this.scene.camera.zoom)/2-1,s=this.scene.camera.position.y*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.height/(this.settings.drawSectorSize*this.scene.camera.zoom)/2-1,i=this.scene.camera.position.x*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)+this.scene.screen.width/(this.settings.drawSectorSize*this.scene.camera.zoom)/2,a=this.scene.camera.position.y*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)+this.scene.screen.height/(this.settings.drawSectorSize*this.scene.camera.zoom)/2;for(const r of this.totalSectors)if(r.dirty&&r.cleanSector(),r.column>=t&&i>=r.column&&r.row>=s&&a>=r.row){!1===r.drawn&&r.draw(),r.hasPowerups&&(r.powerupCanvasDrawn||r.cachePowerupSector());let t=r.column*(this.settings.drawSectorSize*this.scene.camera.zoom)-(this.scene.camera.position.x*this.scene.camera.zoom-this.scene.screen.center.x)|0,s=r.row*(this.settings.drawSectorSize*this.scene.camera.zoom)-(this.scene.camera.position.y*this.scene.camera.zoom-this.scene.screen.center.y)|0;e.drawImage(r.canvas,t,s,this.settings.drawSectorSize*this.scene.camera.zoom,this.settings.drawSectorSize*this.scene.camera.zoom),r.hasPowerups&&r.powerupCanvasDrawn&&e.drawImage(r.powerupCanvas,t-r.powerupCanvasOffset*this.scene.camera.zoom/2,s-r.powerupCanvasOffset*this.scene.camera.zoom/2,this.settings.drawSectorSize*this.scene.camera.zoom+r.powerupCanvasOffset*this.scene.camera.zoom,this.settings.drawSectorSize*this.scene.camera.zoom+r.powerupCanvasOffset*this.scene.camera.zoom)}else r.drawn&&r.clear()}closeSectors(){for(const e of this.totalSectors)e.close()}close(){this.scene=null,this.closeSectors(),this.totalSectors=null,this.canvasPool=null,this.sectors=null,this.physicsLines=null,this.sceneryLines=null,this.powerups=null,this.camera=null}},P=class{scene=null;clockwise=!1;screen=null;settings=null;constructor(e){this.scene=e,this.screen=e.screen,this.settings={radius:10,color:"#1884cf"}}draw(e){let t=this.screen,s=this.settings,i=this.scene.game.pixelRatio,a=s.radius,r=this.scene.game._updates%25/25*2*Math.PI;0===r&&(this.clockwise=!this.clockwise);let o=t.width-25*i,n=t.height-25*i;e.beginPath(),e.arc(o,n,a*i,0,r,!this.clockwise),e.lineWidth=3*i,e.strokeStyle=s.color,e.stroke()}},M=class{color="#000";message=!1;timeout=!1;constructor(e){this.scene=e}draw(e){let t=this.message,s=this.timeout,i=this.color,a=this.outline;if(!1!==s&&0>=s&&(t=!1),this.scene.state.paused&&(i=!1,a=!1,t="Paused"+(this.scene.settings.mobile?"":" - Press Spacebar to Continue")),!1===i&&(i="#".padEnd(7,"midnight"==lite.storage.get("theme")?"8":/^dark(er)?$/i.test(lite.storage.get("theme"))?"c":"3")),t){let s=this.scene.game,r=this.scene,o=s.pixelRatio,n=r.screen.center.x,h=100;"phone"===r.settings.controls&&(h=80),e.save(),e.fillStyle=i,e.lineWidth=o/2*4,e.font=12*o+"pt helsinki",e.textAlign="center",a&&(e.strokeStyle=a,e.strokeText(t,n,h*o)),e.fillText(t,n,h*o),e.restore()}}show(e,t,s,i){this.message=e,this.timeout=t,this.color=/^#(0|3){3,6}$/.test(s)?this.scene.settings.physicsLineColor:s,this.outline="midnight"==lite.storage.get("theme")?"#1d2328":"darker"==lite.storage.get("theme")?"#000":"dark"==lite.storage.get("theme")?"#1b1b1b":i}hide(){this.message=!1,this.color=!1,this.outline=!1}update(){!1!==this.timeout&&this.timeout--}},A=class{alpha=null;background=null;cached=!1;canvas=null;color=null;container=null;font={size:null};scale={x:1,y:1};text=null;image=null;x=0;y=0;visible=!0;constructor(e,t){Object.assign(this,e),t&&t.addChild(this)}createCanvas(){let e=this.canvas;return e||(e=document.createElement("canvas"),this.canvas=e),e}cache(e=window.devicePixelRatio){if(!this.cached&&!this.image){let e=this.createCanvas(),t=e.getContext("2d");if(t.clearRect(0,0,e.width,e.height),null!==this.text){let s=(this.font.size??(this.container&&this.container.font.size)??16)+"px "+(this.font.family||"helsinki");t.font=s;let i=t.measureText(this.text);e.width=Math.ceil(Math.max(i.width,i.actualBoundingBoxLeft+i.actualBoundingBoxRight)),e.height=Math.ceil(Math.abs(i.actualBoundingBoxAscent)+Math.abs(i.actualBoundingBoxDescent)),this.radius&&(i=this.radius,e.width=Math.max(e.width,2*this.scale.x*i),e.height=Math.max(e.height,2*this.scale.y*i)),this.width=e.width,this.height=e.height,this.alpha&&(t.globalAlpha=this.alpha),this.background&&(t.save(),"round"===this.border&&t.arc(e.height/2,e.height/2,i,0,2*Math.PI),t.fillStyle=this.background,t.fill(),t.restore()),this.color&&(t.fillStyle=this.color)||this.container&&this.container.color&&(t.fillStyle=this.container.color),t.font=s,this.textAlign&&(t.textAlign=this.textAlign)||this.container&&this.container.textAlign&&(t.textAlign=this.container.textAlign),t.textBaseline=this.textBaseline||this.container&&this.container.textBaseline||"top",t.fillText(this.text,"center"===t.textAlign?this.width/2:0,"middle"===t.textBaseline?this.height/2:0)}this.cached=!0}}draw(e,t=0,s=0){if(this.visible){let i=window.devicePixelRatio,a=i*this.scale.x,r=i*this.scale.y;this.image?(e.imageSmoothingEnabled=!0,e.drawImage(this.image.canvas,this.image.x,this.image.y,this.image.width,this.image.height,t+this.x*i,s+this.y*i,this.width*a,this.height*r),e.imageSmoothingEnabled=!1):(this.cached||this.cache(i),e.drawImage(this.canvas,t+this.x*i,s+this.y*i,this.width*a,this.height*r))}}setDirty(){this.cached=!1,this.container&&(this.container.cached=!1)}},z=class extends A{get width(){return this.inline?this.children.reduce(((e,t)=>e+(t.width+t.x)),0):this.children.reduce(((e,t)=>Math.max(e,t.width+t.x)),0)}get height(){return this.children.reduce(((e,t)=>Math.max(e,t.height+t.y)),0)}children=[];font={size:16};inline=null;constructor(e,t){super(e,t),Object.assign(this,e);for(let e of this.children)Object.defineProperty(e,"container",{value:this,writable:!0})}addChild(){let e=arguments,t=this.children;for(let t of e)Object.defineProperty(t,"container",{value:this,writable:!0});return t.push(...Array.prototype.filter.call(e,(e=>-1===t.indexOf(e)))),e}cache(e=window.devicePixelRatio){if(!this.cached){let t=(this.createCanvas(),this.canvas.getContext("2d"));t.clearRect(0,0,t.canvas.width,t.canvas.height),this.width>0&&(t.canvas.width=this.width*window.devicePixelRatio),this.height>0&&(t.canvas.height=this.height*window.devicePixelRatio),this.alpha&&(t.globalAlpha=this.alpha),t.imageSmoothingEnabled=!1;for(let s in this.children){let i=this.children[s],a=this.inline,r=this.children.slice(0,s),o=r.reduce(((e,t)=>e+(t.width+t.x)),0)*window.devicePixelRatio;r.reduce(((e,t)=>e+(t.height+t.y)),0),window.devicePixelRatio,i.cached||i.cache(e),i.draw(t,a&&(this.gap??o))}this.cached=!0}}draw(e,t=0,s=0){if(this.visible){let i=window.devicePixelRatio;this.cached||this.cache(i);let a=this.canvas;e.drawImage(a,t+this.x*i,s+this.y*i,a.width*this.scale.x,a.height*this.scale.y)}}setDirty(){this.cached=!1;for(let e of this.children.filter((e=>!e.image)))e.setDirty()}},D=class{cached=!1;canvas=null;container=new z;constructor(e,t){Object.defineProperty(this,"scene",{value:e,writable:!0}),Object.assign(this.container,t)}draw(e){this.container.draw(e)}redraw(){this.container.setDirty()}update(){let e=this.container;e.cached||=-1===e.children.findIndex((e=>!e.cached))}};function L(e){let t=(e=parseInt(e,10))%6e4/1e3;return Math.floor(e/6e4)+":"+t.toFixed(2).padStart(5,0)}const O=class extends D{paused=!1;sprites={};spriteSheet={timer:[2,2,58,58],timer_paused:[2,62,116,118],target:[2,2,58,58]};time=new A({text:"0:00.00",font:{size:16},x:23,y:7},this.container);time_title=new A({text:"TIME:",color:"#999",x:24,y:2},this.container);timer_sprite=new A({cached:!0,image:{x:2,y:2,width:58,height:58},width:24,height:24},this.container);best_time=new A({text:"-- : --.--",color:"#999",font:{size:14},x:95,y:8},this.container);best_time_title=new A({text:"BEST:",color:"#999",x:96,y:2},this.container);goals=new A({text:"0/0",font:{size:16},x:185,y:6},this.container);target_sprite=new A({cached:!0,image:{x:2,y:2,width:58,height:58},x:160,width:24,height:24},this.container);constructor(e){super(e,{font:{size:8},x:6,y:4}),this.sprites.timer=e.assets.getResult("time_icon"),this.sprites.target=e.assets.getResult("targets_icon"),this.timer_sprite.image.canvas=this.sprites.timer,this.target_sprite.image.canvas=this.sprites.target}draw(e){if(super.draw(e),window.hasOwnProperty("lite")&&lite.storage.get("experiments").raceProgress){let t=this.scene.camera.playerFocus;if(t&&this.scene.state.inFocus){e.beginPath();let s=e.canvas.width/3,i=e.canvas.width/2-s/2,a=e.canvas.height-16,r=Math.min(6,e.canvas.height/12),n=r/2;e.roundRect(i,a,s,r,n),e.fillStyle="hsl(0deg, 0%, 50%)",e.fill(),e.lineWidth=2,e.strokeStyle=e.fillStyle,e.stroke(),e.beginPath();let h=t._powerupsConsumed.targets,l=this.scene.track,c=h.length/l.targetCount,d=l.targets.find((e=>e.id==("function"==typeof h.at?h.at(-1):h[h.length-1])))||{x:0,y:0},p=new o(d.x,d.y),u=l.targets.filter((e=>!h.includes(e.id))).sort(((e,t)=>p.sub(new o(e.x,e.y)).len()-p.sub(new o(t.x,t.y)).len()))[0],m=u&&new o(u.x,u.y),g=(u&&p.sub(m).len())??0,y=(u&&Math.min(...(t._tempVehicle||t._baseVehicle).masses.map((e=>m.sub(e.pos).len())).sort(((e,t)=>e-t))))??0;c+=100*Math.min(1,Math.max(0,(g-y)/g))/l.targetCount/100,e.roundRect(i,a,Math.max(0,Math.min(s,s*c)),r,n),e.fillStyle="#FAE335",e.fill()}}}update(){let e=this.scene,t=e.state.paused,s=L(1e3*((null!==e.camera.playerFocus&&e.camera.playerFocus._gamepad.playbackTicks||null)??e.ticks)/e.settings.drawFPS),i=e.playerManager.firstPlayer.getTargetsHit()+"/"+e.track.targetCount,a=e.settings.isCampaign&&e.settings.campaignData.user.best_time||e.settings.userTrackStats&&e.settings.userTrackStats.best_time;this.paused!==t&&(this.timer_sprite.image.y=t?62:2,this.container.cached=!1,this.paused=t),this.time.text!==s&&(this.time.text=s,this.time.setDirty()),this.goals.text!==i&&(this.goals.text=i,this.goals.setDirty()),a&&this.best_time.text!==a&&(this.best_time.text=a,this.best_time.setDirty()),e.settings.mobile&&this.centerContainer()}centerContainer(){let e=this.container,t=e.width,s=this.scene.screen;e.x=s.width/2/window.devicePixelRatio-t/2,e.y=10}},E=class extends e{enabled=!0;touch=null;touches=[];updateCallback=!1;wheel=!1;mousewheel=!1;throttledMouseWheel=null;analytics=null;constructor(e){super(),Object.defineProperty(this,"scene",{value:e||null,writable:!0}),this.touch=this.getTouchObject(),this.touch.old=this.getTouchObject(),this.secondaryTouch=this.getTouchObject(),this.secondaryTouch.old=this.getTouchObject(),this.initAnalytics(),this.bindToMouseEvents()}initAnalytics(){this.analytics={clicks:0}}getTouchObject(){return{id:null,down:!1,press:!1,release:!1,pos:new o(0,0),real:new o(0,0),type:1}}bindToMouseEvents(){let e=this.scene.game.canvas,t=this.onMouseMove.bind(this),s=this.onMouseDown.bind(this),i=this.onMouseUp.bind(this);e.addEventListener("pointermove",t,{passive:!0}),e.addEventListener("pointerdown",s,{passive:!0}),e.addEventListener("pointerup",i,{passive:!0}),Object.defineProperties(this,{_moveListener:{value:t,writable:!0},_upListener:{value:i,writable:!0},_downListener:{value:s,writable:!0}});let a=this.onMouseWheel.bind(this);e.addEventListener("mousewheel",a),e.addEventListener("wheel",a),Object.defineProperty(this,"_wheelListener",{value:a,writable:!0})}contextMenuHandler(e){return e.stopPropagation(),e.preventDefault(),!1}disableContextMenu(){this.scene.game.canvas.oncontextmenu=function(){return!1}}onMouseDown(e){this.scene.game.canvas.setPointerCapture(e.pointerId),this.analytics.clicks++,2===e.button?!1===this.secondaryTouch.down&&(this.updatePosition(e,this.secondaryTouch),this.secondaryTouch.down=!0):!1===this.touch.down&&(this.updatePosition(e,this.touch),this.touch.down=!0,this.scene.redrawControls())}onMouseMove(e){this.updatePosition(e,this.touch),this.scene.redrawControls(),this.updatePosition(e,this.secondaryTouch)}onMouseUp(e){this.scene.game.canvas.releasePointerCapture(e.pointerId),2===e.button?!0===this.secondaryTouch.down&&(this.updatePosition(e,this.secondaryTouch),this.secondaryTouch.down=!1):!0===this.touch.down&&(this.updatePosition(e,this.touch),this.scene.interactWithControls(),this.touch.down=!1,this.scene.redrawControls())}onMouseWheel(e){e.preventDefault(),e.stopPropagation();let t=Math.max(-1,Math.min(1,-e.deltaY||-e.detail));return 0==t&&(t=Math.max(-1,Math.min(1,e.deltaX||-e.detail))),this.wheel=t,!1}update(){this.enabled&&(this.updateTouch(this.touch),this.updateTouch(this.secondaryTouch),this.updateWheel())}updatePosition(e,t){t.id=e.pointerId,t.type=e.button;let s=t.pos;s.x=e.offsetX*window.devicePixelRatio,s.y=e.offsetY*window.devicePixelRatio,this.updateRealPosition(t)}updateRealPosition(e){let t=e.real;if(t.x=Math.round((e.pos.x-this.scene.screen.center.x)/this.scene.camera.zoom+this.scene.camera.position.x),t.y=Math.round((e.pos.y-this.scene.screen.center.y)/this.scene.camera.zoom+this.scene.camera.position.y),this.scene.toolHandler.options.grid){let s=0|this.scene.settings.toolHandler.gridSize;if(lite.storage.get("isometricGrid")){function i(e,t){return(e%t+t)%t}let a=s/2,r=Math.round(t.x/s),o=i(r,2);t.x=r*s,t.y=t.y-i(t.y+a*(o+1),s)-a*(o-1)+o*a}else t.x=Math.round(t.x/s)*s,t.y=Math.round(t.y/s)*s}this.updateCallback=!0}updateTouch(e){e.old.pos.x=e.pos.x,e.old.pos.y=e.pos.y,e.old.real.x=e.real.x,e.old.real.y=e.real.y,!e.old.down&&e.down&&(e.press=!0),e.old.down&&!e.down&&(e.release=!0),e.old.press&&(e.press=!1),e.old.release&&(e.release=!1),this.updateRealPosition(e),e.old.down=e.down,e.old.press=e.press,e.old.release=e.release}updateWheel(){this.mousewheel=this.wheel,this.wheel=!1}close(){let e=this.scene.game.canvas;e.removeEventListener("mousewheel",this._wheelListener),e.removeEventListener("wheel",this._wheelListener),this.touches=null,this.touch=null,this.scene=null,this.wheel=null,this._moveListener=null,this._downListener=null,this._upListener=null,this._wheelListener=null}},B=class{muted=!1;sounds=new Map;constructor(e){Object.defineProperty(this,"scene",{value:e||null,writable:!0})}update(){let e=this.scene;this.muted=e.state.paused||!1===e.settings.soundsEnabled;for(let t of this.sounds.values())t.muted=this.muted,t.paused&&!e.state.paused?t.play():!t.paused&&e.state.paused&&t.pause()}setVolume(e,t){this.sounds.has(e)&&(this.sounds.get(e).volume=this.muted?0:t??1)}mute_all(){let e=this.sounds;for(let t in e)e[t].muted=!0,e[t].volume=0;this.muted=!0}stop_all(){for(let e in this.sounds)this.stop(e)}play(e,t){if(!this.sounds.has(e)&&this.scene.settings.soundsEnabled){let t=this.scene.assets.getItem(e),s=t&&new Audio(t.src);s&&(this.sounds.set(e,s),s.addEventListener("ended",(()=>{this.sounds.delete(e)}),{passive:!0}))}this.setVolume(e,t)}stop(e){this.sounds.has(e)&&(this.sounds.get(e).pause(),this.sounds.delete(e))}close(){this.sounds=null}},I=class{name="";toolhandler=null;camera=null;mouse=null;scene=null;constructor(e){this.toolhandler=e,this.scene=e.scene,this.game=e.scene.game,this.camera=e.scene.camera,this.mouse=e.scene.mouse,this.gamepad=e.gamepad}press(){}hold(){}release(){}update(){let e=this.mouse,t=e.touch,s=e.secondaryTouch,i=this.toolhandler.gamepad,a=this.toolhandler.options,r=i.isButtonDown("shift");a.rightClickMove&&(r=s.old.down),r?(t.old.down||a.rightClickMove)&&this.moveCamera():(t.press&&this.press(),t.old.down&&this.hold(),t.release&&this.release()),!1!==e.mousewheel&&!1===i.isButtonDown("shift")&&this.mousewheel(e.mousewheel)}moveCamera(){let e=this.mouse.secondaryTouch,t=e.pos,s=this.camera,i=e.old.pos.sub(t).factor(1/s.zoom);s.position.inc(i)}draw(){}reset(){}mousewheel(e){let t=this.scene.settings,s=this.scene.game.pixelRatio,i=t.cameraSensitivity,a=t.cameraZoomMin,r=t.cameraZoomMax,o=a*s,n=r*s,h=this.camera,l=this.mouse.touch,c=h.desiredZoom;c+=e*i,h.setZoom(c/s,l.pos),h.desiredZoom<o?h.setZoom(a,l.pos):h.desiredZoom>n&&h.setZoom(r,l.pos)}checkKeys(){let e=this.gamepad,t=this.name.toLowerCase(),s=this.toolhandler;e.isButtonDown(t)&&(s.setTool(t),e.setButtonUp(t))}getOptions(){return{}}close(){}},R=class extends I{name="Camera";hold(){let e=this.mouse.touch,t=e.pos,s=this.camera,i=e.old.pos.sub(t).factor(1/s.zoom);s.position.inc(i)}drawText(e){e.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":"#000",e.font=12*this.game.pixelRatio+"pt arial",e.fillText(this.name,10*this.game.pixelRatio,20*this.game.pixelRatio),e.font=8*this.game.pixelRatio+"pt arial"}},F=class{currentTool="";scene=null;camera=null;mouse=null;tools={};gamepad=null;gridCache=!1;gridCacheAlpha=1;gridUseEnabled=!1;snapPoint=!1;options=null;constructor(e){this.currentTool="",this.scene=e,this.camera=e.camera,this.mouse=e.mouse,this.mouse.updateCallback=this.draw.bind(this),this.gamepad=e.playerManager.firstPlayer.getGamepad(),this.options=e.settings.toolHandler,this.snapPoint=new o,this.snapPoint.equ(this.scene.track.defaultLine.p2),this.initAnalytics(),this.actionTimeline=[],this.actionTimelineMax=50,this.actionTimelinePointer=0}initAnalytics(){this.analytics={actions:0}}enableGridUse(){this.gridUseEnabled=!0}getToolOptions(){return this.tools[this.currentTool].getOptions()}setToolOption(e,t,s){void 0!==s&&void 0!==this.tools[s]?this.tools[s].setOption(e,t):this.tools[this.currentTool].setOption(e,t),this.scene.updateState()}registerTool(e){let t=(e=new e(this)).name.toLowerCase();this.tools[t]=e}setTool(e){e=e.toLowerCase(),this.currentTool!==e&&(this.resetTool(),this.currentTool=e,this.scene.updateState(),this.analytics.actions++)}addActionToTimeline(e){this.actionTimeline.length>=this.actionTimelineMax&&(this.actionTimeline.splice(0,this.actionTimeline.length-this.actionTimelineMax),this.actionTimelinePointer=this.actionTimelineMax),this.actionTimeline.splice(this.actionTimelinePointer),this.actionTimeline.push(e),this.actionTimelinePointer++}revertAction(){let e=this.actionTimelinePointer;if(e>0){let t=this.actionTimeline[e-1];switch(e--,t.type){case"add":this.removeObjects(t.objects);break;case"remove":this.addObjects(t.objects)}this.actionTimelinePointer=e}}applyAction(){let e=this.actionTimeline,t=this.actionTimelinePointer;if(t<e.length){let e=this.actionTimeline[t];switch(t++,e.type){case"add":this.addObjects(e.objects);break;case"remove":this.removeObjects(e.objects)}this.actionTimelinePointer=t}}removeObjects(e){for(let t=0;t<e.length;t++){let s=e[t];s.remove=!0,s.removeAllReferences()}this.scene.track.cleanTrack()}addObjects(e){for(let t=e.length,s=this.scene.track,i=0;t>i;i++){let t=e[i];t instanceof h?(t.remove=!1,s.addPhysicsLineToTrack(t)):t instanceof n?(t.remove=!1,s.addSceneryLineToTrack(t)):t instanceof y?(t.remove=!1,s.addTarget(t),s.addPowerup(t)):(t.remove=!1,s.addPowerup(t))}}resetTool(){""!==this.currentTool&&this.tools[this.currentTool].reset()}update(){this.checkGrid(),this.mouse.enabled&&this.tools[this.currentTool].update(),this.checkHotkeys(),this.checkMouse(),this.checkSnap()}checkGrid(){let e=this.scene.camera;e.zoom!==e.desiredZoom&&(this.gridCache=!1)}checkSnap(){this.options.snapLocked&&(this.options.snap=!0)}moveCameraTowardsMouse(){if(!1===this.options.cameraLocked){let e=this.scene.screen,t=100,s=e.height-t,i=0+t,a=e.width-t,r=0+t,o=this.options.cameraMoveSpeed,n=e.center,h=this.camera,l=this.mouse.touch,c=l.pos.x,d=l.pos.y,p=.8*(c-n.x),u=d-n.y;(c>=a||r>=c||d>=s||i>=d)&&(h.position.x+=p*o*(1/h.zoom),h.position.y+=u*o*(1/h.zoom))}}checkMouse(){let e=this.mouse.touch,t=this.mouse.secondaryTouch;(e.press||t.press)&&this.press()}press(){this.camera.unfocus()}checkHotkeys(){let e=this.gamepad,t=this.options.snap,s=this.options.snapLocked,i=this.options.rightClickMove,a=e.isButtonDown("alt");i&&(a=e.isButtonDown("shift")),a&&!t?this.toggleQuickSnap():a||!t||s||this.toggleQuickSnap(),e.isButtonDown("ctrl")&&e.isButtonDown("z")&&(e.setButtonUp("z"),this.revertAction()),e.isButtonDown("ctrl")&&e.isButtonDown("y")&&(e.setButtonUp("y"),this.applyAction());let r=this.tools;for(let e in r)r[e].checkKeys();this.gridUseEnabled&&e.isButtonDown("grid")&&(e.setButtonUp("grid"),this.toggleGrid()),e.isButtonDown("zoom_increase")&&(e.setButtonUp("zoom_increase"),this.scene.camera.increaseZoom()),e.isButtonDown("zoom_decrease")&&(e.setButtonUp("zoom_decrease"),this.scene.camera.decreaseZoom()),e.isButtonDown("zoom_100")&&(e.setButtonUp("zoom_100"),this.scene.camera.resetZoom()),e.isButtonDown("lineType")&&(e.setButtonUp("lineType"),this.toggleLineType())}toggleLineType(){let e=this.options.lineType;this.options.lineType="physics"===e?"scenery":"physics",this.scene.updateState()}toggleGrid(){this.options.grid=this.scene.state.grid=!this.options.grid,this.scene.updateState()}toggleSnap(){this.options.snap=!this.options.snap,this.options.snapLocked=!this.options.snapLocked,this.resetTool(),this.scene.updateState()}toggleQuickSnap(){this.options.snapLocked||(this.options.snap=!this.options.snap,this.resetTool(),this.scene.updateState())}toggleCameraLock(){this.options.cameraLocked=!this.options.cameraLocked,this.scene.updateState()}draw(e){this.mouse.enabled&&this.tools[this.currentTool].draw(e)}drawGrid(e){let t=this.scene.game.pixelRatio;!0===this.options.grid&&this.options.visibleGrid&&this.drawCachedGrid(e,t)}drawCachedGrid(e,t){!1===this.gridCache&&this.cacheGrid(t);let s=this.gridCache,i=s.width,a=s.height,r=this.scene.screen.center,o=2+(r.x/i|0),n=2+(r.y/a|0),h=this.camera.zoom,l=this.camera.position.x*h%i,c=this.camera.position.y*h%a;e.globalAlpha=this.gridCacheAlpha;for(var d=-o;o>d;d++)for(var p=-n;n>p;p++){var u=d*i-l+r.x,m=p*a-c+r.y;e.drawImage(s,0,0,a,i,u,m,i,a)}e.globalAlpha=1}cacheGrid(){if(window.lite&&lite.storage.get("isometricGrid"))return this.cacheIsometricGrid();let e=this.scene.camera.zoom,t=200*e,s=200*e,i=this.options.gridSize*e,a=document.createElement("canvas");a.width=t,a.height=s;let r=a.getContext("2d");r.strokeStyle=this.options.gridMinorLineColor,r.strokeWidth=1*window.devicePixelRatio,r.beginPath();let o=null,n=null,h=null,l=null;for(o=Math.floor(t/i),n=0;o>=n;n++)h=n*i,r.moveTo(h,0),r.lineTo(h,s);for(o=Math.floor(s/i),n=0;o>=n;n++)l=n*i,r.moveTo(0,l),r.lineTo(t,l);r.stroke(),r.beginPath(),r.rect(0,0,t,s),r.lineWidth=2*window.devicePixelRatio,r.strokeStyle=this.options.gridMajorLineColor,r.stroke(),this.gridCache=a,this.gridCacheAlpha=Math.min(e+.2,1)}cacheIsometricGrid(){let e=this.scene.camera.zoom,t=200*e,s=200*e,i=this.options.gridSize*e,a=document.createElement("canvas");a.width=t,a.height=s;let r=a.getContext("2d");r.fillStyle=this.options.gridMinorLineColor;for(let a=Math.floor(t/i),o=0;a>=o;o++)for(let t=Math.floor(s/i),a=0;t>=a;a+=.5)r.beginPath(),r.arc(2*a*i,(o+a%1)*i,1*e,0,2*Math.PI),r.fill();this.gridCache=a,this.gridCacheAlpha=Math.min(e+.2,1)}resize(){let e=this.scene.game.pixelRatio;this.cacheGrid(e)}undo(){}redo(){}close(){this.actionTimeline=[],this.actionTimelinePointer=0,this.tools=null,this.mouse=null,this.scene=null,this.camera=null,this.options.grid=!1,this.options=null,this.gridCache=null}},j=class{settings=null;container={borderRadius:25,font:17.5,text:"00:00",scaleX:window.devicePixelRatio/2,scaleY:window.devicePixelRatio/2,width:200,height:60,x:100,y:30};constructor(e){Object.defineProperty(this,"scene",{value:e,writable:!0}),this.settings=e.settings,this.removePlayer(),this.createPulseTween()}setPlayer(e){this.player=e}removePlayer(){this.player=!1}playerAddedTime(e){this.player===e&&this.createPulseTween()}createPulseTween(){let e=this.scene.game.pixelRatio/2;this.tweenRemaining=200,this.tweenStart=e,this.tweenScale=1.2*e}center_container(){let e=this.scene.screen,t=this.container;t.x=e.width/2-100*t.scaleX,t.y=e.height-100*t.scaleY}draw(e){e.save(),e.fillStyle="rgba(242,144,66,0.5)",e.strokeStyle="rgba(242,144,66,1)",e.lineWidth=5*window.devicePixelRatio/2,e.beginPath(),e.roundRect(this.container.x,this.container.y,this.container.width*this.container.scaleX,this.container.height*this.container.scaleY,this.container.borderRadius*this.container.scaleY),e.fill(),e.stroke(),e.font=this.container.font*window.devicePixelRatio+"px helsinki",e.fillStyle="#000",e.textAlign="center",e.textBaseline="middle",e.fillText(this.container.text,this.container.x+this.container.width/2*this.container.scaleX,this.container.y+this.container.height/2*this.container.scaleY),e.restore()}fixedUpdate(){if(this.tweenRemaining>0){this.tweenRemaining=Math.max(this.tweenRemaining-1e3/this.scene.game.settings.drawFPS);let e=this.container;e.scaleX=e.scaleY=e.scaleX*(1-this.tweenRemaining/100)+this.tweenScale*(this.tweenRemaining/100),e.scaleX==this.tweenScale&&(this.tweenScale=this.tweenStart)}this.player&&this.player._tempVehicleTicks>0?(this.center_container(),this.updateTime()):this.container.visible=!1}updateTime(){let e=(this.player._tempVehicleTicks/this.scene.settings.drawFPS).toFixed(2),t="";10>e&&(t="0"),t+=e,this.container.text=t,this.container.visible=!0}close(){this.container=null,this.player=null,this.scene=null,this.settings=null}},H=class{tickDownButtons={};previousTickDownButtons={};downButtons={};paused=!1;keymap={};records={};keysToRecord=null;keysToPlay=null;recording=!1;playback=null;numberOfKeysDown=0;tickNumberOfKeysDown=0;replaying=!1;constructor(e){Object.defineProperty(this,"scene",{value:e,writable:!0})}listen(){document.onkeydown=this.handleButtonDown.bind(this),document.onkeyup=this.handleButtonUp.bind(this),window.onblur=this.handleBlur.bind(this),window.onfocus=this.handleFocus.bind(this)}unlisten(){this.downButtons={},document.onkeydown=null,document.onkeyup=null,window.onblur=null,window.onfocus=null}pause(){this.paused=!0}unpause(){this.paused=!1}recordKeys(e){this.keysToRecord=e,this.recording=!0}loadPlayback(e,t){this.keysToPlay=t,this.playback=e,this.replaying=!0}setKeyMap(e){let t={};for(let s in e)if(e[s]instanceof Array)for(let i of e[s])t[i]=s;else t[e[s]]=s;this.keymap=t}handleButtonDown(e){let t=this.getInternalCode(e.keyCode);"string"==typeof t&&e.preventDefault(),this.setButtonDown(t)}handleButtonUp(e){let t=this.getInternalCode(e.keyCode);"string"==typeof t&&e.preventDefault(),this.setButtonUp(t)}blurred=!1;previousDownButtons={};handleBlur(){this.blurred=!0,this.previousDownButtons=Object.assign({},this.tickDownButtons)}handleFocus(){this.blurred&&(this.tickDownButtons=Object.assign({},this.previousDownButtons),this.downButtons=Object.fromEntries(Object.keys(this.tickDownButtons).map((e=>[e,!1]))))}getInternalCode(e){return this.keymap[e]||e}setButtonsDown(e){for(let t in e)this.setButtonDown(e[t])}setButtonUp(e){this.blurred=!1,this.downButtons[e]&&(this.onButtonUp&&this.onButtonUp(e),this.downButtons[e]=!1,this.numberOfKeysDown--)}setButtonDown(e,t){this.blurred=!1,this.downButtons[e]||(this.onButtonDown&&this.onButtonDown(e),this.downButtons[e]=t||!0,this.numberOfKeysDown++)}isButtonDown(e){return this.tickDownButtons[e]>0}getButtonDownOccurances(e){let t=0;if(this.isButtonDown(e)){t=1;let s=this.tickDownButtons[e];!0!==s&&(t=s)}return t}getDownButtons(){let e=[];for(let t in this.tickDownButtons)this.tickDownButtons[t]&&e.push(t);return e}reset(e){(this.replaying||e)&&(this.downButtons={},this.playbackTicks=0),this.tickDownButtons={},this.previousDownButtons={},this.previousTickDownButtons={},this.records={}}update(){this.replaying&&this.updatePlayback(),!this.blurred&&(this.previousTickDownButtons=Object.assign({},this.tickDownButtons),this.tickDownButtons=Object.assign({},this.downButtons)),this.tickNumberOfKeysDown=this.numberOfKeysDown,this.recording&&this.updateRecording()}areKeysDown(){for(let e in this.downButtons)if(!0===this.downButtons[e])return!0;return!1}updatePlayback(){let e=this.playback,t=this.playbackTicks??this.scene.ticks;for(let s of this.keysToPlay){let i=s+"_up",a=s+"_down";if(void 0!==e[a]&&void 0!==e[a][t]){let i=e[a][t];this.setButtonDown(s,i)}void 0!==e[i]&&void 0!==e[i][t]&&this.setButtonUp(s)}}updateRecording(){let e=this.scene.ticks,t=this.records,s=this.tickDownButtons,i=this.previousTickDownButtons;for(let a of this.keysToRecord.filter((e=>void 0!==s[e]))){let r=s[a];if(r!==(void 0!==i[a]&&i[a])){let s=a+"_down",i=a+"_up";r&&(i=s),!r&&t[s]&&-1!==t[s].indexOf(e)?/^(backspace|enter)$/.test(a)?(t[i]||(t[i]=[]),t[i].push(e+1)):(t[s].splice(t[s].indexOf(e),1),t[s].length||delete t[s]):(t[i]||(t[i]=[]),t[i].push(e))}}}buttonWasRecentlyDown(e){let t=this.records;this.replaying&&(t=this.playback);let s=e+"_down",i=!1;if(t[s]){let e=(this.replaying&&this.playbackTicks)??this.scene.ticks,a=t[s],r=-1;r=this.replaying?void 0!==a[e]:a.indexOf(e),-1!==r&&(i=!0)}return i}getReplayString(){return JSON.stringify(this.records)}encodeReplayString(e){let t={version:this.scene.settings.replayVersion};for(let s in e){let i=e[s];t[s]="";for(let e in i){let a=i[e];t[s]+=a.toString(32)+" "}}return t}close(){this.unlisten(),this.handleButtonUp=null,this.handleButtonDown=null,this.onButtonDown=null,this.onButtonUp=null,this.scene=null,this.tickDownButtons=null,this.downButtons=null,this.keymap=null,this.records=null,this.keysToRecord=null}},W=class{pos=null;old=null;vel=null;radius=0;friction=0;collide=!0;contact=!1;constructor(e,t){Object.defineProperties(this,{parent:{value:t,writable:!0},scene:{value:t.scene,writable:!0}}),this.pos=new o,this.old=new o,this.vel=new o(0,0),this.radius=10,this.pos.equ(e),this.old.equ(e)}drive(e,t){let s=this.friction,i=-(e*this.vel.x+t*this.vel.y)*s;e*=i,t*=i,this.pos.x+=e,this.pos.y+=t,this.contact=!0}fixedUpdate(){let e=this.parent.gravity;this.vel.inc(e),(0!=e.x||0!=e.y)&&this.vel.factorSelf(.99),this.pos.inc(this.vel),this.contact=!1,this.collide&&this.scene.track.collide(this),this.vel.equ(this.pos.sub(this.old)),this.old.equ(this.pos)}draw(e){let t=this.pos.toScreen(this.scene),s=this.scene.camera.zoom;e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.arc(t.x,t.y,this.radius*s,0,2*Math.PI,!1),e.fill()}},U=class extends W{wind=!0;constructor(e,t,s){super(new o(e,t),s)}drive(e,t){this.pos.x+=.05*e*-e*(e*this.vel.x+t*this.vel.y),this.contact=!0}fixedUpdate(){let e=this.vel,t=this.pos,s=this.old,i=this.parent.gravity,a=this.parent.gamepad,r=a.isButtonDown("up"),o=a.isButtonDown("left"),n=a.isButtonDown("right");(0!==i.x||0!==i.y)&&(e.x=.9*e.x,e.y=.99*e.y),o&&(t.x+=-.05),n&&(t.x+=.05),(0!==i.x||0!==i.y)&&(t.y+=-.1),r&&(t.y+=-.5),this.wind&&(t.x+=.3),t.x+=e.x,t.y+=e.y,this.contact=!1,this.collide&&this.scene.track.collide(this),(0!==i.x||0!==i.y)&&(e.x=t.x-s.x,e.y=t.y-s.y),s.x=t.x,s.y=t.y}draw(e){let t=this.scene,s=this.pos.toScreen(t),i=this.radius*t.camera.zoom;e.beginPath(),e.fillStyle=this.scene.settings.physicsLineColor,e.arc(s.x,s.y,i,0,2*Math.PI,!1),e.closePath(),e.fill()}},V=class{m1=null;m2=null;lrest=40;leff=40;dampConstant=0;springConstant=0;constructor(e,t,s){Object.defineProperty(this,"parent",{value:s}),this.m1=e,this.m2=t,this.lrest=40,this.leff=40,this.dampConstant=.5,this.springConstant=.7}swap(){let e=new o,t=this.m1,s=this.m2;e.equ(t.pos),t.pos.equ(s.pos),s.pos.equ(e),e.equ(t.old),t.old.equ(s.old),s.old.equ(e),e.equ(t.vel),t.vel.equ(s.vel),s.vel.equ(e),e=t.angle,t.angle=s.angle,s.angle=e}fixedUpdate(){let e=this.m1,t=this.m2,s=e.pos,i=t.pos,a=e.vel,r=t.vel,n=new o(i.x-s.x,i.y-s.y),h=n.len();if(!(1>h)){let e=1/h;n.x*=e,n.y*=e;let t=(h-this.leff)*this.springConstant,s={x:n.x*t,y:n.y*t},i=r.x-a.x,o=r.y-a.y,l=(i*n.x+o*n.y)*this.dampConstant,c=n.x*l,d=n.y*l;s.x+=c,s.y+=d,r.x+=-s.x,r.y+=-s.y,a.x+=s.x,a.y+=s.y}}rotate(e){let t=this.m1,s=this.m2,i=s.pos.x-t.pos.x,a=-(s.pos.y-t.pos.y)/this.leff,r=i/this.leff;t.pos.x+=a*e,t.pos.y+=r*e,s.pos.x+=a*-e,s.pos.y+=r*-e}contract(e,t){this.leff+=(this.lrest-e-this.leff)/t}setMasses(e,t){this.m1=e,this.m2=t}};let q=[1,.7,.8,.9,.5,1,.7,1];const G=class extends W{angle=6.2*Math.random();color="black";friction=.05;radius=2*Math.random()*5;speed=1*Math.random()-1*Math.random();constructor(e,t,s){super(e,t),this.color=s,this.pos.x=e.x+5*(Math.random()-Math.random()),this.pos.y=e.y+5*(Math.random()-Math.random()),this.old.x=this.pos.x,this.old.y=this.pos.y,this.vel.y=11*(Math.random()-Math.random()),this.vel.x=11*(Math.random()-Math.random())}drive(e,t){let s=this.vel,i=this.pos;this.speed=(e*s.x+t*s.y)/this.radius,this.angle+=this.speed;let a=-(e*s.x+t*s.y)*this.friction;i.x+=e*a,i.y+=t*a;let r=Math.sqrt(Math.pow(e,2)+Math.pow(t,2));if(r>0){let i=-t/r,a=e/r,o=.8*(i*s.x+a*s.y);this.old.x+=i*o,this.old.y+=a*o}}fixedUpdate(){this.angle+=this.speed,super.fixedUpdate()}draw(e){let t=this.scene.screen,s=this.scene.camera,i=t.realToScreen(this.pos.x,"x"),a=t.realToScreen(this.pos.y,"y"),r=0,o=s.zoom,n=this.angle,h=q[0]*o*this.radius,l=i+h*Math.cos(n),c=a+h*Math.sin(n),d=2*Math.PI;for(e.lineWidth=1*o,e.strokeStyle=this.color,e.beginPath(),e.moveTo(l,c),e.fillStyle=this.color;r++<8;)h=q[r-1]*o*this.radius,l=i+h*Math.cos(n+d*r/8),c=a+h*Math.sin(n+d*r/8),e.lineTo(l,c);e.fill(),e.stroke()}},N=class{complete=!1;gravity=new o(0,.3);powerupsEnabled=!1;time=20;constructor(e,t){Object.defineProperty(this,"scene",{value:t,writable:!0}),this.positionX=e.x,this.positionY=e.y,this.createMasses(e)}draw(e,t){let s=this.time,i=this.positionX,a=this.positionY,r=this.scene.camera.zoom,o=this.scene.screen;if(e.globalAlpha=t,s>0){s-=10;let t=o.realToScreen(i,"x"),n=o.realToScreen(a,"y"),h=0,l=6.2*Math.random(),c=s*r,d=t+c*Math.cos(l),p=n+c*Math.sin(l);for(e.beginPath(),e.moveTo(d,p),e.fillStyle=this.scene.settings.physicsLineColor;h++<16;)c=(s+30*Math.random())*r,d=t+c*Math.cos(l+6.283*h/16),p=n+c*Math.sin(l+6.283*h/16),e.lineTo(d,p);e.fill()}let n=this.masses;for(let t in n)n[t].draw(e);e.globalAlpha=1,this.time=s}createMasses(e){this.masses=[],this.masses.push(new G(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new G(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new G(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new G(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new G(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new G(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new G(e,this,this.scene.settings.physicsLineColor))}fixedUpdate(){for(let e of this.masses)e.fixedUpdate()}update(e,t){for(let s of this.masses)s.update(e,t)}},Z=class{color="#".padEnd(7,"midnight"==lite.storage.get("theme")?"C":"dark"==lite.storage.get("theme")?"FB":"0");masses=null;springs=null;slow=!1;constructor(e){Object.defineProperty(this,"player",{value:e,writable:!0}),Object.defineProperty(this,"scene",{value:e._scene,writable:!0}),this.gamepad=e._gamepad,this.settings=e._settings,this.gravity=new o(0,.3),this.complete=!1,this.alive=!0,this.crashed=!1,this.dir=1,this.ghost=!1,this.ragdoll=!1,this.explosion=!1,this.speed=0,this.powerupsEnabled=!0,this.createCosmetics()}explode(){this.scene.sound.play("bomb_sound",1),this.explosion=new N(this.masses[0].pos,this.scene),this.dead()}createCosmetics(){this.cosmetics=this.player._user.cosmetics}updateSpeed(){this.speed=Math.abs(Math.round(this.focalPoint.vel.x+this.focalPoint.vel.y))}close(){this.scene=null,this.settings=null,this.gravity=null,this.speed=null,this.cosmetics=null,this.explosion=null,this.ragdoll=null,this.ghost=null,this.crashed=null,this.alive=null,this.gamepad=null}dead(){this.stopSounds(),this.player.dead(),this.crashed=!0,this.alive=!1}moveVehicle(e,t){for(var s=this.masses,i=s.length-1;i>=0;i--)s[i].pos.x+=e,s[i].pos.y+=t,s[i].old.x+=e,s[i].old.y+=t}stopSounds(){}};let J="balloon_on";const X=class extends W{angle=0;brake=!1;motor=0;rotationSpeed=0;speed=0;drive(e,t){let s=this.pos,i=this.motor*this.parent.dir,a=i*e,r=i*t;if(s.x+=a,s.y+=r,this.brake){let i=.3*-(e*this.vel.x+t*this.vel.y),a=e*i,r=t*i;s.x+=a,s.y+=r}this.speed=(e*this.vel.x+t*this.vel.y)/this.radius,this.rotationSpeed=this.speed,this.angle+=this.speed,this.contact=!0}fixedUpdate(){super.fixedUpdate(),this.rotationSpeed=.999*this.rotationSpeed}};let Y="blob_sound";const K=class{constructor(e,t){Object.defineProperty(this,"parent",{value:t});let s,i,a,r,n,h,l,c,d,p,u=[],m=[],g=new o(0,0);s=new W(g,t),i=new W(g,t),a=new W(g,t),r=new W(g,t),h=new W(g,t),n=new W(g,t),l=new W(g,t),c=new W(g,t),d=new W(g,t),p=new W(g,t),u.push(s),u.push(i),u.push(a),u.push(r),u.push(h),u.push(n),u.push(l),u.push(c),u.push(d),u.push(p),m.push(new V(s,i,this)),m.push(new V(s,a,this)),m.push(new V(a,h,this)),m.push(new V(s,r,this)),m.push(new V(r,n,this)),m.push(new V(i,l,this)),m.push(new V(l,d,this)),m.push(new V(i,c,this)),m.push(new V(c,p,this));for(let e in u)u[e].friction=.05,u[e].radius=3;for(var y in s.radius=i.radius=8,m)m[y].dampConstant=.7,m[y].springConstant=.4;for(var y in this.masses=u,this.springs=m,this.head=s,this.waist=i,this.lElbow=a,this.rElbow=r,this.rHand=n,this.lHand=h,this.lKnee=l,this.rKnee=c,this.lFoot=d,this.rFoot=p,e)this[y].pos.equ(e[y])}zero(e,t){e=e.factor(.7),t=t.factor(.7);let s=this.springs,i=this.masses;for(let e in s){let t=s[e].m2.pos.sub(s[e].m1.pos).len();s[e].lrest=t,s[e].leff=t}for(let e=1;4>=e;e++)s[e].lrest=13,s[e].leff=13;for(let e in s.filter((e=>e.leff>20)))s[e].lrest=20,s[e].leff=20;let a=[this.head,this.lElbow,this.rElbow,this.lHand,this.rHand],r=[this.waist,this.lKnee,this.rKnee,this.lFoot,this.rFoot];for(let t in a)a[t].old=a[t].pos.sub(e);for(let e in r)r[e].old=r[e].pos.sub(t);for(let e in i)i[e].vel.equ(i[e].pos.sub(i[e].old)),i[e].vel.x+=1*(Math.random()-Math.random()),i[e].vel.y+=1*(Math.random()-Math.random())}draw(e){let t=this.head,s=this.waist,i=this.lElbow,a=this.rElbow,r=this.rHand,o=this.lHand,n=this.lKnee,h=this.rKnee,l=this.lFoot,c=this.rFoot,d=this.parent.scene,p=d.camera.zoom,u=this.parent.alpha??1,m=d.settings.physicsLineColor,g=m.padEnd(7,m.slice(1,4));e.strokeStyle=g+Math.min(255,Math.round(127.5*u)).toString(16),e.lineWidth=5*p;let y=t.pos.toScreen(d);e.beginPath(),e.moveTo(y.x,y.y);let f=i.pos.toScreen(d);e.lineTo(f.x,f.y);let w=o.pos.toScreen(d);e.lineTo(w.x,w.y),e.stroke(),e.strokeStyle=g+Math.min(255,Math.round(255*u)).toString(16),e.beginPath(),e.moveTo(y.x,y.y);let x=a.pos.toScreen(d);e.lineTo(x.x,x.y);let v=r.pos.toScreen(d);e.lineTo(v.x,v.y),e.stroke(),e.lineWidth=8*p,e.beginPath(),e.moveTo(y.x,y.y);let b=s.pos.toScreen(d);e.lineTo(b.x,b.y),e.stroke(),e.lineWidth=5*p,e.beginPath(),e.moveTo(b.x,b.y);let k=n.pos.toScreen(d);e.lineTo(k.x,k.y);let T=l.pos.toScreen(d);e.lineTo(T.x,T.y);let S=n.pos.sub(s.pos).normalize();S.factorSelf(4),S.inc(l.pos);let _=S.toScreen(d);e.lineTo(_.x,_.y),e.stroke(),e.strokeStyle=g+Math.min(255,Math.round(127.5*u)).toString(16),e.lineWidth=5*p,e.beginPath(),e.moveTo(b.x,b.y);let C=h.pos.toScreen(d);e.lineTo(C.x,C.y);let P=h.pos.sub(s.pos).normalize();P=P.factor(4).add(c.pos);let M=c.pos.toScreen(d);e.lineTo(M.x,M.y);let A=P.toScreen(d);e.lineTo(A.x,A.y),e.stroke(),y.inc(y.sub(b).factor(.25));let z=GameInventoryManager.getItem(this.parent.cosmetics.head),D=this.drawHeadAngle;z.draw(e,y.x,y.y,D,p,this.dir,1)}fixedUpdate(){for(let e of this.springs)e.fixedUpdate();for(let e of this.masses)e.fixedUpdate();this.updateDrawHeadAngle()}update(e){for(let t of this.masses)t.update(e)}updateDrawHeadAngle(){let e=this.head.pos,t=this.waist.pos;this.dir<0&&([e,t]=[t,e]);let s=e.x,i=e.y,a=s-t.x,r=i-t.y;this.drawHeadAngle=-(Math.atan2(a,r)+Math.PI)}};let Q="bike_ground",ee="bike_air";const te=class extends Z{cosmeticHead=null;cosmeticRearWheel=null;cosmeticFrontWheel=null;pedala=0;swapped=!1;ragdoll=null;createSprings(){this.springs=[];let e=new V(this.head,this.rearWheel,this),t=new V(this.rearWheel,this.frontWheel,this),s=new V(this.frontWheel,this.head,this);this.springs.push(e),this.springs.push(t),this.springs.push(s),this.rearSpring=e,this.chasse=t,this.frontSpring=s}createRagdoll(){this.ragdoll=new K(this.getStickMan(),this),this.ragdoll.zero(this.head.vel,this.rearWheel.vel),this.ragdoll.dir=this.dir,this.rearWheel.motor=0,this.rearWheel.brake=!1,this.frontWheel.brake=!1,this.head.collide=!1,this.updateCameraFocalPoint(),this.player.isInFocus()&&this.playBailSound(),this.dead()}playBailSound(){let e=this.scene.sound,t=Math.min(this.speed/50,1);switch(Math.floor(3*Math.random())+1){case 1:e.play("bike_fall_1",t);break;case 2:e.play("bike_fall_2",t);break;case 3:e.play("bike_fall_3",t)}}updateCameraFocalPoint(){this.focalPoint=this.ragdoll?this.ragdoll.head:this.head}getStickMan(){let e=this.dir,t=this.head,s=this.frontWheel,i=this.rearWheel,a=this.pedala,r=s.pos.sub(i.pos),n=t.pos.sub(s.pos.add(i.pos).factor(.5)),h=new o(r.y*e,-r.x*e),l={};l.head=i.pos.add(r.factor(.35)).add(n.factor(1.2)),l.lHand=l.rHand=i.pos.add(r.factor(.8)).add(h.factor(.68));var c=l.head.sub(l.lHand);c=new o(c.y*e,-c.x*e),l.lElbow=l.rElbow=l.head.add(l.lHand).factor(.5).add(c.factor(130/c.lenSqr())),l.waist=i.pos.add(r.factor(.2)).add(h.factor(.5));var d=new o(6*Math.cos(a),6*Math.sin(a));return l.lFoot=i.pos.add(r.factor(.4)).add(h.factor(.05)).add(d),c=l.waist.sub(l.lFoot),c=new o(-c.y*e,c.x*e),l.lKnee=l.waist.add(l.lFoot).factor(.5).add(c.factor(160/c.lenSqr())),l.rFoot=i.pos.add(r.factor(.4)).add(h.factor(.05)).sub(d),c=l.waist.sub(l.rFoot),c=new o(-c.y*e,c.x*e),l.rKnee=l.waist.add(l.rFoot).factor(.5).add(c.factor(160/c.lenSqr())),l}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{for(let e=this.springs,t=e.length-1;t>=0;t--)e[t].fixedUpdate();for(let e=this.masses,t=e.length-1;t>=0;t--)e[t].fixedUpdate();if(this.rearWheel.contact&&this.frontWheel.contact&&(this.slow=!1),!1===this.slow){!1===this.crashed&&this.control();for(let e=this.springs,t=e.length-1;t>=0;t--)e[t].fixedUpdate();for(let e=this.masses,t=e.length-1;t>=0;t--)e[t].fixedUpdate()}this.ragdoll?this.ragdoll.fixedUpdate():this.updateDrawHeadAngle()}this.updateCameraFocalPoint()}updateSound(){if(this.player.isInFocus()){this.updateSpeed();let e=Math.min(this.speed/50,1),t=this.scene.sound;this.rearWheel.contact||this.frontWheel.contact?(t.play(Q,e),t.stop(ee)):(t.play(ee,e),t.stop(Q))}}stopSounds(){let e=this.scene.sound;e.stop(ee),e.stop(Q)}swap(){this.dir=-1*this.dir,this.chasse.swap();let e=this.rearSpring.leff;this.rearSpring.leff=this.frontSpring.leff,this.frontSpring.leff=e}draw(e){if(this.explosion)this.explosion.draw(e,1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite&&parseInt(lite.storage.get("snapshots"));if(t>0){for(let s of this.player._checkpoints.filter(((e,s,i)=>s>i.length-(t+1)&&e._baseVehicle)))this.drawBikeFrame.call(Object.assign({},this,{scene:this.scene},JSON.parse(s._baseVehicle)),e,t/300*this.player._checkpoints.indexOf(s)%1);for(let s of this.player._cache.filter(((e,s,i)=>s>i.length-(t+1)&&e._baseVehicle)))this.drawBikeFrame.call(Object.assign({},this,{scene:this.scene},JSON.parse(s._baseVehicle)),e,t/300*this.player._cache.indexOf(s)%1)}}if(window.lite&&lite.storage.get("playerTrail"))for(let t of lite.snapshots.filter((e=>e._baseVehicle)))this.drawBikeFrame.call(Object.assign({},this,{scene:this.scene},JSON.parse(t._baseVehicle)),e,lite.snapshots.length/(200*lite.snapshots.length)*lite.snapshots.indexOf(t)%1)}if(e.imageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,this.settings.developerMode)for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].draw(e);this.drawBikeFrame(e)}}updateDrawHeadAngle(){let e=this.frontWheel.pos,t=this.rearWheel.pos,s=e.x,i=e.y,a=s-t.x,r=i-t.y;this.drawHeadAngle=-(Math.atan2(a,r)-Math.PI/2)}},se=class extends W{motor=0;angle=null;speed=0;constructor(e,t){super(e,t),this.angle=new o(0,0)}fixedUpdate(){let e=this.vel,t=this.angle,s=this.pos,i=this.old,a=this.motor;e.inc(t.factor(2*a)),s.inc(e.factor(.99)),this.contact=!1,this.collide&&this.scene.track.collide(this),this.vel=s.sub(i),i.equ(s)}};let ie="helicopter";window.GameInventoryManager=new class{cache={};inventory={};loaded=new Set;constructor(){Object.defineProperty(this,"cache",{enumerable:!1})}getItem(e){let t=e.classname,s=e.script,i=e.options,a=e.type;this.inventory[t]||("1"===a&&(t="forward_cap",i={back:"white"}),this.loaded.has(s)||(this.loaded.add(s),GameManager.loadFile(s)));let r=this.generateID(a,t,i);return this.cache[r]||=new this.inventory[t](i)}redraw(){let e=this.cache;for(let t in e)e[t].setDirty()}generateID(e,t,s){if(t=e+t,s)for(let e in s)s.hasOwnProperty(e)&&(t+=s[e]);return t}register(e,t){this.inventory[e]=t}clear(){this.cache={},this.inventory={},this.loaded.clear()}},GameInventoryManager.HeadClass=class{versions={};createVersion(){let e=this.colors,t=this.getVersions(),s="";for(let t in e)s+=e[t];this.versionName=s,t[s]||={dirty:!0,canvas:document.createElement("canvas")}}draw(e,t,s,i,a,r){let o=this.getCache(a),n=this.getScale(),h=this.getBaseWidth()*a*n,l=this.getBaseHeight()*a*n,c=this.getDrawOffsetX()*a-h/2,d=this.getDrawOffsetY()*a-l/2,p=-1===r;e.translate(t,s),e.rotate(i),p&&e.scale(1,-1),e.drawImage(o,c,d,h,l),p&&e.scale(1,-1),e.rotate(-i),e.translate(-t,-s)}getCache(e){let t=this.getVersions();return t[this.versionName].dirty&&this.cache(e),t[this.versionName].canvas}getVersions(){return this.versions}setDirty(){this.getVersions()[this.versionName].dirty=!0}};class ae extends GameInventoryManager.HeadClass{drawAngle=0;constructor(e){super(),this.colors=e,this.createVersion()}cache(e){let t=this.versions[this.versionName],s=t.canvas,i=this.getScale()*Math.max(e,1);t.dirty=!1,s.width=this.getBaseWidth()*i,s.height=this.getBaseHeight()*i;let a=s.getContext("2d"),r=this.colors,o=Math.PI/12;a.scale(i,i),a.strokeStyle=r.outline||"darker"===lite.storage.get("theme")?"hsl(0, 0%, 100%)":"dark"===lite.storage.get("theme")?"hsl(0, 0%, 98%)":"midnight"===lite.storage.get("theme")?"hsl(0, 0%, 80%)":"hsl(0, 0%, 0%)",a.lineCap="round",a.lineJoin="miter",a.lineWidth=7,a.miterLimit=4,a.fillStyle=r.skin||"darker"===lite.storage.get("theme")?"hsl(231, 16%, 8%)":"dark"===lite.storage.get("theme")?"hsl(0, 0%, 11%)":"midnight"===lite.storage.get("theme")?"hsl(207, 16%, 14%)":"hsl(0, 0%, 100%)",a.save(),a.beginPath(),a.arc(42.4,52.5,30.3+a.lineWidth/2,0,2*Math.PI,!0),a.fill(),a.stroke(),a.clip(),a.beginPath(),a.arc(42.4,52.5,30.3,-o,Math.PI-o,!0),a.fillStyle=r.back,a.fill(),r.front&&(a.beginPath(),a.arc(42.4,52.5,30.3,-o,o-Math.PI/1.75,!0),a.lineTo(52.501,44.894999999999996),a.fillStyle=r.front,a.fill()),a.restore(),a.lineWidth=12,a.beginPath(),a.moveTo(16.3,60),a.lineTo(103.5,36.5),a.stroke()}getBaseWidth(){return 115}getBaseHeight(){return 112}getDrawOffsetX(){return 2.2}getDrawOffsetY(){return 1}getScale(){return.17}}GameInventoryManager&&GameInventoryManager.register("forward_cap",ae);let re="truck_idle",oe=0,ne={BMX:class extends te{vehicleName="BMX";constructor(e,t,s,i){super(e),this.createMasses(t,i),this.createSprings(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createMasses(e,t){this.masses=[];var s=new W(new o(e.x,e.y-36),this),i=new X(new o(e.x+21,e.y+3),this),a=new X(new o(e.x+-21,e.y+3),this);s.drive=this.createRagdoll.bind(this),a.radius=11.7,i.radius=11.7,s.radius=14,s.vel.equ(t),a.vel.equ(t),i.vel.equ(t),this.masses.push(s),this.masses.push(a),this.masses.push(i),this.head=s,this.frontWheel=i,this.rearWheel=a}createSprings(){super.createSprings(),this.chasse.lrest=42,this.chasse.leff=42,this.chasse.springConstant=.35,this.chasse.dampConstant=.3,this.rearSpring.lrest=45,this.rearSpring.leff=45,this.rearSpring.springConstant=.35,this.rearSpring.dampConstant=.3,this.frontSpring.lrest=45,this.frontSpring.leff=45,this.frontSpring.springConstant=.35,this.frontSpring.dampConstant=.3}control(){let e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),r=e.isButtonDown("z"),o=this.rearWheel;o.motor+=(t-o.motor)/10,r&&!this.swapped&&(this.swap(),this.swapped=!0),r||(this.swapped=!1),t&&(this.pedala+=this.rearWheel.speed/5),o.brake=s,s&&this.frontSpring.contract(-10,10),this.frontWheel.brake=!!(this.dir>0&&a&&s)||!!(this.dir<0&&i&&s);let n=i-a;this.rearSpring.contract(5*n*this.dir,5),this.frontSpring.contract(5*-n*this.dir,5),this.chasse.rotate(n/6),!n&&t&&(this.rearSpring.contract(-7,5),this.frontSpring.contract(7,5))}drawBikeFrame(e,t=this.player._opacity){let s=this.scene,i=new o(this.rearWheel.pos.x,this.rearWheel.pos.y),a=new o(this.frontWheel.pos.x,this.frontWheel.pos.y),r=new o(this.head.pos.x,this.head.pos.y),n=i.toScreen(s),h=a.toScreen(s),l=r.toScreen(s),c=h.sub(n),d=this.dir,p=new o((h.y-n.y)*d,(n.x-h.x)*d),u=this.pedala,m=s.camera.zoom,g=s.settings.physicsLineColor;e.globalAlpha=t,e.strokeStyle=g,e.lineWidth=3*m,e.beginPath(),e.fillStyle=s.settings.sceneryLineColor.padEnd(7,s.settings.sceneryLineColor.slice(1,4))+"33",e.arc(h.x,h.y,10.5*m,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(n.x,n.y,10.5*m,0,2*Math.PI,!1),e.fill(),e.stroke();let y=n.add(c.factor(.3)).add(p.factor(.25)),f=n.add(c.factor(.4)).add(p.factor(.05)),w=n.add(c.factor(.84)).add(p.factor(.42)),x=n.add(c.factor(.84)).add(p.factor(.37));e.beginPath(),e.strokeStyle=this.color,e.moveTo(n.x,n.y),e.lineTo(y.x,y.y),e.lineTo(w.x,w.y),e.moveTo(x.x,x.y),e.lineTo(f.x,f.y),e.lineTo(n.x,n.y),e.stroke(),e.beginPath(),e.strokeStyle=this.color,e.lineWidth=Math.max(1*m,.5),e.arc(f.x,f.y,3*m,0,2*Math.PI,!1),e.stroke();let v=new o(6*Math.cos(u)*m,6*Math.sin(u)*m),b=f.add(v),k=f.sub(v);e.beginPath(),e.moveTo(b.x,b.y),e.lineTo(k.x,k.y),e.stroke();let T=n.add(c.factor(.25)).add(p.factor(.4)),S=n.add(c.factor(.17)).add(p.factor(.38)),_=n.add(c.factor(.3)).add(p.factor(.45));e.beginPath(),e.strokeStyle=this.color,e.lineWidth=3*m,e.moveTo(S.x,S.y),e.lineTo(_.x,_.y),e.moveTo(f.x,f.y),e.lineTo(T.x,T.y);let C=n.add(c.factor(1)).add(p.factor(0)),P=n.add(c.factor(.97)).add(p.factor(0)),M=n.add(c.factor(.8)).add(p.factor(.48));e.moveTo(C.x,C.y),e.lineTo(P.x,P.y),e.lineTo(M.x,M.y);let A=n.add(c.factor(.86)).add(p.factor(.5)),z=n.add(c.factor(.82)).add(p.factor(.65)),D=n.add(c.factor(.78)).add(p.factor(.67));if(e.lineTo(A.x,A.y),e.lineTo(z.x,z.y),e.lineTo(D.x,D.y),e.stroke(),this.crashed)this.ragdoll&&this.ragdoll.draw(e);else{p=l.sub(n.add(c.factor(.5)));let s=y.add(c.factor(-.1)).add(p.factor(.3)),i=b.sub(s),a=new o(i.y*d,-i.x*d);a=a.factor(m*m);let r=s.add(i.factor(.5)).add(a.factor(200/i.lenSqr())),h=b.add(i.factor(.12)).add(a.factor(50/i.lenSqr()));i=k.sub(s),a=new o(i.y*d,-i.x*d),a=a.factor(m*m);let u=s.add(i.factor(.5)).add(a.factor(200/i.lenSqr())),f=k.add(i.factor(.12)).add(a.factor(50/i.lenSqr()));e.strokeStyle=g.padEnd(7,g.slice(1,4))+Math.min(255,Math.round(127.5*t)).toString(16),e.lineWidth=6*m,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(u.x,u.y),e.lineTo(s.x,s.y),e.stroke(),e.lineWidth=4*m,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(f.x,f.y),e.stroke(),e.lineWidth=6*m,e.strokeStyle=g,e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(r.x,r.y),e.lineTo(b.x,b.y),e.lineTo(h.x,h.y),e.stroke();let w=y.add(c.factor(.05)).add(p.factor(.9));e.lineWidth=8*m,e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(w.x,w.y),e.stroke();let x=y.add(c.factor(.15)).add(p.factor(1.05));c=w.sub(D),p=new o(c.y*d,-c.x*d),p=p.factor(m*m);let v=D.add(c.factor(.4)).add(p.factor(130/c.lenSqr()));e.lineWidth=5*m,e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(v.x,v.y),e.lineTo(D.x,D.y),e.stroke(),GameInventoryManager.getItem(this.cosmetics.head).draw(e,x.x,x.y,this.drawHeadAngle,m,this.dir),e.globalAlpha=1}}},MTB:class extends te{vehicleName="MTB";constructor(e,t,s,i){super(e),this.createMasses(t,i),this.createSprings(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createMasses(e,t){this.masses=[];var s=new W(new o(e.x+2,e.y+-38),this),i=new X(new o(e.x+23,e.y),this),a=new X(new o(e.x+-23,e.y),this);s.drive=this.createRagdoll.bind(this),a.radius=14,i.radius=14,s.radius=14,s.vel.equ(t),a.vel.equ(t),i.vel.equ(t),this.masses.push(s),this.masses.push(a),this.masses.push(i),this.head=s,this.frontWheel=i,this.rearWheel=a}createSprings(){super.createSprings(),this.chasse.lrest=45,this.chasse.leff=45,this.chasse.springConstant=.2,this.chasse.dampConstant=.3,this.rearSpring.lrest=47,this.rearSpring.leff=47,this.rearSpring.springConstant=.2,this.rearSpring.dampConstant=.3,this.frontSpring.lrest=45,this.frontSpring.leff=45,this.frontSpring.springConstant=.2,this.frontSpring.dampConstant=.3}control(){let e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),r=e.isButtonDown("z"),o=this.rearWheel;o.motor+=(t-o.motor)/10,r&&!this.swapped&&(this.swap(),this.swapped=!0),r||(this.swapped=!1),t&&(this.pedala+=this.rearWheel.speed/5),o.brake=s,this.frontWheel.brake=!!(this.dir>0&&a&&s)||!!(this.dir<0&&i&&s);let n=i-a;this.rearSpring.contract(5*n*this.dir,5),this.frontSpring.contract(5*-n*this.dir,5),this.chasse.rotate(n/8),!n&&t&&(this.rearSpring.contract(-7,5),this.frontSpring.contract(7,5))}drawBikeFrame(e,t=this.player._opacity){let s=this.scene,i=new o(this.frontWheel.pos.x,this.frontWheel.pos.y),a=new o(this.rearWheel.pos.x,this.rearWheel.pos.y),r=new o(this.head.pos.x,this.head.pos.y),n=i.toScreen(s),h=a.toScreen(s),l=r.toScreen(s),c=s.camera.zoom,d=n.sub(h),p=new o(n.y-h.y,h.x-n.x),u=d.factor(.5),m=s.settings.physicsLineColor,g=s.settings.sceneryLineColor,y=g.padEnd(7,g.slice(1,4));p.factorSelf(this.dir),h.addOut(u,u),l.subOut(u,u),e.globalAlpha=t,e.strokeStyle=m,e.lineWidth=3*c,e.beginPath(),e.fillStyle=y+"33",e.arc(n.x,n.y,12.5*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(h.x,h.y,12.5*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.strokeStyle="rgba(128,128,128,0.8)",e.fillStyle=g,e.lineWidth=1,e.beginPath(),e.arc(n.x,n.y,6*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(h.x,h.y,6*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.strokeStyle=this.color,e.lineWidth=5*c,e.moveTo(h.x,h.y),e.lineTo(h.x+.4*d.x+.05*p.x,h.y+.4*d.y+.05*p.y),e.moveTo(h.x+.72*d.x+.64*u.x,h.y+.72*d.y+.64*u.y),e.lineTo(h.x+.46*d.x+.4*u.x,h.y+.46*d.y+.4*u.y),e.lineTo(h.x+.4*d.x+.05*p.x,h.y+.4*d.y+.05*p.y),e.stroke(),e.beginPath(),e.lineWidth=2*c,e.moveTo(h.x+.72*d.x+.64*u.x,h.y+.72*d.y+.64*u.y),e.lineTo(h.x+.43*d.x+.05*p.x,h.y+.43*d.y+.05*p.y),e.stroke(),e.beginPath(),e.lineWidth=1*c,e.moveTo(h.x+.46*d.x+.4*u.x,h.y+.46*d.y+.4*u.y),e.lineTo(h.x+.28*d.x+.5*u.x,h.y+.28*d.y+.5*u.y),e.stroke(),e.beginPath(),e.lineWidth=2*c,e.moveTo(h.x+.45*d.x+.3*u.x,h.y+.45*d.y+.3*u.y),e.lineTo(h.x+.3*d.x+.4*u.x,h.y+.3*d.y+.4*u.y),e.lineTo(h.x+.25*d.x+.6*u.x,h.y+.25*d.y+.6*u.y),e.moveTo(h.x+.17*d.x+.6*u.x,h.y+.17*d.y+.6*u.y),e.lineTo(h.x+.3*d.x+.6*u.x,h.y+.3*d.y+.6*u.y),e.stroke(),e.beginPath(),e.lineWidth=3*c,e.moveTo(n.x,n.y),e.lineTo(h.x+.71*d.x+.73*u.x,h.y+.71*d.y+.73*u.y),e.lineTo(h.x+.73*d.x+.77*u.x,h.y+.73*d.y+.77*u.y),e.lineTo(h.x+.7*d.x+.8*u.x,h.y+.7*d.y+.8*u.y),e.stroke(),e.beginPath(),e.lineWidth=1*c;let f=new o(6*Math.cos(this.pedala)*c,6*Math.sin(this.pedala)*c);if(e.moveTo(h.x+.43*d.x+.05*p.x+f.x,h.y+.43*d.y+.05*p.y+f.y),e.lineTo(h.x+.43*d.x+.05*p.x-f.x,h.y+.43*d.y+.05*p.y-f.y),e.stroke(),this.crashed)this.ragdoll&&this.ragdoll.draw&&this.ragdoll.draw(e);else{d.factorOut(.5,p),h.addOut(p,p),l.subOut(p,p);let s=d.factor(.3);s.x=h.x+s.x+.25*p.x,s.y=h.y+s.y+.25*p.y;let i=d.factor(.4);i.x=h.x+i.x+.05*p.x,i.y=h.y+i.y+.05*p.y;let a=i.add(f),r=i.sub(f),o=d.factor(.67);o.x=h.x+o.x+.8*p.x,o.y=h.y+o.y+.8*p.y;let n=d.factor(-.05);n.x=s.x+n.x+.42*p.x,n.y=s.y+n.y+.42*p.y;let g=a.sub(n),w=g.lenSqr();u.x=g.y*this.dir,u.y=-g.x*this.dir,u.factorSelf(c**2);let x=g.factor(.5);x.x=n.x+x.x+u.x*(200/g.lenSqr()),x.y=n.y+x.y+u.y*(200/g.lenSqr());let v=g.factor(.12);v.x=a.x+v.x+u.x*(50/w),v.y=a.y+v.y+u.y*(50/w),r.subOut(n,g),w=g.lenSqr(),u.x=g.y*this.dir,u.y=-g.x*this.dir,u.factorSelf(c*c);let b=g.factor(.5);b.x=n.x+b.x+u.x*(200/w),b.y=n.y+b.y+u.y*(200/w);let k=g.factor(.12);k.x=r.x+k.x+u.x*(50/w),k.y=r.y+k.y+u.y*(50/w),y=m.padEnd(7,m.slice(1,4)),e.strokeStyle=y+Math.min(255,Math.round(127.5*t)).toString(16),e.lineWidth=6*c,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(b.x,b.y),e.lineTo(n.x,n.y),e.stroke(),e.lineWidth=4*c,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(k.x,k.y),e.stroke(),e.lineWidth=6*c,e.strokeStyle=m,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(x.x,x.y),e.lineTo(n.x,n.y),e.stroke(),e.lineWidth=4*c,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(v.x,v.y),e.stroke();let T=d.factor(.1);T.x=s.x+T.x+.95*p.x,T.y=s.y+T.y+.95*p.y,e.lineWidth=8*c,e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(T.x,T.y),e.stroke();let S=d.factor(.2);S.x=s.x+S.x+1.09*p.x,S.y=s.y+S.y+1.09*p.y,e.beginPath(),e.lineWidth=2*c,T.subOut(o,d);let _=d.lenSqr();p.x=d.y*this.dir,p.y=-d.x*this.dir,p.factorSelf(c*c);let C=d.factor(.3);C.x=o.x+C.x+p.x*(80/_),C.y=o.y+C.y+p.y*(80/_),e.lineWidth=5*c,e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(C.x,C.y),e.lineTo(o.x,o.y),e.stroke(),GameInventoryManager.getItem(this.cosmetics.head).draw(e,S.x,S.y,this.drawHeadAngle,c,this.dir),e.globalAlpha=1}}},HELI:class extends Z{swapped=!1;vehicleName="Helicopter";constructor(e,t,s){super(e),this.createMasses(t),this.createSprings(),this.createCockpit(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createCockpit(){let e=document.createElement("canvas");Object.defineProperty(this,"canvasCockpit",{value:e}),Object.defineProperty(this,"ctx",{value:e.getContext("2d")}),this.ctx.fillStyle=this.color,this.ctx.strokeStyle=this.color}createMasses(e){var t=[];t.push(new se(new o(e.x+0,e.y+18),this));var s=new W(new o(e.x+-17,e.y+42),this),i=new W(new o(e.x+17,e.y+42),this),a=new W(new o(e.x+-40,e.y+15),this),r=new W(new o(e.x+40,e.y+15),this);t.push(s),t.push(i),t.push(a),t.push(r),t[0].radius=18,t[1].radius=8,t[2].radius=8,t[3].grav=!1,t[4].grav=t[4].collide=!1,t[1].friction=.2,t[2].friction=.2,this.head=t[0],this.mass2=t[1],this.mass3=t[2],this.mass4=t[3],this.rotor=0,this.rotor2=0,this.dir=1;let n=this;t[3].drive=this.head.drive=function(){n.explode()},this.focalPoint=t[0],this.masses=t}createSprings(){let e=this.masses,t=[];t.push(new V(e[0],e[1],this)),t.push(new V(e[2],e[0],this)),t.push(new V(e[2],e[1],this)),t.push(new V(e[0],e[3],this)),t.push(new V(e[1],e[3],this)),t.push(new V(e[0],e[4],this)),t.push(new V(e[2],e[4],this)),this.spring1=t[0],this.spring2=t[1],this.spring3=t[2],this.spring4=t[3],this.spring5=t[4],this.spring6=t[5],this.spring7=t[6],t[0].leff=t[4].lrest=30,t[1].leff=t[4].lrest=30,t[2].leff=t[4].lrest=35,t[4].leff=t[4].lrest=35,t[6].leff=t[4].lrest=35;for(let e of t)e.dampConstant=.4,e.springConstant=.5;this.springs=t}drawCockpit(){let e=this.canvasCockpit,t=this.scene.camera.zoom,s=50*t,i=50*t,a=Math.max(2*t,1),r=this.ctx;if(s!==e.width||i!==e.height||r.fillStyle!==this.color||r.strokeStyle!==this.color||r.lineWidth!==a){e.width=s,e.height=i;var o=this.masses[0].radius*t*.9;r.save(),r.translate(s/2,i/2),r.scale(1.3,1),r.beginPath(),r.arc(0,0,o,0,1.5*Math.PI,!1),r.lineTo(0,0),r.lineTo(o,0),r.closePath(),r.restore(),r.fillStyle=this.color,r.fill(),r.lineWidth=a,r.strokeStyle=this.color,r.stroke(),r.save(),r.translate(s/2,i/2),r.scale(1.3,1),r.beginPath(),r.arc(0,0,o,0,1.5*Math.PI,!0),r.restore(),r.stroke()}return e}updateCameraFocalPoint(){}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,a=i.length,r=a-1;r>=0;r--)i[r].fixedUpdate();if((this.masses[1].contact||this.masses[2].contact)&&(this.slow=!1),!1===this.slow){for(!1===this.crashed&&this.control(),s=t-1;s>=0;s--)e[s].fixedUpdate();for(r=a-1;r>=0;r--)i[r].fixedUpdate()}this.updateCockpitAngle()}}update(e){for(let t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e)}updateSound(){if(this.player.isInFocus()){let e=this.scene.sound,t=Math.min(this.head.motor,1);e.play(ie,t)}}stopSounds(){this.scene.sound.stop(ie)}swap(){let e=this.dir,t=this.springs,s=this.masses;e*=-1,t[2].swap();let i=new o(0,0),a=new o(0,0),r=new o(0,0);i.equ(s[3].pos),a.equ(s[3].old),r.equ(s[3].vel),s[3].pos.equ(s[4].pos),s[3].old.equ(s[4].old),s[3].vel.equ(s[4].vel),s[4].pos.equ(i),s[4].old.equ(a),s[4].vel.equ(r),this.dir=e}control(){let e=this.player.getGamepad(),t=e.isButtonDown("up"),s=e.isButtonDown("back"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),r=e.isButtonDown("z"),o=this.masses,n=this.springs;r&&!this.swapped&&(this.swap(),this.swapped=!0),r||(this.swapped=!1);let h=o[1].pos.add(o[2].pos).factor(.5);h=o[0].pos.sub(h),h=h.factor(1/h.len()),o[0].angle.equ(h);let l=t?1:0;o[0].motor+=(l-o[0].motor)/10;let c=i?1:0;c+=a?-1:0,n[2].rotate(c/6),s&&(this.scene.restartTrack=!0)}updateCockpitAngle(){let e=this.masses,t=e[0].pos,s=e[3].pos,i=t.x,a=t.y,r=i-s.x,o=a-s.y;this.cockpitAngle=-(Math.atan2(r,o)-Math.PI/2),this.rotor+=.5*this.head.motor+.05,this.rotor>6.2831&&(this.rotor-=6.2831),this.rotor2+=.5,this.rotor2>6.2831&&(this.rotor2-=6.2831)}draw(e){if(this.explosion)this.explosion.draw(e,1);else{if(e.imageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite&&parseInt(lite.storage.get("snapshots"));if(t>0){for(let s of this.player._checkpoints.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle))){let i=document.createElement("canvas");this.drawHelicopter.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle),{canvasCockpit:i,ctx:i.getContext("2d"),drawCockpit:this.drawCockpit}),e,t/300*this.player._checkpoints.indexOf(s)%1)}for(let s of this.player._cache.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle))){let i=document.createElement("canvas");this.drawHelicopter.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle),{canvasCockpit:i,ctx:i.getContext("2d"),drawCockpit:this.drawCockpit}),e,t/300*this.player._cache.indexOf(s)%1)}}}if(window.lite&&lite.storage.get("playerTrail"))for(let t of lite.snapshots.filter((e=>e._tempVehicle))){let s=document.createElement("canvas");this.drawHelicopter.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(t._tempVehicle),{canvasCockpit:s,ctx:s.getContext("2d"),drawCockpit:this.drawCockpit}),e,lite.snapshots.length/(200*lite.snapshots.length)*parseInt(lite.snapshots.indexOf(t))%1)}}this.drawHelicopter(e)}}drawHelicopter(e,t=this.player._opacity){e.globalAlpha=t;let s=this.dir,i=this.rotor,a=this.rotor2,r=this.scene,n=r.camera.zoom,h=new o(this.head.pos.x,this.head.pos.y),l=new o(this.mass2.pos.x,this.mass2.pos.y).add(this.mass3.pos).factor(.5),c=h.sub(l).factor(n),d=new o(-c.y*s,c.x*s),p=h.toScreen(r);e.strokeStyle=this.color,e.lineWidth=5*n,e.beginPath(),e.moveTo(p.x+.5*c.x,p.y+.5*c.y),e.lineTo(p.x+.8*c.x,p.y+.8*c.y),e.stroke(),e.lineWidth=3*n,e.beginPath();var u=.9*Math.cos(i);e.moveTo(p.x+.9*c.x+d.x*u,p.y+.8*c.y+d.y*u),e.lineTo(p.x+.9*c.x-d.x*u,p.y+.8*c.y-d.y*u),e.stroke();var m=new o(this.mass2.pos.x,this.mass2.pos.y).toScreen(r),g=new o(this.mass3.pos.x,this.mass3.pos.y).toScreen(r);e.lineWidth=3*n,e.strokeStyle="#".padEnd(7,"midnight"===window.lite.storage.get("theme")?"8":"dark"===window.lite.storage.get("theme")?"9":"6"),e.beginPath(),e.moveTo(m.x-.2*c.x,m.y-.2*c.y),e.lineTo(p.x,p.y),e.lineTo(g.x-.2*c.x,g.y-.2*c.y),e.stroke(),e.lineWidth=4*n,e.beginPath(),e.moveTo(m.x-.2*d.x-.1*c.x,m.y-.2*d.y-.1*c.y),e.lineTo(m.x-.25*c.x,m.y-.25*c.y),e.lineTo(g.x-.25*c.x,g.y-.25*c.y),e.lineTo(g.x+.2*d.x-.1*c.x,g.y+.2*d.y-.1*c.y),e.stroke(),e.lineWidth=6*n,e.strokeStyle=this.color,e.beginPath();var y=new o(this.mass4.pos.x,this.mass4.pos.y).toScreen(r);e.moveTo(p.x,p.y),e.lineTo(y.x,y.y),e.lineTo(p.x-.1*c.x,p.y-.3*c.y),e.stroke(),e.lineWidth=2*n,e.strokeStyle=this.color,e.beginPath();var f=7*n,w=new o(f*Math.sin(-a),f*Math.cos(-a));e.moveTo(y.x+w.x,y.y+w.y),e.lineTo(y.x-w.x,y.y-w.y),e.moveTo(y.x-w.y,y.y+w.x),e.lineTo(y.x+w.y,y.y-w.x),e.stroke(),e.beginPath(),e.lineWidth=2*n,e.arc(y.x,y.y,this.mass4.radius*n,0,2*Math.PI,!1),e.stroke(),l=this.drawCockpit();var x=l.width,v=l.height,b=p.x+5*n*this.dir,k=p.y+2*n,T=-x/2,S=-v/2,_=this.cockpitAngle,C=-1===s,P=this.cosmetics,M=GameInventoryManager.getItem(P.head),A=this.cockpitAngle;M.draw(e,b+5*n*s,k-5*n,A,.7*n,s),e.translate(b,k),e.rotate(_),C&&e.scale(1,-1),e.drawImage(l,T,S,x,v),C&&e.scale(1,-1),e.rotate(-_),e.translate(-b,-k),e.globalAlpha=1}},TRUCK:class extends Z{color="#444";pedala=0;swapped=!1;vehicleName="TRUCK";constructor(e,t,s){super(e),this.createMasses(t),this.createSprings(),this.stopSounds(),this.updateCameraFocalPoint(),-1===s&&this.swap()}createMasses(e){this.masses=[],this.masses.push(new W(new o(e.x-15,e.y+7),this)),this.masses.push(new W(new o(e.x+15,e.y+7),this)),this.masses[0].friction=.1,this.masses[1].friction=.1,this.masses.push(new X(new o(e.x-20,e.y+35),this)),this.masses.push(new X(new o(e.x+20,e.y+35),this)),this.masses[2].radius=this.masses[3].radius=14,this.masses[0].radius=this.masses[1].radius=7,this.head=this.masses[0],this.backMass=this.masses[1],this.rearWheel=this.masses[2],this.frontWheel=this.masses[3]}createSprings(){this.springs=[];let e=this.masses;this.springs.push(new V(e[0],e[1],this)),this.springs.push(new V(e[0],e[2],this)),this.springs.push(new V(e[1],e[3],this)),this.springs.push(new V(e[0],e[3],this)),this.springs.push(new V(e[1],e[2],this)),this.springs.push(new V(e[2],e[3],this)),this.springs[0].leff=this.springs[0].lrest=30,this.springs[1].leff=this.springs[1].lrest=30,this.springs[2].leff=this.springs[2].lrest=30,this.springs[3].leff=this.springs[3].lrest=45,this.springs[4].leff=this.springs[4].lrest=45;for(let e in this.springs)this.springs[e].springConstant=.3}updateCameraFocalPoint(){}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,a=i.length,r=a-1;r>=0;r--)i[r].fixedUpdate();if(this.rearWheel.contact&&this.frontWheel.contact&&(this.slow=!1),!1===this.slow){for(!1===this.crashed&&this.control(),s=t-1;s>=0;s--)e[s].fixedUpdate();for(r=a-1;r>=0;r--)i[r].fixedUpdate()}this.updateDrawHeadAngle(),this.updateCameraFocalPoint()}}update(e){for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].fixedUpdate()}updateSound(){if(this.player.isInFocus()){let e=this.scene.sound;if(this.rearWheel.contact){let t=Math.min(this.rearWheel.motor,1);e.play(re,t)}else if(this.frontWheel.contact){let t=Math.min(this.frontWheel.motor,1);e.play(re,t)}else e.stop(re)}}updateCameraFocalPoint(){this.focalPoint=1===this.dir?this.head:this.backMass}stopSounds(){this.scene.sound.stop(re)}updateDrawHeadAngle(){let e=this.frontWheel.pos,t=this.rearWheel.pos,s=e.x,i=e.y,a=s-t.x,r=i-t.y;this.drawHeadAngle=-(Math.atan2(a,r)-Math.PI/2)}swap(){this.dir=-1*this.dir,this.springs[0].swap(),this.springs[5].swap()}control(){let e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),r=e.isButtonDown("z");r&&!this.swapped&&(this.swap(),this.swapped=!0),r||(this.swapped=!1);let o=t?1:0,n=this.rearWheel,h=this.frontWheel;n.motor+=(.8*o-n.motor)/10,h.motor+=(.8*o-h.motor)/10,n.brake=s,h.brake=s;let l=i?1:0;l+=a?-1:0;let c=this.springs;c[0].rotate(l/8),c[5].rotate(l/8)}draw(e){if(this.explosion)this.explosion.draw(e,1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite.storage.get("snapshots");if(t>0){for(let s of this.player._checkpoints.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))e.globalAlpha=t/300*this.player._checkpoints.indexOf(s)%1,this.drawTruck.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle),{tire:this.tire}),e);for(let s of this.player._cache.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))e.globalAlpha=t/300*this.player._cache.indexOf(s)%1,this.drawTruck.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle),{tire:this.tire}),e)}}if(window.lite&&lite.storage.get("playerTrail"))for(let t of lite.snapshots.filter((e=>e._tempVehicle)))e.globalAlpha=lite.snapshots.length/(200*lite.snapshots.length)*lite.snapshots.indexOf(t)%1,this.drawTruck.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(t._tempVehicle),{tire:this.tire}),e)}if(e.imageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,this.settings.developerMode)for(let e=this.masses,t=e.length-1;t>=0;t--)e[t].draw();e.globalAlpha=this.player._opacity,this.drawTruck(e),e.globalAlpha=1}}drawTruck(e){let t=this.scene,s=t.camera.zoom,i=GameInventoryManager.getItem(this.cosmetics.head),a=this.drawHeadAngle,r=this.dir,n=new o(this.frontWheel.pos.x,this.frontWheel.pos.y).toScreen(t),h=new o(this.rearWheel.pos.x,this.rearWheel.pos.y).toScreen(t),l=new o(this.head.pos.x,this.head.pos.y).toScreen(t),c=new o(this.backMass.pos.x,this.backMass.pos.y).toScreen(t),d=(this.backMass.pos.x-this.head.pos.x)*s,p=(this.backMass.pos.y-this.head.pos.y)*s,u=(.5*(this.head.pos.x+this.backMass.pos.x)-.5*(this.rearWheel.pos.x+this.frontWheel.pos.x))*s,m=(.5*(this.head.pos.y+this.backMass.pos.y)-.5*(this.rearWheel.pos.y+this.frontWheel.pos.y))*s,g="#".padEnd(7,"midnight"===window.lite.storage.get("theme")?"a":"dark"===lite.storage.get("theme")?"b":"4");e.lineWidth=3*s;let y=c.x-l.x,f=c.y-l.y,w=Math.sqrt(Math.pow(y,2)+Math.pow(f,2)),x=y/w,v=f/w;i.draw(e,c.x-.5*x*s*20,c.y-v*s*20*.5,a,.45*s,r),e.strokeStyle=g,e.beginPath(),e.moveTo(l.x-.4*d-.9*u,l.y-.4*p-.9*m),e.lineTo(l.x+.8*d-.9*u,l.y+.8*p-.9*m),e.stroke(),e.closePath(),e.save(),e.fillStyle="#808080",e.beginPath(),e.moveTo(l.x-.4*d-.7*u,l.y-.4*p-.7*m),e.lineTo(l.x-.4*d-.7*u,l.y-.4*p-.7*m),e.lineTo(l.x+1.4*d-.7*u,l.y+1.4*p-.7*m),e.lineTo(l.x+1.35*d-.2*u,l.y+1.35*p-.2*m),e.lineTo(l.x+.9*d-.1*u,l.y+.9*p-.1*m),e.lineTo(l.x+.5*d-.1*u,l.y+.5*p-.1*m),e.lineTo(l.x+.5*d+.2*u,l.y+.5*p+.2*m),e.lineTo(l.x-.35*d+.2*u,l.y-.35*p+.2*m),e.closePath(),e.fill(),e.save(),e.lineWidth=2*s,e.strokeStyle=g,e.beginPath(),e.moveTo(l.x-.4*d-.7*u,l.y-.4*p-.7*m),e.lineTo(l.x-.35*d+.2*u,l.y-.35*p+.2*m),e.lineTo(l.x+.8*d+.2*u,l.y+.8*p+.2*m),e.lineTo(l.x+.9*d-.1*u,l.y+.9*p-.1*m),e.lineTo(l.x+1.35*d-.2*u,l.y+1.35*p-.2*m),e.lineTo(l.x+1.4*d-.7*u,l.y+1.4*p-.7*m),e.lineTo(l.x-.4*d-.7*u,l.y-.4*p-.7*m),e.closePath(),e.stroke(),e.lineWidth=s,e.beginPath(),e.moveTo(l.x+.5*d-.1*u,l.y+.5*p-.1*m),e.lineTo(l.x+.9*d-.1*u,l.y+.9*p-.1*m),e.lineTo(l.x+.8*d+.2*u,l.y+.8*p+.2*m),e.lineTo(l.x+.5*d+.2*u,l.y+.5*p+.2*m),e.lineTo(l.x+.5*d-.1*u,l.y+.5*p-.1*m),e.closePath(),e.stroke(),e.strokeStyle=t.settings.physicsLineColor,this.tire(e,h.x,h.y,10*s,s,this.rearWheel.angle),this.tire(e,n.x,n.y,10*s,s,this.frontWheel.angle),e.restore()}tire(e,t,s,i,a,r){e.beginPath(),e.arc(t,s,10*a,0,2*Math.PI,!1),e.fillStyle="#888888",e.fill(),e.lineWidth=5.9*a,e.closePath(),e.stroke(),e.beginPath(),e.lineWidth=2*a,i+=3*a;let o=0,n=2*Math.PI;for(;o++<8;)e.moveTo(t+i*Math.cos(r+n*o/8),s+i*Math.sin(r+n*o/8)),e.lineTo(t+i*Math.cos(r+n*(o+.5)/8),s+i*Math.sin(r+n*(o+.5)/8));for(e.stroke(),e.closePath(),e.beginPath(),o=0,i+=-9*a;o++<5;)e.moveTo(t+i*Math.cos(r+n*o/5),s+i*Math.sin(r+n*o/5)),e.lineTo(t+i*Math.cos(r+n*(o+.2)/5),s+i*Math.sin(r+n*(o+.2)/5));e.closePath(),e.stroke()}},BALLOON:class extends Z{basket=null;head=null;outline="#999";vehicleName="BALLOON";constructor(e,t){super(e),this.createMasses(t),this.createSprings(),this.stopSounds(),this.focalPoint=this.head}createMasses(e){this.masses=[];let t=new U(e.x,e.y-10,this);t.radius=30;let s=new W(new o(e.x,e.y+35),this);s.friction=.1,this.masses.push(t),this.masses.push(s),this.head=this.masses[0],this.basket=this.masses[1];let i=this;this.head.drive=function(){i.explode()}}updateCameraFocalPoint(){}createSprings(){this.springs=[];var e=new V(this.head,this.basket,this);e.springConstant=.2,e.dampConstant=.2,e.lrest=e.leff=45,this.springs.push(e)}fixedUpdate(){if(!1===this.crashed&&this.updateSound(),this.explosion)this.explosion.fixedUpdate();else{this.head.wind=!this.basket.contact,this.slow=!1;for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,a=i.length,r=a-1;r>=0;r--)i[r].fixedUpdate();for(s=t-1;s>=0;s--)e[s].fixedUpdate();for(r=a-1;r>=0;r--)i[r].fixedUpdate()}}update(e){for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e)}updateSound(){if(this.player.isInFocus()){var e=this.scene.sound,t=this.gamepad;t.isButtonDown("up")?e.play(J,.6):t.isButtonDown("up")||e.stop(J)}}stopSounds(){this.scene.sound.stop(J)}draw(e){if(this.explosion)this.explosion.draw(e,1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite&&parseInt(lite.storage.get("snapshots"));if(t>0){for(let s of this.player._checkpoints.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))e.globalAlpha=t/300*this.player._checkpoints.indexOf(s)%1,this.drawBalloon.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle)),e);for(let s of this.player._cache.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))e.globalAlpha=e/300*this.player._cache.indexOf(s)%1,this.drawBalloon.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle)),e)}}if(window.lite&&lite.storage.get("playerTrail"))for(let t of lite.snapshots.filter((e=>e._tempVehicle)))e.globalAlpha=lite.snapshots.length/(200*lite.snapshots.length)*lite.snapshots.indexOf(t)%1,this.drawBalloon.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(t._tempVehicle)),e)}if(this.settings.developerMode)for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].draw();e.globalAlpha=this.player._opacity,this.drawBalloon(e),e.globalAlpha=1}}drawBalloon(e){var t=this.scene,s=new o(this.basket.pos.x,this.basket.pos.y).toScreen(t),i=new o(this.head.pos.x,this.head.pos.y).toScreen(t),a=t.camera.zoom,r=i.x-s.x,n=i.y-s.y,h=-n;e.save(),e.strokeStyle="dark"===window.lite.storage.get("theme")?"#666":this.outline,e.lineWidth=1,e.beginPath(),e.moveTo(s.x+.1*h,s.y+.1*r),e.lineTo(s.x+.5*r+.39*h,s.y+.5*n+.39*r),e.moveTo(s.x-.1*h,s.y-.1*r),e.lineTo(s.x+.5*r-.39*h,s.y+.5*n-.39*r),e.moveTo(s.x+.1*h,s.y+.1*r),e.lineTo(s.x+.4*r+.21*h,s.y+.4*n+.21*r),e.moveTo(s.x-.1*h,s.y-.1*r),e.lineTo(s.x+.4*r-.21*h,s.y+.4*n-.21*r),e.closePath(),e.stroke();let l=new U(this.head.pos.x,this.head.pos.y,this);l.radius=30,l.draw(e),this.gamepad.isButtonDown("up")&&(e.beginPath(),e.strokeStyle="#FFFF00",e.lineWidth=8*a,e.moveTo(s.x,s.y),e.lineTo(s.x+.1*r,s.y+.1*n),e.closePath(),e.stroke(),e.beginPath(),e.strokeStyle="#FFAA00",e.lineWidth=3*a,e.moveTo(s.x,s.y),e.lineTo(s.x+.1*r,s.y+.1*n),e.closePath(),e.stroke()),e.beginPath(),e.fillStyle=this.color,e.moveTo(s.x+.1*h,s.y+.1*r),e.lineTo(s.x-.1*h,s.y-.1*r),e.lineTo(s.x-.22*r-.1*h,s.y-.22*n-.1*r),e.lineTo(s.x-.22*r+.1*h,s.y-.22*n+.1*r),e.lineTo(s.x+.1*h,s.y+.1*r),e.closePath(),e.fill(),e.restore()}},BLOB:class extends Z{vehicleName="Blob";constructor(e,t){super(e),this.createMasses(t),this.createSprings(),this.stopSounds()}createMasses(e){let t=[];t.push(new X(new o(e.x+15,e.y+40),this)),t.push(new X(new o(e.x+-15,e.y+40),this)),t.push(new X(new o(e.x+-15,e.y+10),this)),t.push(new X(new o(e.x+15,e.y+10),this));let s=new W(new o(0,0),this);s.vel=new o(0,0),this.m0=t[0],this.m1=t[1],this.m2=t[2],this.m3=t[3],this.head=s,this.masses=t,this.focalPoint=this.head}createSprings(){let e=this.masses,t=[],s=this.spring0=new V(e[0],e[1],this),i=this.spring1=new V(e[1],e[2],this),a=this.spring2=new V(e[2],e[3],this),r=this.spring3=new V(e[3],e[0],this),o=this.spring4=new V(e[0],e[2],this),n=this.spring5=new V(e[1],e[3],this);t.push(s),t.push(i),t.push(a),t.push(r),t.push(o),t.push(n);for(let e in t)t[e].springConstant=.2,t[e].dampConstant=.2;this.springs=t}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{let s=this.masses,i=s.length,a=this.springs,r=a.length;for(var e=r-1;e>=0;e--)a[e].fixedUpdate();for(var t=i-1;t>=0;t--)s[t].fixedUpdate();if((s[0].contact||s[1].contact||s[2].contact||s[3].contact)&&(this.slow=!1),!this.slow){for(this.control(),e=r-1;e>=0;e--)a[e].fixedUpdate();for(t=i-1;t>=0;t--)s[t].fixedUpdate()}let o=0,n=0;for(let e of this.masses)o+=e.pos.x,n+=e.pos.y;let h=this.head;h.pos.x=.25*o,h.pos.y=.25*n,h.vel=s[0].vel}}update(e){for(let t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e)}updateSound(){this.player.isInFocus()&&this.scene.sound.play(Y,.4)}stopSounds(){this.scene.sound.stop(Y)}updateCameraFocalPoint(){}control(){let e,t,s=this.player.getGamepad(),i=s.isButtonDown("up"),a=s.isButtonDown("down"),r=s.isButtonDown("left"),o=s.isButtonDown("right"),n=s.isButtonDown("z"),h=this.masses,l=this.springs,c=h.length,d=l.length,p=this.dir;p=o?1:-1;let u=o||r?1:0;for(a&&(u=0),e=c-1;e>=0;e--)h[e].motor+=(u*p*1-h[e].motor)/10,0==u&&(h[e].motor=0),h[e].brake=a;let m=r?1:0;if(m+=o?-1:0,l[4].rotate(m/9),l[5].rotate(m/9),n||i)for(t=d-1;t>=0;t--)l[t].contract(30,10);else for(t=d-1;t>=0;t--)l[t].contract(0,1.5)}draw(e){if(this.explosion)this.explosion.draw(e,1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite&&lite.storage.get("snapshots");if(t>0){for(let s of this.player._checkpoints.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))this.drawBlob.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle)),e,t/300*this.player._checkpoints.indexOf(s)%1);for(let s of this.player._cache.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))this.drawBlob.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle)),e,t/300*this.player._cache.indexOf(s)%1)}}if(window.lite&&lite.storage.get("playerTrail"))for(let t of lite.snapshots.filter((e=>e._tempVehicle)))this.drawBlob.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(t._tempVehicle)),e,lite.snapshots.length/(200*lite.snapshots.length)*lite.snapshots.indexOf(t)%1)}this.drawBlob(e)}}drawBlob(e,t=this.player._opacity){let s=this.scene,i=s.camera.zoom,a=new o(this.m0.pos.x,this.m0.pos.y).toScreen(s),r=new o(this.m1.pos.x,this.m1.pos.y).toScreen(s),n=new o(this.m2.pos.x,this.m2.pos.y).toScreen(s),h=new o(this.m3.pos.x,this.m3.pos.y).toScreen(s);e.globalAlpha=t,e.beginPath(),e.fillStyle=this.color,e.lineWidth=20*i,e.lineCap="round",e.moveTo(a.x,a.y),e.lineTo(r.x,r.y),e.lineTo(n.x,n.y),e.lineTo(h.x,h.y),e.closePath(),e.fill(),e.stroke(),e.globalAlpha=1}}};function he(e,t){for(var s in t)try{e[s]=t[s].constructor==Object?he(e[s],t[s]):t[s]}catch(i){e[s]=t[s]}return e}const le=class{constructor(e,t){this.id=oe++,this._scene=e,this._game=e.game,Object.defineProperties(this,{_scene:{enumerable:!1},_game:{enumerable:!1}}),this._user=t,this._settings=e.settings;let s=e.settings.startVehicle;e.settings.track&&(s=e.settings.track.vehicle),this._baseVehicleType=s,this._gamepad=new H(e),this._ghost=!1,this._color=t.color||"#000000",this.setDefaults(),this.createBaseVehicle(new o(0,35),1,new o(0,0))}getCheckpointCount(){return this._checkpoints.length}setDefaults(){this._baseVehicle=!1,this._tempVehicleType=null,this._tempVehicle=!1,this._tempVehicleTicks=0,this._temp_vehicle_options=null,this._addCheckpoint=!1,this._checkpoints=[],this._cache=[],this._crashed=!1,this._effect=!1,this._effectTicks=0,this._opacity=1,this.complete=!1,this._powerupsConsumed={checkpoints:[],targets:[],misc:[]}}hasCheckpoints(){return this._checkpoints.length>0}setColor(e){this._color=e}dead(){if(this._crashed=!0,!1===this._ghost){let e=this._scene,t=e.message;e.state.playerAlive=this.isAlive(),t.show(this._checkpoints.length>0?"Press Enter For Checkpoint":"Press Enter To Restart!",!1,"#000","#FFF")}}setAsGhost(){this._ghost=!0,this._replayIterator=this.createReplayIterator()}isGhost(){return this._ghost}isAlive(){return!this._crashed}getTargetsHit(){return this._powerupsConsumed.targets.length}getGamepad(){return this._gamepad}setBaseVehicle(e){this._baseVehicleType=e,this.reset()}createBaseVehicle(e,t,s){this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle=new ne[this._baseVehicleType](this,e,t,s),this._tempVehicle=!1,this._tempVehicleType=!1,this._tempVehicleTicks=0}setTempVehicle(e,t,s,i){this._temp_vehicle_options&&this._temp_vehicle_options.type===e&&(t=this._temp_vehicle_options.ticks+t),this._temp_vehicle_options={type:e,ticks:t,position:s,direction:i}}createTempVehicle(e,t,s,i){if(this._temp_vehicle_options){let a=this._temp_vehicle_options;e=a.type,t=a.ticks,s=a.position,i=a.direction,this._temp_vehicle_options=null}this._tempVehicleType===e?this._tempVehicleTicks+=t:(this.getActiveVehicle().stopSounds(),this._effect=new N(s,this._scene),this._effectTicks=45,this._tempVehicleType=e,this._tempVehicle=new ne[e](this,s,i),this._tempVehicleTicks=t)}fixedUpdate(){let e=this._baseVehicle;this._temp_vehicle_options&&this.createTempVehicle(),this._tempVehicleTicks>0&&(e=this._tempVehicle,!1===this._crashed&&this._tempVehicleTicks--,this._tempVehicleTicks<=0&&!1===this._crashed&&(this._effectTicks=45,this._effect=new N(this._tempVehicle.focalPoint.pos,this._scene),this.createBaseVehicle(this._tempVehicle.focalPoint.pos,this._tempVehicle.dir,this._tempVehicle.masses[0].vel),e=this._baseVehicle)),this._effectTicks>0&&(this._effectTicks--,this._effect.fixedUpdate()),lite.storage.get("playerTrail")&&this.isGhost()||this.isAlive()&&lite.snapshots.push(this._createSnapshot()),e.fixedUpdate(),this._addCheckpoint&&(this.isAlive()&&this._createCheckpoint(),this._addCheckpoint=!1)}*createReplayIterator(e=0){const t=new Map;for(this._gamepad.playbackTicks=0;!1===this.complete;){if(t.has(this._gamepad.playbackTicks)||this.isAlive()&&t.set(this._gamepad.playbackTicks,{downButtons:Object.assign({},this._gamepad.downButtons),snapshot:this._createSnapshot()}),this._gamepad.playbackTicks>=e){const s=yield this._gamepad.playbackTicks;if(isFinite(s)){if(t.has(s)){let{downButtons:e,snapshot:i}=t.get(s);this._checkpoints.push(i),this.gotoCheckpoint(),this._checkpoints.pop(),this._gamepad.playbackTicks=s,this._gamepad.downButtons=Object.assign({},e)}else s<e&&this.reset();this._scene.camera.focusIndex=this._scene.playerManager._players.indexOf(this),this._scene.camera.focusOnPlayer(),e=s;continue}e=this._gamepad.playbackTicks+1/(this._game.ups/30)}this._gamepad.update(),this.checkKeys(),this.fixedUpdate(),this._gamepad.playbackTicks+=1/(this._game.ups/30),this.isInFocus()&&window.hasOwnProperty("lite")&&window.lite.replayGui&&(window.lite.replayGui.progress.value=this._gamepad.playbackTicks)}return this.loop&&(this.reset(),this._replayIterator=this.createReplayIterator()),t}isInFocus(){return this._scene.camera.playerFocus&&this._scene.camera.playerFocus===this}updateOpacity(){let e=1;if(this._scene.camera.playerFocus&&this._scene.camera.playerFocus!==this){var t=this.getDistanceBetweenPlayers(this._scene.camera.playerFocus);1200>t&&(e=Math.min(t/500,1))}this._opacity=e}drawName(e){let t=this.getActiveVehicle().focalPoint.pos.toScreen(this._scene);e.globalAlpha=this._opacity,e.beginPath(),e.fillStyle=this._color,e.moveTo(t.x,t.y-40*this._scene.camera.zoom),e.lineTo(t.x-5*this._scene.camera.zoom,t.y-50*this._scene.camera.zoom),e.lineTo(t.x+5*this._scene.camera.zoom,t.y-50*this._scene.camera.zoom),e.lineTo(t.x,t.y-40*this._scene.camera.zoom),e.fill(),e.font=9*this._scene.game.pixelRatio*Math.max(this._scene.camera.zoom,1)+"pt helsinki",e.textAlign="center",e.fillStyle=this._color,e.fillText(this._user.d_name,t.x,t.y-60*this._scene.camera.zoom),e.globalAlpha=1}draw(e){this.updateOpacity();let t=this._baseVehicle;this._tempVehicleTicks>0&&(t=this._tempVehicle),this._effectTicks>0&&this._effect.draw(e,this._effectTicks/100),t.draw(e),this.isGhost()&&this.drawName(e)}checkKeys(){var e=this._gamepad,t=this._ghost,s=this._scene;if(!e.isButtonDown("enter")&&!e.isButtonDown("backspace")&&e.areKeysDown()&&this._cache.length>0&&(this._cache=[]),e.isButtonDown("shift")&&e.isButtonDown("enter")){var i=e.getButtonDownOccurances("enter");this.returnToCheckpoint(i),e.setButtonUp("enter")}!1===t&&(e.areKeysDown()&&!this._crashed&&s.play(),e.isButtonDown("restart")&&(s.restartTrack=!0,e.setButtonUp("restart")),(e.isButtonDown("up")||e.isButtonDown("down")||(!s.camera.focusIndex||(i=s.playerManager.getPlayerByIndex(s.camera.focusIndex))&&i._gamepad.playbackTicks<1)&&(e.isButtonDown("left")||e.isButtonDown("right")))&&s.camera.focusOnMainPlayer()),e.isButtonDown("enter")&&(this.gotoCheckpoint(),e.setButtonUp("enter")),e.isButtonDown("backspace")&&(i=e.getButtonDownOccurances("backspace"),this.removeCheckpoint(i),e.setButtonUp("backspace"))}getDistanceBetweenPlayers(e){let t=e.getActiveVehicle(),s=this.getActiveVehicle();return t.focalPoint.pos.sub(s.focalPoint.pos).len()}getActiveVehicle(){return this._tempVehicleTicks>0?this._tempVehicle:this._baseVehicle}_createCheckpoint(){this._checkpoints.push(this._createSnapshot())}_createSnapshot(){let e={};return this._tempVehicleTicks>0?(e._tempVehicleType=this._tempVehicleType,e._tempVehicle=JSON.stringify(this._tempVehicle,this._snapshotFilter),e._tempVehicleTicks=this._tempVehicleTicks):(e._baseVehicleType=this._baseVehicleType,e._baseVehicle=JSON.stringify(this._baseVehicle,this._snapshotFilter)),e._powerupsConsumed=JSON.stringify(this._powerupsConsumed),e._crashed=this._crashed,e}_snapshotFilter(e,t){switch(e){case"parent":case"player":case"scene":case"settings":case"masses":case"springs":case"focalPoint":case"gamepad":return;case"explosion":return!1;default:return t}}setCheckpointOnUpdate(){this._addCheckpoint=!0}crashed(){this._crashed=!0}gotoCheckpoint(){let e=this._gamepad.replaying,t=this._scene;if(this._checkpoints.length>0){let s=this._checkpoints[this._checkpoints.length-1];if(s._tempVehicle){this._baseVehicle.stopSounds();let e=this._tempVehicle;this._tempVehicleType!==s._tempVehicleType&&(e=new ne[s._tempVehicleType](this,{x:0,y:0})),he(e,JSON.parse(s._tempVehicle)),this._tempVehicle=e,this._tempVehicleType=s._tempVehicleType,this._tempVehicleTicks=s._tempVehicleTicks,e.updateCameraFocalPoint()}else{let e=this._baseVehicle;he(e,JSON.parse(s._baseVehicle)),this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle=e,this._tempVehicleTicks=0,this._tempVehicleType=!1,e.updateCameraFocalPoint()}if(this._powerupsConsumed=JSON.parse(s._powerupsConsumed),this._crashed=s._crashed,!1===e){let e=t.settings;t.state.playerAlive=this.isAlive(),t.message.show("Press Backspace To Go Back Further",5,"#826cdc","#FFFFFF"),t.track.updatePowerupState(this),e.waitAtCheckpoints&&(t.state.playing=!1),t.camera.focusOnMainPlayer()}t.camera.playerFocus===this&&t.camera.fastforward()}else!1===e&&this.restartScene()}restartScene(){!1===this._gamepad.replaying&&(this._scene.restartTrack=!0)}removeCheckpoint(e){if(this._checkpoints.length>1){for(let t=0;e>t;t++)this._cache.push(this._checkpoints.pop());this.gotoCheckpoint()}else this.restartScene()}returnToCheckpoint(e){if(this._cache.length>0){for(var t=0;e>t;t++)this._checkpoints.push(this._cache.pop());this.gotoCheckpoint()}}close(){this.id=null,this._scene=null,this._game=null,this._user=null,this._settings=null,this._baseVehicleType=null,this._gamepad.close(),this._gamepad=null,this._baseVehicle=null,this._tempVehicleType=null,this._tempVehicle=null,this._tempVehicleTicks=null,this._addCheckpoint=null,this._checkpoints=null,this._cache=null,this._crashed=null,this._effect=null,this._effectTicks=null,this._powerupsConsumed=null}reset(){this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle.stopSounds(),this.setDefaults(),this.createBaseVehicle(new o(0,35),1,new o(0,0)),this._gamepad.reset(),this._scene.state.playerAlive=this.isAlive(),window.hasOwnProperty("lite")&&(window.lite.snapshots.splice(0),window.lite.replayGui&&(window.lite.replayGui.progress.value=0))}},ce=class{_players=[];_playerLookup={};firstPlayer=null;constructor(e){Object.defineProperty(this,"scene",{value:e,writable:!0}),Object.defineProperty(this,"game",{value:e.game,writable:!0}),this.settings=e.settings}fixedUpdate(){if(!this.scene.camera.focusIndex)for(let e=this._players.filter((e=>!e.complete&&!e.isGhost())),t=e.length,s=0;t>s;s++)e[s].fixedUpdate();for(let e=this._players.filter((e=>!e.complete&&e.isGhost())),t=e.length,s=0;t>s;s++)e[s]._replayIterator.next()}mutePlayers(){for(let e=this._players,t=e.length,s=0;t>s;s++)e[s].getActiveVehicle().stopSounds()}updateGamepads(){for(let e=this._players.filter((e=>!e.isGhost())),t=e.length,s=0;t>s;s++)e[s]._gamepad.update()}createPlayer(e,t){return new le(this.scene,t)}addPlayer(e){this._players.push(e),this._playerLookup[e.id]=e}checkKeys(){for(let e=this._players.filter((e=>!e.isGhost())),t=e.length,s=0;t>s;s++)e[s].checkKeys()}draw(e){for(let t of this._players)t.draw(e)}getPlayerByIndex(e){return this._players[e]}getPlayerById(e){return this._playerLookup[e]}getPlayerCount(){return this._players.length}removePlayer(e){let t=this._players,s=this._playerLookup,i=t.find((t=>e==t._user.u_id&&t.isGhost()));t.splice(t.indexOf(i),1),delete s[i.id]}reset(){for(let e=this._players,t=e.length,s=0;t>s;s++)e[s].reset();for(let e=this._players.filter((e=>e.isGhost())),t=e.length,s=0;t>s;s++)e[s]._replayIterator=e[s].createReplayIterator()}clear(){this._players.splice(1),this._playerLookup={},this._playerLookup[this.firstPlayer.id]=this.firstPlayer,this.scene.camera.focusIndex>0&&this.scene.camera.unfocus()}_closePlayers(){for(let e=this._players,t=e.length,s=0;t>s;s++)e[s].close()}close(){this._closePlayers(),this._players=null,this._playerLookup=null,this.firstPlayer=null,this.scene=null,this.game=null,this.settings=null}},de=class{settings=null;zoom=1;position=null;desiredZoom=1;zoomPercentage=0;focusIndex=0;playerFocus=null;constructor(e){Object.defineProperty(this,"scene",{value:e,writable:!0}),this.settings=e.settings,this.zoom=e.settings.cameraStartZoom*e.game.pixelRatio,this.desiredZoom=e.settings.cameraStartZoom*e.game.pixelRatio,this.zooming=!1,this.position=new o(0,0),this.zoomPercentage=this.getZoomAsPercentage(),this.zoomPoint=!1}focusOnNextPlayer(){this.focusIndex=(this.focusIndex+1)%this.scene.playerManager.getPlayerCount(),this.focusOnPlayer()}focusOnPlayer(){this.scene.playerManager.getPlayerCount()<=this.focusIndex&&(this.focusIndex=0);let e=this.scene.playerManager.getPlayerByIndex(this.focusIndex);this.playerFocus!==e&&(0===this.focusIndex&&(this.scene.playerManager._players.filter((e=>e.isGhost())).forEach((e=>e._replayIterator.next(this.scene.ticks))),this.focusIndex=0),this.playerFocus=e,this.scene.vehicleTimer.setPlayer(e),this.playerFocus?e.getDistanceBetweenPlayers(this.playerFocus)>1500&&this.fastforward():this.fastforward(),this.scene.game.emit("cameraFocus",e))}focusOnMainPlayer(){0===this.focusIndex&&this.playerFocus||(this.focusIndex=0,this.focusOnPlayer())}update(){if(this.playerFocus){let e=3,t=this.playerFocus.getActiveVehicle().focalPoint.pos.sub(this.position);t.len()>1500&&(e=1),this.position.x+=t.x/e,this.position.y+=t.y/e}}updateZoom(){this.desiredZoom!==this.zoom&&(this.scene.loading=!0,this._performZoom(),this.zoom===this.desiredZoom&&this.zoomComplete())}zoomToPoint(e){this.position.x=this.scene.screen.toReal(this.zoomPoint.x,"x")-this.scene.screen.width/e*this.zoomPoint.x/this.scene.screen.width+this.scene.screen.width/e/2,this.position.y=this.scene.screen.toReal(this.zoomPoint.y,"y")-this.scene.screen.height/e*this.zoomPoint.y/this.scene.screen.height+this.scene.screen.height/e/2}_performZoom(){let e=this.zoom+(this.desiredZoom-this.zoom)/3;Math.abs(this.desiredZoom-this.zoom)<.05&&(e=this.desiredZoom),this.zoomPoint&&this.zoomToPoint(e),this.zoom=e}zoomComplete(){this.scene.redraw(),this.zooming=!1,this.scene.loading=!1}setZoom(e,t){this.desiredZoom=Math.round(e*window.devicePixelRatio*10)/10,this.zooming=!0,this.desiredZoom===this.zoom&&(this.zooming=!1,this.scene.state.loading=!1),this.zoomPoint=!1,null===this.playerFocus&&t&&(this.zoomPoint=t),this.zoomPercentage=this.getZoomAsPercentage(),this.scene.updateState()}resetZoom(){this.setZoom(this.settings.cameraStartZoom)}getZoomAsPercentage(){return this.desiredZoom/window.devicePixelRatio/this.scene.settings.cameraStartZoom*100|0}increaseZoom(){this.setZoom((this.desiredZoom+2*this.scene.settings.cameraSensitivity)/window.devicePixelRatio),this.desiredZoom>this.scene.settings.cameraZoomMax*window.devicePixelRatio&&this.setZoom(this.scene.settings.cameraZoomMax)}decreaseZoom(){this.setZoom((this.desiredZoom-2*this.scene.settings.cameraSensitivity)/window.devicePixelRatio),this.desiredZoom<this.scene.settings.cameraZoomMin*window.devicePixelRatio&&this.setZoom(this.scene.settings.cameraZoomMin)}unfocus(){this.focusIndex=0,this.playerFocus=null,this.scene.vehicleTimer.removePlayer()}fastforward(){if(this.playerFocus){let e=this.playerFocus.getActiveVehicle();this.position.x=e.focalPoint.pos.x,this.position.y=e.focalPoint.pos.y}}close(){this.zoom=null,this.scene=null,this.position=null,this.playerFocus=null}},pe=class{size=null;center=null;width=0;height=0;constructor(e){Object.defineProperties(this,{scene:{value:e,writable:!0},game:{value:e.game,writable:!0}}),this.size=new o(0,0),this.center=new o(0,0),this.setScreen()}setScreen(){this.width=this.game.width,this.height=this.game.height,this.size.x=this.game.width,this.size.y=this.game.height,this.center.x=this.game.width/2,this.center.y=this.game.height/2}update(){(this.game.width!==this.width||this.game.height!==this.height)&&this.setScreen()}realToScreen(e,t){return(e-this.scene.camera.position[t])*this.scene.camera.zoom+this.scene.screen.center[t]}toReal(e,t){return(e-this.scene.screen.center[t])/this.scene.camera.zoom+this.scene.camera.position[t]}close(){this.width=null,this.height=null,this.center=null,this.size=null,this.game=null,this.scene=null}},ue=class{assets=null;settings=null;camera=null;screen=null;mouse=null;track=null;ticks=0;state=null;oldState=null;vehicle="Mtb";importCode=!1;pauseControls=null;message=null;analytics=null;constructor(e){Object.defineProperty(this,"game",{value:e,writable:!0}),this.assets=e.assets,this.settings=e.settings,this.sound=new B(this),this.mouse=new E(this),this.score=new O(this),this.camera=new de(this),this.screen=new pe(this),this.message=new M(this),this.createTrack(),this.loadingcircle=new P(this),this.playerManager=new ce(this),this.vehicleTimer=new j(this),Object.defineProperty(this,"_onresize",{value:this.redraw.bind(this),writable:!0}),window.addEventListener("resize",this._onresize,{passive:!0})}buttonDown(e){let t=this.camera;switch(e){case"change_camera":t.focusOnNextPlayer();break;case"pause":this.state.paused=!this.state.paused,this.state.paused&&Object.defineProperty(this,"_idleStateTimeout",{value:setTimeout((()=>this.state.idle=this.state.paused),300),writable:!0})||(this._idleStateTimeout&&clearTimeout(this._idleStateTimeout),this.state.idle=!1),this.updateState();break;case"settings":this.openDialog("settings");break;case"exit_fullscreen":this.exitFullscreen();break;case"change_vehicle":this.toggleVehicle(),this.updateState();break;case"zoom_increase":t.increaseZoom(),this.updateState();break;case"zoom_decrease":t.decreaseZoom(),this.updateState();break;case"fullscreen":this.toggleFullscreen(),this.updateState()}}createMainPlayer(){let e=this.playerManager.createPlayer(this,this.settings.user),t=e.getGamepad();return t.onButtonDown=this.buttonDown.bind(this),t.listen(),this.playerManager.firstPlayer=e,this.playerManager.addPlayer(e),t}createTrack(){this.track&&this.track.close();let e=new C(this);return this.track=e,e}command(e,...t){switch(e){case"resize":this.resize();break;case"dialog":var s=t[0];!1===s?this.listen():this.unlisten(),this.openDialog(s);break;case"focused":!0===t[0]?(this.state.inFocus=!0,!1===this.state.showDialog&&this.listen()):(this.state.inFocus=!1,this.unlisten(),this.state.playing=!1);break;case"add track":this.importCode=t[0].code}}draw(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),this.game.emit("clearRect",0,0,e.canvas.width,e.canvas.height,!0),this.toolHandler.drawGrid(e),this.track.draw(e),this.score.draw(e),this.playerManager.draw(e),this.vehicleTimer.player&&this.vehicleTimer.player._tempVehicleTicks>0&&this.vehicleTimer.draw(e),this.toolHandler.draw(e),this.loading&&this.loadingcircle.draw(e),this.message.draw(e),this.pauseControls.draw(e)}fixedUpdate(){this.screen.update(),this.updateControls(),this.camera.update(),this.sound.update(),this.restartTrack&&this.restart(),!this.state.paused&&this.state.playing&&(this.message.update(),this.playerManager.fixedUpdate(),!this.camera.focusIndex&&(this.playerManager.firstPlayer.complete?this.trackComplete():this.ticks++)),this.score.update(),this.vehicleTimer.fixedUpdate(),this.isStateDirty()&&this.updateState(),this.camera.updateZoom()}getAvailableTrackCode(){let e=this.settings,t=!1;return e.importCode&&t!=e.importCode?(t=e.importCode,e.importCode=null):this.importCode&&(t=this.importCode,this.importCode=null),t}hideControlPlanel(){}interactWithControls(){this.pauseControls.click()}isStateDirty(){let e=!1;for(let t in this.state)this.state[t]!==this.oldState[t]&&(e=!0,this.oldState[t]=this.state[t]);return e}redraw(){this.score.redraw(),this.track.undraw(),GameInventoryManager.redraw(),this.toolHandler.resize()}redrawControls(){this.pauseControls.redraw()}registerTools(){let e=new F(this);return this.toolHandler=e,e.registerTool(R),e}resize(){this.redrawControls()}showControlPlanel(){}updateState(){let e=this.state,t=structuredClone(this.state);e.zoomPercentage=this.camera.zoomPercentage,e.vehicle=this.vehicle,this.game.emit("stateChange",this.state),this.game.emit("stateUpdate",t,structuredClone(this.state)),null!==this.game.onStateChange&&this.game.onStateChange(this.state)}toggleVehicle(){let e=this.track.allowedVehicles,t=e.length,s=(this.state.vehicle||this.vehicle).toUpperCase(),i=e.indexOf(s);s=e[++i%t],this.selectVehicle(s)}updateControls(){this.pauseControls.update()}updateToolHandler(){this.toolHandler.update()}selectVehicle(e){-1!==this.track.allowedVehicles.indexOf(e)&&(this.settings.track.vehicle=e,this.vehicle=e,this.playerManager.firstPlayer.setBaseVehicle(e),this.restartTrack=!0)}listen(){this.playerManager.firstPlayer.getGamepad().listen()}unlisten(){this.playerManager.firstPlayer.getGamepad().unlisten()}openDialog(e){this.state.playing=!1,this.state.showDialog=e}setStateDefaults(){let e={};return e.playing=!this.settings.waitForKeyPress,e.showDialog=!1,e.dialogOptions=!1,e.preloading=!0,e.fullscreen=this.settings.fullscreen,e.inFocus=!0,e}stopAudio(){this.sound&&this.sound.stop_all()}toggleFullscreen(){if(this.settings.embedded){let e=this.settings,t=e.basePlatformUrl+"/t/"+e.track.url;window.open(t)}else if(this.settings.fullscreenAvailable){let e=!this.settings.fullscreen;return this.settings.fullscreen=e,this.state.fullscreen=e,!0}}close(){window.removeEventListener("resize",this._onresize),this._onresize=null,this.pauseControls=null,this.score=null,this.mouse.close(),this.mouse=null,this.camera.close(),this.camera=null,this.screen.close(),this.screen=null,this.vehicleTimer.close(),this.vehicleTimer=null,this.playerManager.close(),this.playerManager=null,this.sound.close(),this.sound=null,this.track.close(),this.toolHandler.close(),this.game=null,this.assets=null,this.settings=null,this.track=null,this.state=null,this.stopAudio()}},me=class{defaultControlOptions={visible:!0};name=null;controlsSpriteSheetData={};controlData=null;game=null;scene=null;settings=null;controlsSprite=null;gamepad=null;properties={right:0,scaleX:window.devicePixelRatio/2,scaleY:window.devicePixelRatio/2,top:60,visible:!0,x:0,y:0};constructor(e){this.scene=e,this.game=e.game,this.assets=e.assets,this.settings=e.settings,this.mouse=e.mouse,this.playerManager=e.playerManager}init(){this.createSprite(),this.resize()}click(){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.scene.buttonDown(t.key)}}createSprite(){let e=this.scene.assets.getResult(this.name);this.controlsSpriteSheetData.images=[e],this.controlsSprite=e}draw(e){if(!this.properties.visible)return;let t=e.globalAlpha;"number"==typeof this.properties.alpha&&(e.globalAlpha=this.properties.alpha);for(const t in this.controlData){const s=this.controlData[t];let i=this.controlsSpriteSheetData[(s.image||t)+"_btn"],a=i[2]*this.properties.scaleX,r=i[3]*this.properties.scaleY;"number"==typeof s.alpha&&(e.globalAlpha=("number"!=typeof this.properties.alpha||this.properties.alpha)*(s.alpha/(2-!s.disabled))),e.drawImage(this.controlsSpriteSheetData.images[0],...i,this.game.width-s.right*this.properties.scaleX-a/2,s.top*this.properties.scaleY-r/2,a,r)}t!==e.globalAlpha&&(e.globalAlpha=t)}isMouseOverComponent(e){const{x:t,y:s}=this.mouse.touch.pos;return Math.sqrt((t-e.x)**2+(s-e.y)**2)<e.width/2*e.scaleX}isVisible(){return this.properties.visible}hide(){this.setVisibility(!1)}show(){this.setVisibility(!0)}setVisibility(e){this.properties.visible=e}mouseOver(e){e&&(e.alpha=this.mouse.touch.down?1:.8),this.mouse.enabled=!1,this.game.canvas.style.setProperty("cursor","pointer")}mouseOut(e){e&&(e.alpha=.5),this.mouse.enabled=!0,this.game.canvas.style.removeProperty("cursor")}controlDown(e){let t=e.target,s=t.buttonDetails,i=this.playerManager.firstPlayer.getGamepad();if(s.key&&i.setButtonDown(s.key),s.keys)for(let e=s.keys,t=0;e.length>t;t++)i.setButtonDown(e[t]);s.downCallback&&s.downCallback(e),this.mouse.enabled=!1,t.alpha=1}controlUp(e){let t=e.target,s=t.buttonDetails,i=this.playerManager.firstPlayer.getGamepad();if(s.key&&i.setButtonUp(s.key),s.keys)for(let e=s.keys,t=0;e.length>t;t++)i.setButtonUp(e[t]);s.upCallback&&s.upCallback(e),this.mouse.enabled=!0,t.alpha=.8}close(){}redraw(){for(const e in this.controlData){const t=this.controlData[e];!t.disabled&&this.isMouseOverComponent(t)?(this.mouseOver(t),t.hovering=!0):t.hovering&&!this.mouse.enabled&&(this.mouseOut(t),delete t.hovering)}}resize(){let e=this.scene.game,t=e.width,s=e.height;this.properties.scaleX=this.properties.scaleY=window.devicePixelRatio/2,this.properties.bottom&&(this.properties.y=s-this.properties.bottom*this.properties.scaleY),this.properties.left&&(this.properties.x=this.properties.left*this.properties.scaleX),this.properties.right&&(this.properties.x=t-this.properties.right*this.properties.scaleX),this.properties.top&&(this.properties.y=this.properties.top*this.properties.scaleY);for(const e in this.controlData){const i=this.controlData[e];i.scaleX=i.scaleY=window.devicePixelRatio/2,i.bottom&&(i.y=s-i.bottom*i.scaleY),i.left&&(i.x=i.left*i.scaleX),i.right&&(i.x=t-i.right*i.scaleX),i.top&&(i.y=i.top*i.scaleY)}}update(){}},ge=class extends me{name="pause_controls";paused=!1;controlsSpriteSheetData={pause_btn:[230,2,76,76],play_btn:[78,2,76,76]};controlData={pause:{alpha:.5,key:"pause",top:60,right:70,width:76,height:76}};constructor(){super(...arguments),this.init()}update(){let e=this.scene.state.paused;this.paused!==e&&(e?(this.controlData.pause.image="play",this.paused=!0):(this.controlData.pause.image="pause",this.paused=!1))}},ye=class extends me{name="redo_undo_controls";controlsSpriteSheetData={redo_btn:[78,2,76,76],undo_btn:[2,2,76,76]};controlData={redo:{keys:["ctrl","y"],alpha:.5,top:60,right:160,width:76,height:76},undo:{keys:["ctrl","z"],alpha:.5,top:60,right:240,width:76,height:76}};constructor(){super(...arguments),this.init()}click(){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.controlDown(t.keys)}}update(){let e=this.scene,t=e.state.paused,s=e.toolHandler;e.controls&&this.properties.visible!==t&&(this.properties.visible=t),this.controlData.undo.disabled=0===s.actionTimelinePointer,this.controlData.redo.disabled=s.actionTimelinePointer>=s.actionTimeline.length}},fe=class extends I{name="Brush";p1=null;p2=null;active=!1;options=null;constructor(e){super(e),this.p1=new o(0,0),this.p2=new o(0,0),this.active=!1;let t=e.scene.settings.brush;this.addedObjects=[],this.options={breakLength:t.breakLength,maxBreakLength:t.maxBreakLength,minBreakLength:t.minBreakLength,breakLengthSensitivity:t.breakLengthSensitivity,trailSpeed:t.trailSpeed,maxTrailSpeed:t.maxTrailSpeed,minTrailSpeed:t.minTrailSpeed,trailSpeedSensitivity:t.trailSpeedSensitivity}}reset(){this.recordActionsToToolhandler(),this.active=!1}recordActionsToToolhandler(){var e,t=this.addedObjects,s=t.length;if(s)for(e=0;s>e;e++)this.toolhandler.addActionToTimeline({type:"add",objects:[t[e]]});this.addedObjects=[]}press(){if(this.recordActionsToToolhandler(),!this.active){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}}hold(){let e=this.mouse.touch.real,t=this.p1,s=this.p2,i=this.options.trailSpeed,a=this.options.breakLength;s.inc(e.sub(s).factor(i));let r=screen.height+e.sub(s).len();if(r*=a,s.sub(t).lenSqr()>r){let e=this.scene.track,i=!1;i="physics"===this.toolhandler.options.lineType?e.addPhysicsLine(t.x,t.y,s.x,s.y):e.addSceneryLine(t.x,t.y,s.x,s.y),i&&this.addedObjects.push(i),t.equ(s),this.toolhandler.snapPoint.x=s.x,this.toolhandler.snapPoint.y=s.y}this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p1,t=this.p2,s=this.scene.track,i=!1;i="physics"===this.toolhandler.options.lineType?s.addPhysicsLine(e.x,e.y,t.x,t.y):s.addSceneryLine(e.x,e.y,t.x,t.y),i&&this.addedObjects.push(i),this.recordActionsToToolhandler();let a=this.toolhandler.snapPoint;a.x=t.x,a.y=t.y,this.active=!1}update(){let e=this.toolhandler.gamepad,t=this.mouse;e.isButtonDown("alt")?!1!==t.mousewheel&&this.adjustTrailSpeed(t.mousewheel):e.isButtonDown("shift")&&!1!==t.mousewheel&&this.adjustBreakLength(t.mousewheel);let s=this.toolhandler;s.options.snap&&(this.active=!0,this.p1.x=s.snapPoint.x,this.p1.y=s.snapPoint.y,this.p2.x=t.touch.real.x,this.p2.y=t.touch.real.y),super.update()}adjustTrailSpeed(e){let t=this.options.trailSpeed,s=this.options.trailSpeedSensitivity,i=this.options.maxTrailSpeed,a=this.options.minTrailSpeed;e>0?(t+=s,t>i&&(t=i)):(t-=s,a>t&&(t=a)),this.setOption("trailSpeed",t)}adjustBreakLength(e){let t=this.options.breakLength,s=this.options.breakLengthSensitivity,i=this.options.maxBreakLength,a=this.options.minBreakLength;e>0?(t+=s,t>i&&(t=i)):(t-=s,a>t&&(t=a)),this.setOption("breakLength",t)}setOption(e,t){this.options[e]=t}getOptions(){let e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}draw(e){let t=this.scene.camera.zoom;this.drawCursor(e),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t))}drawText(e){let t=this.name,s=this.options.breakLength,i=this.options.trailSpeed,a=this.game.pixelRatio;e.fillStyle=/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":"#000",e.font=12*a+"pt arial",e.fillText(t,10*a,20*a),e.font=8*a+"pt arial",i|=0,e.fillText("Trail speed : "+i,10*a,40*a),e.fillText("Break length : "+s,10*a,60*a)}drawCursor(e){let t=this.mouse.touch.real.toScreen(this.scene),s=this.camera.zoom,i=this.toolhandler.options.grid;if(e.beginPath(),i){let i=5*s;e.moveTo(t.x,t.y-i),e.lineTo(t.x,t.y+i),e.moveTo(t.x-i,t.y),e.lineTo(t.x+i,t.y),e.lineWidth=1*s,e.stroke()}else e.arc(t.x,t.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPoint(e,t,s){let i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawLine(e,t){let s=this.toolhandler.options.lineType;e.beginPath(),e.lineWidth=Math.max(.5,2*t),e.lineCap="round",e.strokeStyle="#".padEnd(7,"physics"===s?/^midnight$/i.test(lite.storage.get("theme"))?"C":/^dark$/i.test(lite.storage.get("theme"))?"FB":"0":/^midnight$/i.test(lite.storage.get("theme"))?"8":/^dark$/i.test(lite.storage.get("theme"))?"6":"A");let i=this.p1.toScreen(this.scene),a=this.p2.toScreen(this.scene);e.moveTo(i.x,i.y),e.lineTo(a.x,a.y),e.stroke()}},we=class extends I{name="Curve";active=!1;p1=null;p2=null;midpoint=null;anchoring=!1;options=null;constructor(e){super(e),this.p1=new o(0,0),this.p2=new o(0,0),this.midpoint=new o(0,0),this.active=!1,this.options={}}getOptions(){let e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}reset(){this.active=!1,this.anchoring=!1}press(){if(!this.active){this.active=!0;var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y}}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y;let t=this.p1,s=this.p2;this.midpoint.x=(t.x+s.x)/2,this.midpoint.y=(t.y+s.y)/2,this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p1,t=this.p2,s=this.midpoint,i=this.toolhandler;if(this.anchoring){var a;if(s.x===t.x&&s.y===t.y)(a=this.scene.track["add"+("physics"===i.options.lineType?"Physics":"Scenery")+"Line"](e.x,e.y,t.x,t.y))&&i.addActionToTimeline({type:"add",objects:[a]}),i.snapPoint.x=t.x,i.snapPoint.y=t.y;else this.splitAndAddCurve();this.anchoring=!1,this.active=!1}else{var r=t.x-e.x,o=t.y-e.y;Math.sqrt(Math.pow(r,2)+Math.pow(o,2))>0?this.anchoring=!0:this.active=!1}}updateAnchor(){let e=this.mouse.touch.real;this.midpoint.x=e.x,this.midpoint.y=e.y}splitAndAddCurve(){for(var e=function(e,t,s){let i=e.x,a=e.y,r=t.x,o=t.y,n=s.x,h=s.y,l=[];return l.push(i,a),function e(t,s,i,a,r,o,n){if(!(n>10)){var h=(t+i)/2,c=(s+a)/2,d=(i+r)/2,p=(a+o)/2,u=(h+d)/2,m=(c+p)/2,g=r-t,y=o-s,f=Math.abs((i-r)*y-(a-o)*g);if(f>1e-30){if(.25*(g*g+y*y)>=f*f)return void l.push(u,m)}else if(.25>=(g=u-(t+r)/2)*g+(y=m-(s+o)/2)*y)return void l.push(u,m);e(t,s,h,c,u,m,n+1),e(u,m,d,p,r,o,n+1)}}(i,a,r,o,n,h,0),l.push(n,h),l}(this.p1,this.midpoint,this.p2),t=this.scene.track,s=e.length,i=this.toolhandler,a=[],r=0;s-2>r;r+=2){let s=e[r],o=e[r+1],n=e[r+2],h=e[r+3],l=t["add"+("physics"===i.options.lineType?"Physics":"Scenery")+"Line"](s,o,n,h);l&&a.push(l),i.snapPoint.x=n,i.snapPoint.y=h}a.length>0&&i.addActionToTimeline({type:"add",objects:a})}update(){var e=this.mouse,t=e.touch,s=e.secondaryTouch,i=this.toolhandler.gamepad,a=this.toolhandler;a.options.snap&&(this.active=!0,this.p1=a.snapPoint,this.anchoring||this.hold());var r=this.toolhandler.options,o=i.isButtonDown("shift");r.rightClickMove&&(o=s.old.down),o?(t.old.down||r.rightClickMove)&&this.moveCamera():(t.press&&!this.anchoring&&this.press(),t.old.down&&!this.anchoring&&this.hold(),t.release&&this.release(),this.anchoring&&this.updateAnchor()),!1!==e.mousewheel&&!1===i.isButtonDown("shift")&&this.mousewheel(e.mousewheel)}draw(e){let t=this.scene.camera.zoom;this.drawCursor(e,t),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t))}toScreen(e,t){let s=this.scene.camera,i=this.scene.screen;return(e-s.position[t])*s.zoom+i.center[t]}drawCursor(e,t){var s=this.mouse.touch.real.toScreen(this.scene),i=this.toolhandler.options.grid;if(e.beginPath(),i){let i=5*t;e.moveTo(s.x,s.y-i),e.lineTo(s.x,s.y+i),e.moveTo(s.x-i,s.y),e.lineTo(s.x+i,s.y),e.lineWidth=1*t,e.stroke()}else e.arc(s.x,s.y,1*t,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPoint(e,t,s){let i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawText(e){let t=this.name,s=this.game.pixelRatio;e.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":"#000",e.font=12*s+"pt arial",e.fillText(t,10*s,20*s),e.font=8*s+"pt arial"}drawLine(e,t){let s=this.toolhandler.options.lineType;e.beginPath(),e.lineWidth=Math.max(.5,2*t),e.lineCap="round",e.strokeStyle="#".padEnd(7,"physics"===s?/^midnight$/i.test(lite.storage.get("theme"))?"C":/^dark$/i.test(lite.storage.get("theme"))?"FB":"0":/^midnight$/i.test(lite.storage.get("theme"))?"8":/^dark$/i.test(lite.storage.get("theme"))?"6":"A");let i=this.p1.toScreen(this.scene),a=this.p2.toScreen(this.scene),r=this.midpoint.toScreen(this.scene);e.moveTo(i.x,i.y),e.quadraticCurveTo(r.x,r.y,a.x,a.y),e.stroke()}},xe=class extends I{name="Eraser";options=null;constructor(e){super(e),this.options=e.scene.settings.eraser,this.eraserPoint=new o,this.erasedObjects=[]}reset(){this.recordActionsToToolhandler()}press(){this.recordActionsToToolhandler()}recordActionsToToolhandler(){this.erasedObjects.length>0&&this.toolhandler.addActionToTimeline({type:"remove",objects:this.erasedObjects.flat()}),this.erasedObjects=[]}release(){this.recordActionsToToolhandler()}hold(){let e=this.mouse.touch.pos,t=this.scene.track,s=this.scene.screen,i=this.scene.camera,a=s.center,r=i.position,o=(e.x-a.x)/i.zoom+r.x,n=(e.y-a.y)/i.zoom+r.y;this.eraserPoint.x=Math.round(o),this.eraserPoint.y=Math.round(n);let h=t.erase(this.eraserPoint,this.options.radius/this.scene.camera.zoom,this.options.types);h.length>0&&this.erasedObjects.push(h)}draw(e){this.drawEraser(e)}drawEraser(e){let t=this.mouse.touch.pos,s=window.lite&&lite.storage.get("theme");e.save(),e.beginPath(),e.arc(t.x,t.y,this.options.radius,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle=/^midnight$/i.test(s)?"rgba(29,35,40,0.8)":/^dark$/i.test(s)?"rgba(33,33,33,0.8)":"rgba(255,255,255,0.8)",e.fill(),e.strokeStyle=this.scene.settings.physicsLineColor,e.stroke(),e.restore()}setOption(e,t){this.options[e]=t}getOptions(){return this.options}update(){let e=this.toolhandler.gamepad,t=this.mouse;e.isButtonDown("shift")&&!1!==t.mousewheel&&this.adjustRadius(t.mousewheel),super.update()}adjustRadius(e){let t=this.options.radius,s=this.options.radiusSizeSensitivity,i=this.options.maxRadius,a=this.options.minRadius;t+=e>0?s:-s,this.setOption("radius",Math.min(i,Math.max(a,t)))}},ve=class extends I{active=!1;name="powerup";p1=null;powerup=null;constructor(e){super(e),this.p1=new o(0,0)}draw(e){let t=this.mouse.touch,s=this.camera.zoom,i=this.scene.settings.device,a=this.scene.screen;if(!0===this.active){let t=a.realToScreen(this.p1.x,"x"),i=a.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(t,i,s,e),e.globalAlpha=1}else if("desktop"===i){let i=a.realToScreen(t.real.x,"x"),r=a.realToScreen(t.real.y,"y");e.globalAlpha=.8,this.powerup.draw(i,r,s,e),e.globalAlpha=1}}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.active=!0}release(){let e=this.scene.track,t=new this.powerup.constructor(this.p1.x,this.p1.y,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},be=class extends ve{name="antigravity";constructor(e){super(e),this.powerup=new c(0,0,e.scene.track)}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y;let t=this.scene.track,s=new c(this.p1.x,this.p1.y,t);t.addPowerup(s),this.toolhandler.addActionToTimeline({type:"add",objects:[s]})}release(){}},ke=class extends ve{name="bomb";constructor(e){super(e),this.powerup=new d(0,0,e.scene.track)}},Te=class extends ve{name="boost";p2=null;constructor(e){super(e),this.p2=new o(0,0),this.powerup=new p(0,0,0,e.scene.track)}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){let e=this.scene.track,t=new p(this.p1.x,this.p1.y,this.powerup.angle,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}draw(e){let t=this.mouse.touch,s=this.camera.zoom,i=this.scene.screen,a=this.scene.settings.device;if(!0===this.active){let t=i.realToScreen(this.p1.x,"x"),a=i.realToScreen(this.p1.y,"y"),r=this.p1,o=this.p2,n=r.y-o.y,h=r.x-o.x,l=Math.atan2(r.y-o.y,r.x-o.x);0===h&&0===n&&(l=Math.PI-Math.PI/2),0>l&&(l+=2*Math.PI),this.drawPathToMouse(e,l),this.powerup.angle=l*(180/Math.PI)-90|0,this.powerup.draw(t,a,s,e)}else if("desktop"===a){e.globalAlpha=.8,this.powerup.angle=0;let a=i.realToScreen(t.real.x,"x"),r=i.realToScreen(t.real.y,"y");this.powerup.draw(a,r,s,e),e.globalAlpha=1}}drawPathToMouse(e,t){let s=this.p1,i=this.p2,a=this.scene.screen,r=this.scene.camera.zoom,o=a.realToScreen(s.x,"x"),n=a.realToScreen(s.y,"y"),h=a.realToScreen(i.x,"x"),l=a.realToScreen(i.y,"y"),c=Math.sqrt(Math.pow(h-o,2)+Math.pow(l-n,2));30*r>c&&(c=30*r),e.strokeStyle="#ADCF7D",e.lineWidth=Math.max(1,2*r),e.beginPath(),e.moveTo(o+c,n),e.lineTo(o,n),e.lineTo(h,l),e.stroke();let d=t+Math.PI/180*180,p=Math.min(c,50*r);e.beginPath(),e.moveTo(o,n),e.arc(o,n,p,d,0,!1),e.stroke(),e.fillStyle="rgba(173, 207, 125,0.2)",e.fill()}},Se=class extends ve{name="checkpoint";constructor(e){super(e),this.powerup=new u(0,0,e.scene.track)}},_e=class extends ve{name="goal";constructor(e){super(e),this.powerup=new y(0,0,e.scene.track)}release(){let e=this.scene.track,t=new this.powerup.constructor(this.p1.x,this.p1.y,e);e.addTarget(t),e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},Ce=class extends ve{name="gravity";p2=null;constructor(e){super(e),this.p2=new o(0,0),this.powerup=new m(0,0,0,e.scene.track)}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){let e=this.scene.track,t=new m(this.p1.x,this.p1.y,this.powerup.angle-180,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}draw(e){var t=this.mouse.touch,s=(t.pos,this.camera.zoom),i=this.scene.screen,a=this.scene.settings.device;if(!0===this.active){var r=i.realToScreen(this.p1.x,"x"),o=i.realToScreen(this.p1.y,"y"),n=this.p1,h=this.p2,l=n.y-h.y,c=n.x-h.x,d=Math.atan2(n.y-h.y,n.x-h.x);0===c&&0===l&&(d=Math.PI-Math.PI/2),0>d&&(d+=2*Math.PI),this.drawPathToMouse(e,d),this.powerup.angle=d*(180/Math.PI)+90|0,this.powerup.draw(r,o,s,e)}else"desktop"===a&&(e.globalAlpha=.8,this.powerup.angle=180,r=i.realToScreen(t.real.x,"x"),o=i.realToScreen(t.real.y,"y"),this.powerup.draw(r,o,s,e),e.globalAlpha=1)}drawPathToMouse(e,t){let s=this.p1,i=this.p2,a=this.scene.screen,r=this.scene.camera.zoom,o=a.realToScreen(s.x,"x"),n=a.realToScreen(s.y,"y"),h=a.realToScreen(i.x,"x"),l=a.realToScreen(i.y,"y"),c=Math.sqrt(Math.pow(h-o,2)+Math.pow(l-n,2));30*r>c&&(c=30*r),e.strokeStyle="#A2B7D2",e.lineWidth=Math.max(1,2*r),e.beginPath(),e.moveTo(o+c,n),e.lineTo(o,n),e.lineTo(h,l),e.stroke();let d=t+Math.PI/180*180,p=Math.min(c,50*r);e.beginPath(),e.moveTo(o,n),e.arc(o,n,p,d,0,!1),e.stroke(),e.fillStyle="rgba(162, 183, 210,0.2)",e.fill()}},Pe=class extends ve{name="slowmo";constructor(e){super(e),this.powerup=new g(0,0,e.scene.track)}},Me=class extends ve{name="teleport";p2=null;constructor(e){super(e),this.p2=new o(0,0),this.powerup=new f(0,0,e.scene.track)}press(){super.press(),this.portal1=new f(this.p1.x,this.p1.y,this.scene.track)}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){let e=Math.abs(this.p2.x-this.p1.x),t=Math.abs(this.p2.y-this.p1.y);if(e>40||t>40){let e=this.scene.track;this.portal2=new f(this.p2.x,this.p2.y,e),this.portal1.addOtherPortalRef(this.portal2),this.portal2.addOtherPortalRef(this.portal1),e.addPowerup(this.portal1),e.addPowerup(this.portal2),this.toolhandler.addActionToTimeline({type:"add",objects:[this.portal1,this.portal2]})}else this.portal1=null;this.active=!1}draw(e){let t=this.mouse.touch,s=this.camera.zoom,i=this.scene.screen,a=this.scene.settings.device;if(!0===this.active){let t=i.realToScreen(this.p1.x,"x"),a=i.realToScreen(this.p1.y,"y"),r=i.realToScreen(this.p2.x,"x"),o=i.realToScreen(this.p2.y,"y"),n=this.p1,h=this.p2,l=n.y-h.y,c=n.x-h.x,d=Math.atan2(n.y-h.y,n.x-h.x);0===c&&0===l&&(d=Math.PI-Math.PI/2),0>d&&(d+=2*Math.PI),this.drawPathToMouse(e,d),this.portal1.draw(t,a,s,e),this.powerup.draw(r,o,s,e)}else if("desktop"===a){e.globalAlpha=.8;let a=i.realToScreen(t.real.x,"x"),r=i.realToScreen(t.real.y,"y");this.powerup.draw(a,r,s,e),e.globalAlpha=1}}drawPathToMouse(e){let t=this.p1,s=this.p2,i=this.scene.screen,a=this.scene.camera.zoom,r=i.realToScreen(t.x,"x"),o=i.realToScreen(t.y,"y"),n=i.realToScreen(s.x,"x"),h=i.realToScreen(s.y,"y"),l=Math.sqrt(Math.pow(n-r,2)+Math.pow(h-o,2));30*a>l&&(l=30*a),e.strokeStyle="#dd45ec",e.lineWidth=Math.max(1,2*a),e.beginPath(),e.moveTo(r,o),e.lineTo(n,h),e.stroke(),e.closePath()}},Ae=class extends I{name="Powerup";options={selected:"goal"};powerupTools={};constructor(e){super(e),this.registerPowerupTools()}registerPowerupTools(){this.registerTool(new _e(this.toolhandler)),this.registerTool(new Te(this.toolhandler)),this.registerTool(new Ce(this.toolhandler)),this.registerTool(new Pe(this.toolhandler)),this.registerTool(new ke(this.toolhandler)),this.registerTool(new Se(this.toolhandler)),this.registerTool(new be(this.toolhandler)),this.registerTool(new Me(this.toolhandler))}registerTool(e){this.powerupTools[e.name]=e}setOption(e,t){this.options[e]=t}getOptions(){return this.options}update(){let e=this.toolhandler.gamepad,t=this.options;e.isButtonDown("opt1")&&(t.selected="goal",e.setButtonUp("opt1"),this.scene.updateState()),e.isButtonDown("opt2")&&(t.selected="boost",e.setButtonUp("opt2"),this.scene.updateState()),e.isButtonDown("opt3")&&(t.selected="gravity",e.setButtonUp("opt3"),this.scene.updateState()),e.isButtonDown("opt4")&&(t.selected="slowmo",e.setButtonUp("opt4"),this.scene.updateState()),e.isButtonDown("opt5")&&(t.selected="bomb",e.setButtonUp("opt5"),this.scene.updateState()),e.isButtonDown("opt6")&&(t.selected="checkpoint",e.setButtonUp("opt6"),this.scene.updateState()),e.isButtonDown("opt7")&&(t.selected="antigravity",e.setButtonUp("opt7"),this.scene.updateState()),e.isButtonDown("opt8")&&Application.User.get("classic")&&(t.selected="teleport",e.setButtonUp("opt8"),this.scene.updateState()),super.update()}press(){let e=this.options.selected;this.powerupTools[e].press()}hold(){let e=this.options.selected;this.powerupTools[e].hold()}release(){let e=this.options.selected;this.powerupTools[e].release()}draw(e){this.powerupTools[this.options.selected].draw(e)}},ze=class{start=null;end=null;verticies=[];build(e){let t=e.pop();this.start=t.p1,this.end=t.p2,this.verticies.push(t);for(let t=e.length-1;t>=0;t--){let s=e[t],i=s.p1,a=s.p2;this.start.x===a.x&&this.start.y===a.y?(this.verticies.unshift(s),this.start=s.p1,e.splice(t,1)):this.end.x===i.x&&this.end.y===i.y&&(this.verticies.push(s),this.end=s.p2,e.splice(t,1))}}},De=class extends I{name="Select";passive=!1;active=!1;dashOffset=0;p1=null;p2=null;travelDistance=1;addedObjects=[];selectedElements=[];selectedSegments=[];constructor(e){super(e),this.p1=new o(0,0),this.p2=new o(0,0),document.addEventListener("keydown",this.keyPress.bind(this))}press(){let e=this.mouse.touch.real;this.passive=!1,this.active=!0,this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}unselectElements(){this.selectedElements=[],this.selectedSegments=[]}moveSelected(e){for(let t in this.selectedSegments)this.selectedSegments.find((t=>t.otherPortal==e))?this.selectedSegments.splice(t,1):(this.selectedSegments[t]=this.selectedSegments[t].move("ArrowLeft"==e?-this.travelDistance:"ArrowRight"==e?this.travelDistance:0,"ArrowUp"==e?-this.travelDistance:"ArrowDown"==e?this.travelDistance:0),this.scene.track.undraw())}fillSelected(){if(this.p1.y<this.p2.y)for(let e=this.p1.y;e<this.p2.y;e++)this.selectedSegments.push(this.scene.track.addPhysicsLine(this.p1.x,e,this.p2.x,e));else for(let e=this.p2.y;e<this.p1.y;e++)this.selectedSegments.push(this.scene.track.addPhysicsLine(this.p2.x,e,this.p1.x,e));this.selectedElements.push(...this.selectedSegments),this.selectedSegments.length>0&&this.toolhandler.addActionToTimeline({type:"add",objects:this.selectedSegments.flat()})}rotateSelected(){let e=(this.travelDistance||0)*Math.PI/180,t=this.selectedSegments;this.selectedSegments=[];for(let s of t.filter((e=>"physics"==e.type||"scenery"==e.type)))this.selectedSegments.push(this.scene.track["physics"==s.type?"addPhysicsLine":"addSceneryLine"](Math.cos(e)*s.p1.x+Math.sin(e)*s.p1.y,-Math.sin(e)*s.p1.x+Math.cos(e)*s.p1.y,Math.cos(e)*s.p2.x+Math.sin(e)*s.p2.y,-Math.sin(e)*s.p2.x+Math.cos(e)*s.p2.y)),s.removeAllReferences()}copyAndPasteSelected(){for(let e of this.selectedSegments.filter((e=>"physics"==e.type||"scenery"==e.type)))this.scene.track["add"+("physics"==e.type?"Physics":"Scenery")+"Line"](e.p1.x,e.p1.y,e.p2.x,e.p2.y)}release(){this.unselectElements();for(let e of this.scene.track.select(this.p1,this.p2))this.intersectsLine(e.x?e:e.p1,e.x?e:e.p2)&&this.selectedSegments.push(e);this.selectedElements=this.selectedSegments,this.active=!1,this.passive=!0}keyPress(e){if(this.active){switch(e.preventDefault(),e.key){case"=":case"+":this.travelDistance++,this.scene.message.show("Increased travel distance for the Select Tool - "+this.travelDistance,!1,"#000","#FFF");break;case"-":this.travelDistance--,this.scene.message.show("Decreased travel distance for the Select Tool - "+this.travelDistance,!1,"#000","#FFF");break;case"c":this.copyAndPasteSelected(e.key),this.scene.message.show("Copied selected area",!1,"#000000","#FFFFFF");break;case"Delete":this.selectedElements.length>0&&this.toolhandler.addActionToTimeline({type:"remove",objects:this.selectedElements.flatMap((e=>e))});for(const e of this.selectedElements)e.removeAllReferences();this.reset(),this.scene.message.show("Deleted selected area",!1,"#000","#FFF");break;case"f":confirm("Are you sure you would you like to fill the selected area?")&&(this.fillSelected(),this.scene.message.show("Filled selected area",!1,"#000","#FFF"));break;case"r":this.rotateSelected(),this.scene.message.show("Rotated selected area",!1,"#000","#FFF");break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":this.moveSelected(e.key),this.scene.message.show("Moved Selected Area",!1,"#000","#FFF");break;case"`":case"Escape":this.reset()}this.timeout=setTimeout((()=>this.scene.message.hide()),1e3)}}buildPaths(e){for(let t=[];e.length>0;){let s=new ze;s.build(e),t.push(s)}}intersectsLine(e,t){let s=Math.min(this.p1.y,this.p2.y),i=Math.min(this.p1.x,this.p2.x),a=Math.max(this.p1.y,this.p2.y),r=Math.max(this.p1.x,this.p2.x),o=Math.abs(r-i),n=Math.abs(s-a),h=e.x,l=t.x;if(e.x>t.x&&(h=t.x,l=e.x),l>i+o&&(l=i+o),i>h&&(h=i),h>l)return!1;let c=e.y,d=t.y,p=t.x-e.x;if(Math.abs(p)>1e-7){let s=(t.y-e.y)/p,i=e.y-s*e.x;c=s*h+i,d=s*l+i}return c>d&&([d,c]=[c,d]),d>s+n&&(d=s+n),s>c&&(c=s),!(c>d)}toScreen(e,t){let s=this.scene.camera,i=this.scene.screen;return(e-s.position[t])*s.zoom+i.center[t]}draw(e){let t=this.scene;if(this.active||this.passive){let s=this.p1.toScreen(t),i=this.p2.toScreen(t),a=i.x-s.x,r=i.y-s.y;e.save(),this.active?(e.beginPath(),e.rect(s.x,s.y,a,r),e.fillStyle="rgba(24, 132, 207, 0.2)",e.fill(),e.lineWidth=2,e.strokeStyle="rgba(24, 132, 207, 0.7)",e.stroke()):this.passive&&(e.strokeStyle="rgba(24, 132, 207, 0.7)",e.lineWidth=2,e.strokeRect(s.x,s.y,a,r)),e.restore()}}reset(){this.p1.x=0,this.p1.y=0,this.p2.x=0,this.p2.y=0,this.active=!1,this.passive=!1,this.unselectElements()}close(){this.dashOffset=0,this.selectedElements=null,this.mouse=null,this.camera=null,this.scene=null,this.toolHandler=null,this.p2=null,this.p1=null,this.active=!1,this.passive=!1}},Le=class extends I{name="StraightLine";p1=null;p2=null;active=!1;constructor(e){super(e),this.p1=new o(0,0),this.p2=new o(0,0),this.active=!1,this.shouldDrawMetadata=!1,this.options={}}reset(){this.active=!1}press(){if(!this.active){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.active=!0}}getOptions(){let e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y,this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p1,t=this.p2,s=this.scene.track,i=this.toolhandler,a=!1;a="physics"===i.options.lineType?s.addPhysicsLine(e.x,e.y,t.x,t.y):s.addSceneryLine(e.x,e.y,t.x,t.y),a&&i.addActionToTimeline({type:"add",objects:[a]});let r=i.snapPoint;r.x=t.x,r.y=t.y,this.active=!1}update(){super.update();let e=this.toolhandler,t=e.gamepad;e.options.snap&&(this.active=!0,this.p1=e.snapPoint,this.hold()),this.shouldDrawMetadata=!!t.isButtonDown("ctrl")}draw(e){let t=this.scene.camera.zoom;e.save(),this.drawCursor(e),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t),this.drawPointData(e,this.p2,t)),e.restore()}drawCursor(e){let t=this.mouse.touch.real.toScreen(this.scene),s=this.camera.zoom,i=this.toolhandler.options.grid;if(e.beginPath(),i){let i=5*s;e.moveTo(t.x,t.y-i),e.lineTo(t.x,t.y+i),e.moveTo(t.x-i,t.y),e.lineTo(t.x+i,t.y),e.lineWidth=1*s,e.closePath(),e.stroke()}else e.lineWidth=1,e.fillStyle="#1884cf",e.arc(t.x,t.y,1*s,0,2*Math.PI,!1),e.closePath(),e.fill()}drawPoint(e,t,s){let i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPointData(e,t){let s=t.toScreen(this.scene);if(this.shouldDrawMetadata){let t=this.p1.getAngleInDegrees(this.p2);t=t.toFixed(2);let i=this.game.pixelRatio;e.fillStyle=/^midnight$/i.test(lite.storage.get("theme"))?"C":/^dark$/i.test(lite.storage.get("theme"))?"FB":"0",e.font=8*i+"pt arial",e.fillText(t+"°",s.x+10,s.y+10),e.strokeText(t+"°",s.x+10,s.y+10)}}drawLine(e,t){let s=this.toolhandler.options.lineType;e.beginPath(),e.lineWidth=Math.max(.5,2*t),e.lineCap="round",e.strokeStyle="#".padEnd(7,"physics"===s?/^midnight$/i.test(lite.storage.get("theme"))?"C":/^dark$/i.test(lite.storage.get("theme"))?"FB":"0":/^midnight$/i.test(lite.storage.get("theme"))?"8":/^dark$/i.test(lite.storage.get("theme"))?"6":"A");let i=this.p1.toScreen(this.scene),a=this.p2.toScreen(this.scene);e.moveTo(i.x,i.y),e.lineTo(a.x,a.y),e.stroke()}},Oe=class extends ve{name="vehiclepowerup";options=null;constructor(e,t){super(t),this.options=e.options}release(){let e=this.scene.track,t=new this.powerup.constructor(this.p1.x,this.p1.y,this.options.time,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},Ee=class extends Oe{name="balloon";constructor(e,t){super(e,t),this.powerup=new v(0,0,0,t.scene.track)}},Be=class extends Oe{name="blob";constructor(e,t){super(e,t),this.powerup=new b(0,0,0,t.scene.track)}},Ie=class extends Oe{name="helicopter";constructor(e,t){super(e,t),this.powerup=new k(0,0,0,t.scene.track)}},Re=class extends Oe{name="truck";constructor(e,t){super(e,t),this.powerup=new T(0,0,0,t.scene.track)}},Fe=class extends I{name="vehiclepowerup";powerupTools={};constructor(e){super(e),this.options=e.scene.settings.vehiclePowerup,this.registerPowerupTools()}registerPowerupTools(){this.registerTool(new Ie(this,this.toolhandler)),this.registerTool(new Re(this,this.toolhandler)),this.registerTool(new Ee(this,this.toolhandler)),this.registerTool(new Be(this,this.toolhandler))}registerTool(e){this.powerupTools[e.name]=e}setOption(e,t){this.options[e]=t}getOptions(){return this.options}press(){let e=this.options.selected;this.powerupTools[e].press()}hold(){let e=this.options.selected;this.powerupTools[e].hold()}release(){let e=this.options.selected;this.powerupTools[e].release()}draw(e){this.powerupTools[this.options.selected].draw(e)}},je=class extends ue{clear=!1;redoundoControls=null;verified=!1;constructor(e){super(e),this.mouse.disableContextMenu(),this.createMainPlayer(),this.createControls(),this.registerTools(),this.state=this.setStateDefaults(),this.oldState=this.setStateDefaults(),this.restart(),this.initializeAnalytics()}createMainPlayer(){super.createMainPlayer().setKeyMap(this.settings.editorHotkeys)}createTrack(){let e=super.createTrack(),t=this.getAvailableTrackCode();0!=t?(e.read(t),this.state.preloading=!1,this.state.loading=!1):e.addDefaultLine(),this.importCode=!1,this.restartTrack=!0,this.clear=!1}getCanvasOffset(){return{height:this.settings.isStandalone?202:90,width:0}}initializeAnalytics(){this.analytics={deaths:0,mouseEvents:0},this.trackAction("editor-open","open")}createControls(){this.redoundoControls=new ye(this),this.pauseControls=new ge(this)}redrawControls(){super.redrawControls(),this.redoundoControls.redraw()}registerTools(){let e=super.registerTools();e.enableGridUse(),e.registerTool(we),e.registerTool(Le),e.registerTool(fe),e.registerTool(De),e.registerTool(xe),e.registerTool(Ae),e.registerTool(Fe),e.setTool(this.settings.startTool)}play(){this.state.playing=!0}interactWithControls(){super.interactWithControls(),this.redoundoControls.click()}updateControls(){super.updateControls(),this.redoundoControls.update()}fixedUpdate(){this.updateToolHandler(),this.mouse.update(),this.state.showDialog||(this.playerManager.updateGamepads(),this.playerManager.checkKeys()),super.fixedUpdate(),(this.importCode||this.clear)&&this.createTrack()}draw(e){super.draw(...arguments),this.redoundoControls.draw(e)}restart(){this.verified=!this.settings.requireTrackVerification,this.track.dirty=!1,this.track.resetPowerups(),this.message.hide(),this.restartTrack=!1,this.state.playing=!1,this.ticks=0,this.playerManager.reset(),this.camera.focusOnPlayer(),this.camera.fastforward(),this.score.update()}buttonDown(e){super.buttonDown(e);let t=this.camera;switch(this.state.playing=!0,e){case"up":case"down":case"left":case"right":t.focusOnMainPlayer()}}resize(){this.pauseControls.resize(),this.redoundoControls.resize(),super.resize()}updateState(){let e=this.state;e&&(e.tool=this.toolHandler.currentTool,e.toolOptions=this.toolHandler.getToolOptions(),e.grid=this.toolHandler.options.grid,e.cameraLocked=this.toolHandler.options.cameraLocked,super.updateState())}setStateDefaults(){let e=super.setStateDefaults();return e.paused=this.settings.startPaused,e.loading=!1,e.playing=this.settings.waitForKeyPress,e.preloading=!1,e.tool=this.toolHandler.currentTool,e.toolOptions=this.toolHandler.getToolOptions(),e.grid=this.toolHandler.options.grid,e.cameraLocked=this.toolHandler.options.cameraLocked,e.zoomPercentage=this.camera.zoomPercentage,e.vehicle=this.vehicle,this.controls&&(e.hideMenus=this.controls.isVisible()),e}trackAction(e,t){var s={category:"create",action:e,label:t,value:this.toolHandler.analytics.actions+this.mouse.analytics.clicks,non_interaction:!0};Application.Helpers.GoogleAnalyticsHelper.track_event(s)}openDialog(e){switch(this.state.dialogOptions={},e){case"import":break;case"export":setTimeout(this.getTrackCode.bind(this),750);break;case"upload":"undefined"==typeof isChromeApp&&setTimeout(this.getTrackCode.bind(this),750)}super.openDialog(e)}getTrackCode(){this.state.dialogOptions={},this.state.dialogOptions.verified=this.verified,this.state.dialogOptions.code=this.track.getCode()}trackComplete(){this.verified=!this.track.dirty}hideControlPlanel(){}showControlPlanel(){}command(e,...t){switch(super.command(...arguments),e){case"change tool":let e=t[0];this.toolHandler.setTool(e);break;case"change tool option":let s=t[0],i=t[1];void 0!==t[2]?this.toolHandler.setToolOption(s,i,t[2]):this.toolHandler.setToolOption(s,i);break;case"snap":this.toolHandler.toggleSnap();break;case"redraw":this.redraw();break;case"fullscreen":this.settings.fullscreen=this.state.fullscreen=!this.settings.fullscreen;break;case"grid":this.toolHandler.toggleGrid();break;case"lock camera":this.toolHandler.toggleCameraLock();break;case"toggle vehicle":this.toggleVehicle(),this.updateState();break;case"reset zoom":this.camera.resetZoom();break;case"increase zoom":this.camera.increaseZoom();break;case"decrease zoom":this.camera.decreaseZoom();break;case"change lineType":let a=t[0];this.toolHandler.options.lineType=a,this.updateState();break;case"clear track":this.trackAction("editor-action","clear"),this.clear=!0;break;case"import":let r=t[0];r.length<=0&&(r=!1),this.importCode=r,this.clear=t[1],this.command("dialog",!1)}}close(){this.trackAction("editor-exit","exit"),super.close()}},He=class extends me{name="fullscreen_controls";fullscreen=!1;controlsSpriteSheetData={exit_fullscreen_btn:[230,2,76,76],fullscreen_btn:[78,2,76,76]};controlData={fullscreen:{top:60,right:150,key:"fullscreen",alpha:.5,width:76,height:76}};constructor(){super(...arguments),this.init()}update(){let e=this.scene.settings.fullscreen;this.fullscreen!==e&&(this.controlData.fullscreen.image=e?"exit_fullscreen":"fullscreen",this.fullscreen=e)}},We=class extends me{name="settings_controls";controlsSpriteSheetData={settings_btn:[78,2,76,76]};controlData={settings:{top:60,right:230,key:"settings",alpha:.5,width:76,height:76}};constructor(){super(...arguments),this.init()}},Ue=class extends D{sprite=null;spriteSheet={bronze_medal:[548,68,44,44],center_panel:[2,68,452,56],silver_medal:[502,68,44,44],left_panel:[2,2,588,64],gold_medal:[456,68,44,44]};bronze_container=new z({alpha:.4,font:{size:12},inline:!0,x:6.4},this.container);silver_container=new z({alpha:.4,font:{size:12},inline:!0,x:6.4},this.container);gold_container=new z({alpha:.4,font:{size:12},inline:!0,x:6.4},this.container);constructor(e){super(e,{font:{size:12},inline:!0,y:32}),this.settings=e.settings;let t=e.settings.campaignData.goals;this.sprite=e.assets.getResult("campaign_icons"),this.bronze_container.addChild(new A({cached:!0,image:{canvas:this.sprite,x:548,y:68,width:44,height:44},width:18,height:18})),this.bronze_container.addChild(new A({text:t.third,x:4,y:3})),this.silver_container.addChild(new A({cached:!0,image:{canvas:this.sprite,x:502,y:68,width:44,height:44},width:18,height:18})),this.silver_container.addChild(new A({text:t.second,x:4,y:3})),this.gold_container.addChild(new A({cached:!0,image:{canvas:this.sprite,x:456,y:68,width:44,height:44},width:18,height:18})),this.gold_container.addChild(new A({text:t.first,x:4,y:3})),this.updateState()}updateState(){switch(this.settings.campaignData.user.has_goal){case 1:case"first":this.gold_container.alpha=1;case 2:case"second":this.silver_container.alpha=1;case 3:case"third":this.bronze_container.alpha=1}this.redraw()}centerContainer(){let e=this.scene.screen,t=this.container,s=t.width;t.x=e.width/2/window.devicePixelRatio-s/2,t.y=40}update(){this.updateState()}},Ve=class extends D{raceCount=0;raceList=null;highlightedRace=null;raceOpacity=.3;raceYOffset=20;mobileRaceXOffset=72;maxRaces=10;constructor(e){super(e,{font:{size:10},x:6,y:32}),this.scene.game.settings.isCampaign&&(this.container.y+=24),this.maxRaces=this.scene.settings.mobile?3:10,this.raceList=this.container.children}addRace(e,t){if(this.raceCount<this.maxRaces){let s=this.scene,i=e.user,a=e.race,r=s.settings,o=r.drawFPS,n=new z({alpha:this.raceOpacity,color:"#".padEnd(7,/^midnight$/i.test(window.lite?.storage.get("theme"))?"d":/^dark(er)?$/i.test(window.lite?.storage.get("theme"))?"f":"0"),data:e,inline:!0,textAlign:"center",textBaseline:"middle"},this.container);r.mobile?n.x=t*this.mobileRaceXOffset:n.y=t*this.raceYOffset,n.addChild(new A({background:i.color,border:"round",font:{size:10},radius:8,text:i.d_name.charAt(0).toUpperCase(),textAlign:"center"})),n.addChild(new A({font:{size:12},text:L(parseInt(a.run_ticks)/o*1e3),x:4,y:2})),n.addChild(new A({font:{size:12},text:"0/"+s.track.targetCount,x:4,y:2})),this.raceCount++,this.redraw()}}centerContainer(){let e=this.scene,t=e.screen,s=this.container,i=s.width;s.x=t.width/2/window.devicePixelRatio-i/2,e.settings.isCampaign&&(s.visible=!1),s.y=40}clear(){this.container.children.splice(0),this.raceCount=0,this.redraw()}highlightRace(e){if(this.highlightedRace!==this.raceList[e]){this.unhighlightRace();let t=this.raceList[e];t.alpha=1,this.highlightedRace=t,this.redraw()}}unhighlightRace(){this.highlightedRace&&(this.highlightedRace.alpha=this.raceOpacity,this.highlightedRace=null,this.redraw())}update(){if(this.raceCount>0){let e=this.scene.camera;e.focusIndex>0&&e.focusIndex<this.maxRaces?this.highlightRace(e.focusIndex-1):this.unhighlightRace()}}},qe=class extends ue{races=[];playing=!1;ready=!1;loading=!1;fullscreenControls=null;settingsControls=null;constructor(e){super(e),this.raceTimes=new Ve(this),this.settings.isCampaign&&(this.campaignScore=new Ue(this)),this.setStartingVehicle(),this.state=this.setStateDefaults(),this.oldState=this.setStateDefaults(),this.createMainPlayer(),this.createControls(),this.registerTools(),this.setStartingVehicle(),this.restart(),this.initializeAnalytics()}getCanvasOffset(){return{height:0,width:0}}initializeAnalytics(){this.analytics={deaths:0}}createMainPlayer(){let e=super.createMainPlayer();e.setKeyMap(this.settings.playHotkeys),e.recordKeys(this.settings.keysToRecord)}createControls(){this.pauseControls=new ge(this),this.settings.fullscreenAvailable&&(this.fullscreenControls=new He(this)),this.settingsControls=new We(this)}createTrack(){let e=super.createTrack(),t=this.getAvailableTrackCode();0!=t&&(e.read(t),this.setTrackAllowedVehicles(),this.state.preloading=!1,this.loading=!1,this.restartTrack=!0,this.ready=!0)}play(){this.state.playing||(this.state.playing=!0,this.hideControlPlanel())}buttonDown(e){this.state.showDialog||super.buttonDown(e)}exitFullscreen(){this.settings.fullscreenAvailable&&(this.settings.fullscreen=!1,this.state.fullscreen=!1,this.trackEvent("game-ui","game-fullscreen-toggle","game-out-fullscreen"))}toggleFullscreen(){super.toggleFullscreen()&&this.trackEvent("game-ui","game-fullscreen-toggle",this.settings.fullscreen?"game-into-fullscreen":"game-out-fullscreen")}trackEvent(e,t,s){Application.Helpers.GoogleAnalyticsHelper.track_event({category:e,action:t,label:s,value:0,non_interaction:!0})}setTrackAllowedVehicles(){let e=this.track,t=this.settings.track;t&&(e.allowedVehicles=t.vehicles)}interactWithControls(){super.interactWithControls(),this.settings.fullscreenAvailable&&this.fullscreenControls.click(),this.settingsControls.click()}updateControls(){super.updateControls(),this.settings.fullscreenAvailable&&this.fullscreenControls.update(),this.settingsControls.update()}redrawControls(){super.redrawControls(),this.settings.fullscreenAvailable&&this.fullscreenControls.redraw(),this.settingsControls.redraw()}registerTools(){super.registerTools().setTool("Camera")}fixedUpdate(){let e,t;this.ready?(this.updateToolHandler(),this.mouse.update(),this.state.paused||this.state.showDialog||(this.playerManager.updateGamepads(),this.playerManager.checkKeys()),this.camera.focusIndex>0&&(e=this.playerManager.firstPlayer._gamepad.downButtons,e=~~e.right-~~e.left)&&(t=this.playerManager.getPlayerByIndex(this.camera.focusIndex))&&t.isGhost()&&t._gamepad.playbackTicks>0&&(t._replayIterator.next((t._gamepad.playbackTicks??this.ticks)+5*e),this.state.playing=!1),super.fixedUpdate(),this.updateScore()):this.importCode&&this.createTrack()}draw(e){super.draw(...arguments),this.settings.fullscreenAvailable&&this.fullscreenControls.draw(e),this.settingsControls.draw(e),this.campaignScore&&this.campaignScore.draw(e),this.raceTimes.draw(e)}isStateDirty(){let e=this.state;return e.fullscreen!=GameSettings.fullscreen&&(e.fullscreen=GameSettings.fullscreen),super.isStateDirty()}updateScore(){this.campaignScore&&this.campaignScore.update(),this.raceTimes.update()}restart(){this.message.show("Press Any Key To Start",1,"#333333","#FFFFFF"),this.track.resetPowerups(),this.restartTrack=!1,this.state.paused=!1,this.state.playing=!this.settings.waitForKeyPress,this.ticks=0,this.playerManager.reset(),this.playerManager.getPlayerCount()>0&&(this.camera.focusIndex=1),this.camera.focusOnPlayer(),this.camera.fastforward(),this.showControlPlanel("main")}setStartingVehicle(){let e=this.settings,t=e.startVehicle;e.track&&(t=e.track.vehicle),this.vehicle=t}updatePlayers(){this.playerManager.update()}hideControlPlanel(){this.state.showSkip&&(this.state.showSkip=!1),!1!==this.state.showControls&&(this.state.showControls=!1)}showControlPlanel(e){this.settings.isCampaign&&this.settings.campaignData.can_skip&&this.analytics&&this.analytics.deaths>5&&(this.state.showSkip=!0),this.stateshowControls!==e&&this.settings.showHelpControls&&(this.state.showControls=e)}resize(){this.pauseControls.resize(),this.settings.fullscreenAvailable&&this.fullscreenControls.resize(),this.settingsControls.resize(),super.resize()}setStateDefaults(){let e=super.setStateDefaults();return e.paused=!1,e.playerAlive=!0,e.showControls=!1,e.showSkip=!1,e}command(e,...t){switch(super.command(...arguments),e){case"clear race":this.races.splice(0),this.restartTrack=!0,this.raceTimes.clear();break;case"add race":let e=t[0],s=t[1];this.addRaces(e),s&&(this.state.dialogOptions={races:this.races},this.command("dialog","race_dialog"));break;case"change vehicle":let i=t[0];this.selectVehicle(i);break;case"restart":this.command("dialog",!1),this.restartTrack=!0;break;case"resume":this.state.paused=!1;break;case"fullscreen":this.toggleFullscreen();break;case"exit_fullscreen":this.exitFullscreen()}}addRaces(e){this.mergeRaces(e),this.sortRaces(),this.formatRaces(),this.game.emit("trackChallengeUpdate",this.races),this.addRaceTimes(),this.addPlayers(),this.restartTrack=!0}addRaceTimes(){let e=this.settings.raceColors,t=e.length,s=this.races,i=this.raceTimes;i.clear();for(let a in s){let r=s[a];r.user.color=e[a%t],i.addRace(r,a)}}addPlayers(){let e=this.playerManager;e.clear();let t=this.settings.keysToRecord;for(let{user:s,race:i}of this.races){let a=i.code;"string"==typeof a&&(a=JSON.parse(a));let r=e.createPlayer(this,s);r.setBaseVehicle(i.vehicle),r.setAsGhost(),r.getGamepad().loadPlayback(a,t),e.addPlayer(r)}}clearRaces(){this.races.splice(0),this.game.emit("trackChallengeUpdate",this.races),this.raceTimes.clear(),this.playerManager.clear()}formatRaces(e){e||=this.races;for(let{race:t}of e.filter((e=>"string"==typeof e.race.code))){let e=JSON.parse(t.code);for(let t in e)e[t]instanceof Array&&(e[t]=e[t].reduce(((e,t)=>(e[t]=1+~~e[t],e)),{}));t.code=e}return e}removeDuplicateRaces(){this.races=this.races.filter(((e,t,s)=>t===s.findIndex((t=>this.uniqesByUserIdIterator(t)==this.uniqesByUserIdIterator(e)))))}removeRaces(e){let t=this.races;for(let s of e)s=t.findIndex((({user:e})=>e.u_id==s)),s>-1&&(s=t.splice(s,1),this.playerManager.removePlayer(e),this.game.emit("trackRaceDelete",s[0]),this.game.emit("trackRacesDelete",s));this.game.emit("trackChallengeUpdate",this.races),this.addRaceTimes(),this.camera.focusOnMainPlayer()}uniqesByUserIdIterator(e){return e.user.u_id}sortRaces(){this.races.length>1?this.races.sort(((e,t)=>this.sortByRunTicksIterator(e)-this.sortByRunTicksIterator(t))):this.sortByRunTicksIterator(this.races[0]),this.game.emit("trackRacesSort",this.races)}mergeRaces(e){let t=this.races;e&&e.forEach((e=>{let s=t.find((({user:t})=>t.u_id===e.user.u_id));s?Object.assign(s,e):(t.push(e),this.game.emit("trackRaceCreate",e))}))}redraw(){super.redraw(),this.raceTimes.redraw()}sortByRunTicksIterator(e){let t=parseInt(e.race.run_ticks);return e.runTime||=L(t/this.settings.drawFPS*1e3),t}verifyComplete(){let e=this.playerManager.firstPlayer._powerupsConsumed.targets;return-1===this.track.targets.findIndex((t=>-1===e.indexOf(t.id)))}async trackComplete(){if(this.verifyComplete()){this.sound.play("victory_sound");let e=this.playerManager;e.mutePlayers();let t=e.firstPlayer,s=t.getGamepad(),i=s.getReplayString(),a=this.settings,r=this.ticks,o=L(r/a.drawFPS*1e3),n={t_id:$("#track-data").data("t_id"),u_id:a.user.u_id,code:i,vehicle:t._baseVehicleType,run_ticks:r,fps:25,time:o};n.sig=await async function(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")}(n.t_id+"|"+n.u_id+"|"+n.code+"|"+n.run_ticks+"|"+n.vehicle+"|"+n.fps+"|erxrHHcksIHHksktt8933XhwlstTekz");let h=this.races;h.length>0&&(n.races=h.map((({user:e})=>e.u_id))),a.isCampaign&&(n.is_campaign=!0),this.state.dialogOptions={postData:n,analytics:this.analytics},navigator.onLine||(localStorage.setItem("offline_races",Object.assign(Object.assign({},JSON.parse(localStorage.getItem("offline_races"))),{[this.settings.track.id]:this.state.dialogOptions})),alert("Your connection is offline! Free Rider Lite saved your ghost, and it will be published when your connection is back online!")),this.command("dialog",(a.isCampaign?"campaign":"track")+"_complete"),s.reset(!0),this.listen()}}close(){this.fullscreenControls=null,this.settingsControls=null,this.raceTimes=null,this.score=null,this.campaignScore=null,super.close()}};window.Game=class extends e{gameContainer=null;_frames=0;frames=0;lastTime=-1;timer=performance.now();_updates=0;updates=0;ups=30;tickCount=0;currentScene=null;assets=null;canvas=null;stats=null;width=0;height=0;fullscreen=!1;onStateChange=null;constructor(e,t,s){super(),this.assets=t,this.settings=s,this.initCanvas(),this.setSize(),this.switchScene(e),this.setSize(),(window.createjs||={}).Ticker||=this,this.updateCallback=requestAnimationFrame(this.update.bind(this)),this.emit("ready",this)}initCanvas(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.gameContainer=document.getElementById(this.settings.defaultContainerID),null!==this.gameContainer&&this.gameContainer.appendChild(this.canvas)}setSize(){let e=window.innerHeight,t=window.innerWidth;this.settings.fullscreen||this.settings.isStandalone||(e=this.gameContainer.clientHeight,t=this.gameContainer.clientWidth),this.currentScene&&(e-=this.currentScene.getCanvasOffset().height);let s=1;window.devicePixelRatio&&(s=window.devicePixelRatio),this.settings.lowQualityMode&&(s=1);let i=t*s,a=e*s;(i!==this.width||a!==this.height)&&(this.width=i,this.height=a,this.canvas.width=i,this.canvas.height=a),this.pixelRatio=s,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ctx.imageSmoothingEnabled=!1,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.strokeStyle=this.settings.physicsLineColor,this.currentScene&&this.currentScene.command("resize")}progress=0;update(e){this.updateCallback=requestAnimationFrame(this.update.bind(this));let t=e-this.lastTime,s=1e3/this.ups;for(t>1e3&&(t=s),this.progress+=t/s,this.lastTime=e;this.progress>=1;)this.currentScene.fixedUpdate(),this.emit("tick",++this._updates),this.progress--;this.currentScene.draw(this.ctx),this.emit("draw",this.ctx),this._frames++,e-this.timer>1e3&&(this.timer=e,this.updates=this._updates,this._updates=0,this.frames=this._frames,this._frames=0)}switchScene(e){null!==this.currentScene&&this.currentScene.close(),this.currentScene=new{Editor:je,Main:qe}[e](this)}command(){this.currentScene.command.apply(this.currentScene,arguments)}close(){cancelAnimationFrame(this.updateCallback),this.currentScene.close(),this.currentScene=null,this.assets=null,this.settings=null,this.canvas.remove(),this.canvas=null,this.ctx=null,this.tickCount=null,this.height=null,this.width=null}}})();